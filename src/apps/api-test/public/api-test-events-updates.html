<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - События и Updates - Chat3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .back-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .back-link:hover {
            background-color: #f0f0f0;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 1px;
            background: #ddd;
            overflow: hidden;
        }

        .events-panel {
            width: 50%;
            min-width: 400px;
        }

        .updates-panel {
            width: 50%;
            min-width: 400px;
        }

        .panel {
            background: white;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 59px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #e9ecef;
        }

        .btn-url {
            color: #667eea;
            border-color: #667eea;
        }

        .btn-url:hover {
            background: #667eea;
            color: white;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .filter-form {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-examples {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .filter-example {
            padding: 4px 8px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-example:hover {
            background: #dee2e6;
        }

        .filter-input-group {
            flex: 1;
            display: flex;
            gap: 5px;
            align-items: center;
            position: relative;
        }

        .filter-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-clear {
            position: absolute;
            right: 30px;
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-clear:hover {
            color: #495057;
        }

        .filter-apply {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .filter-apply:hover {
            background: #5568d3;
        }

        .filter-apply.active {
            background: #28a745;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            gap: 8px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-size: 11px;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 11px;
            white-space: nowrap;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination button {
            padding: 4px 8px;
            border: 1px solid #ced4da;
            background: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
            min-width: 28px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
        }

        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination input[type="number"] {
            width: 50px;
            padding: 3px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
            text-align: center;
        }

        .pagination select {
            padding: 3px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:hover {
            background: #e9ecef;
        }

        .sort-indicator {
            margin-left: 5px;
            color: #6c757d;
            font-size: 10px;
        }

        .sort-indicator.active {
            color: #667eea;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .event-row {
            cursor: pointer;
        }

        .event-row:hover {
            background: #e3f2fd;
        }

        .event-row-selected {
            background-color: #e9ecef !important;
        }

        .event-row-selected:hover {
            background-color: #dee2e6 !important;
        }

        .actions-column {
            padding: 0;
            font-size: 0;
        }

        .action-button {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            height: 25px;
            margin-right: 2px;
        }

        .action-button:last-child {
            margin-right: 0;
        }

        .action-button:hover {
            background: #e9ecef;
        }

        .action-button.updates-button {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }

        .action-button.updates-button:hover {
            background: #f57c00;
        }

        .loading, .error, .no-data {
            padding: 40px 20px;
            text-align: center;
            color: #6c757d;
        }

        .error {
            color: #dc3545;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #495057;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-url {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .json-viewer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
        }

        .btn-copy {
            margin-top: 10px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-copy:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Колонка События -->
        <div class="events-panel">
            <div class="panel">
                <div class="panel-header">
                    <div class="header-left">
                        <span>События</span>
                    </div>
                    <div class="header-right">
                        <button class="btn btn-url" onclick="showUrlModal('events')">URL</button>
                    </div>
                </div>
                <div class="filter-form">
                    <div class="filter-examples">
                        <span class="filter-example" onclick="setFilterExample('events', 'eventType', 'message.create')">message.create</span>
                        <span class="filter-example" onclick="setFilterExample('events', 'eventType', 'dialog.create')">dialog.create</span>
                    </div>
                    <div class="filter-row">
                        <div class="filter-input-group">
                            <input type="text" id="events-filter" class="filter-input" placeholder="Фильтр (например: eventType=message.create)">
                            <button class="filter-clear" onclick="clearFilter('events')" title="Очистить">×</button>
                        </div>
                        <button class="filter-apply" onclick="applyFilter('events')">Применить</button>
                    </div>
                </div>
                <div class="pagination" id="events-pagination">
                    <div class="pagination-info" id="events-pagination-info">Загрузка...</div>
                    <div class="pagination-controls">
                        <button onclick="goToPage('events', 1)" title="Первая">««</button>
                        <button onclick="goToPage('events', currentEventsPage - 1)" title="Предыдущая">‹</button>
                        <input type="number" id="events-page-input" min="1" value="1" onchange="goToPage('events', parseInt(this.value))">
                        <span>из</span>
                        <span id="events-total-pages">1</span>
                        <button onclick="goToPage('events', currentEventsPage + 1)" title="Следующая">›</button>
                        <button onclick="goToPage('events', eventsTotalPages)" title="Последняя">»»</button>
                        <select id="events-limit" onchange="changeLimit('events')">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <div class="panel-content" id="events-content">
                    <div class="loading">Загрузка событий...</div>
                </div>
            </div>
        </div>

        <!-- Колонка Updates -->
        <div class="updates-panel">
            <div class="panel">
                <div class="panel-header">
                    <div class="header-left">
                        <span>Updates</span>
                    </div>
                    <div class="header-right">
                        <button class="btn btn-url" onclick="showUrlModal('updates')">URL</button>
                    </div>
                </div>
                <div class="filter-form">
                    <div class="filter-examples">
                        <span class="filter-example" onclick="setFilterExample('updates', 'eventType', 'message.create')">eventType: message.create</span>
                        <span class="filter-example" onclick="setFilterExample('updates', 'userId', '')">userId: </span>
                        <span class="filter-example" onclick="setFilterExample('updates', 'dialogId', '')">dialogId: </span>
                    </div>
                    <div class="filter-row">
                        <div class="filter-input-group">
                            <input type="text" id="updates-filter" class="filter-input" placeholder="Фильтр (например: eventType=message.create)">
                            <button class="filter-clear" onclick="clearFilter('updates')" title="Очистить">×</button>
                        </div>
                        <button class="filter-apply" onclick="applyFilter('updates')">Применить</button>
                    </div>
                </div>
                <div class="pagination" id="updates-pagination">
                    <div class="pagination-info" id="updates-pagination-info">Загрузка...</div>
                    <div class="pagination-controls">
                        <button onclick="goToPage('updates', 1)" title="Первая">««</button>
                        <button onclick="goToPage('updates', currentUpdatesPage - 1)" title="Предыдущая">‹</button>
                        <input type="number" id="updates-page-input" min="1" value="1" onchange="goToPage('updates', parseInt(this.value))">
                        <span>из</span>
                        <span id="updates-total-pages">1</span>
                        <button onclick="goToPage('updates', currentUpdatesPage + 1)" title="Следующая">›</button>
                        <button onclick="goToPage('updates', updatesTotalPages)" title="Последняя">»»</button>
                        <select id="updates-limit" onchange="changeLimit('updates')">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <div class="panel-content" id="updates-content">
                    <div class="loading">Загрузка обновлений...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для URL -->
    <div id="urlModal" class="modal" onclick="if(event.target === this) closeUrlModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">URL запроса</div>
                <button class="modal-close" onclick="closeUrlModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-url" id="urlModal-url"></div>
                <button class="btn-copy" onclick="copyUrl()">Скопировать URL</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для JSON -->
    <div id="jsonModal" class="modal" onclick="if(event.target === this) closeJsonModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">JSON данные</div>
                <button class="modal-close" onclick="closeJsonModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-url" id="jsonModal-url"></div>
                <div class="json-viewer" id="jsonModal-content"></div>
                <button class="btn-copy" onclick="copyJson()">Скопировать JSON</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let currentEventsPage = 1;
        let eventsTotalPages = 1;
        let currentEventsLimit = 50;
        let currentEventsFilter = '';
        let selectedEventId = null;

        let currentUpdatesPage = 1;
        let updatesTotalPages = 1;
        let currentUpdatesLimit = 50;
        let currentUpdatesFilter = '';

        // Получить URL для control-api
        function getControlApiUrl(path = '') {
            const currentProtocol = window.location.protocol;
            const currentHost = window.location.host;
            
            if (typeof CHAT3_CONFIG !== 'undefined' && CHAT3_CONFIG && CHAT3_CONFIG.getControlApiUrl) {
                let url = CHAT3_CONFIG.getControlApiUrl(path);
                if (currentProtocol === 'https:' && url.startsWith('http://')) {
                    url = url.replace('http://', 'https://');
                }
                return url;
            }
            const controlApiUrl = currentHost.includes(':3001') || !currentHost.includes(':') 
                ? `${currentProtocol}//${currentHost}` 
                : `${currentProtocol}//${currentHost.split(':')[0]}:3002`;
            return `${controlApiUrl}${path}`;
        }

        // Получить tenantId из URL
        function getTenantId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('tenantId') || 'tnt_default';
        }

        // Загрузить события
        async function loadEvents() {
            const content = document.getElementById('events-content');
            content.innerHTML = '<div class="loading">Загрузка событий...</div>';

            try {
                const params = new URLSearchParams({
                    tenantId: getTenantId(),
                    page: currentEventsPage,
                    limit: currentEventsLimit
                });

                // Добавить фильтры
                if (currentEventsFilter) {
                    const filterParts = currentEventsFilter.split('=');
                    if (filterParts.length === 2) {
                        params.append(filterParts[0].trim(), filterParts[1].trim());
                    }
                }

                const url = getControlApiUrl(`/api/events?${params.toString()}`);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();
                const events = result.data || [];
                const pagination = result.pagination || {};

                currentEventsPage = pagination.page || 1;
                eventsTotalPages = pagination.pages || 1;

                updateEventsPagination();
                renderEvents(events);
            } catch (error) {
                content.innerHTML = `<div class="error">Ошибка загрузки событий: ${error.message}</div>`;
            }
        }

        // Отобразить события
        function renderEvents(events) {
            const content = document.getElementById('events-content');
            
            if (events.length === 0) {
                content.innerHTML = '<div class="no-data">События не найдены</div>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th onclick="sortEvents(\'eventId\')">eventId <span class="sort-indicator">↕</span></th>';
            html += '<th onclick="sortEvents(\'eventType\')">eventType <span class="sort-indicator">↕</span></th>';
            html += '<th onclick="sortEvents(\'actorId\')">actorId <span class="sort-indicator">↕</span></th>';
            html += '<th onclick="sortEvents(\'createdAt\')">createdAt <span class="sort-indicator">↕</span></th>';
            html += '<th class="actions-column">Действия</th>';
            html += '</tr></thead><tbody>';

            events.forEach(event => {
                const eventIdStr = String(event._id);
                const isSelected = selectedEventId === eventIdStr;
                const rowClass = isSelected ? 'event-row event-row-selected' : 'event-row';
                html += `<tr class="${rowClass}" data-event-id="${eventIdStr}" onclick="selectEvent('${eventIdStr}')">`;
                html += `<td>${event.eventId || '-'}</td>`;
                html += `<td>${event.eventType || '-'}</td>`;
                html += `<td>${event.actorId || '-'}</td>`;
                html += `<td>${formatTimestamp(event.createdAt)}</td>`;
                html += '<td class="actions-column">';
                html += `<button class="action-button updates-button" onclick="event.stopPropagation(); showEventUpdates('${eventIdStr}')">Updates</button>`;
                html += `<button class="action-button" onclick="event.stopPropagation(); showEventJson('${eventIdStr}', ${JSON.stringify(event).replace(/"/g, '&quot;')})">Инфо</button>`;
                html += '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            content.innerHTML = html;
        }

        // Загрузить обновления
        async function loadUpdates() {
            const content = document.getElementById('updates-content');
            content.innerHTML = '<div class="loading">Загрузка обновлений...</div>';

            try {
                const params = new URLSearchParams({
                    tenantId: getTenantId(),
                    page: currentUpdatesPage,
                    limit: currentUpdatesLimit
                });

                // Если выбрано событие, фильтруем по eventId
                if (selectedEventId) {
                    params.append('eventId', selectedEventId);
                }

                // Добавить фильтры
                if (currentUpdatesFilter) {
                    const filterParts = currentUpdatesFilter.split('=');
                    if (filterParts.length === 2) {
                        params.append(filterParts[0].trim(), filterParts[1].trim());
                    }
                }

                const url = getControlApiUrl(`/api/updates?${params.toString()}`);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();
                const updates = result.data || [];
                const pagination = result.pagination || {};

                currentUpdatesPage = pagination.page || 1;
                updatesTotalPages = pagination.pages || 1;

                updateUpdatesPagination();
                renderUpdates(updates);
            } catch (error) {
                content.innerHTML = `<div class="error">Ошибка загрузки обновлений: ${error.message}</div>`;
            }
        }

        // Отобразить обновления
        function renderUpdates(updates) {
            const content = document.getElementById('updates-content');
            
            if (updates.length === 0) {
                content.innerHTML = '<div class="no-data">Обновления не найдены</div>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th onclick="sortUpdates(\'userId\')">userId <span class="sort-indicator">↕</span></th>';
            html += '<th onclick="sortUpdates(\'dialogId\')">dialogId <span class="sort-indicator">↕</span></th>';
            html += '<th onclick="sortUpdates(\'eventType\')">eventType <span class="sort-indicator">↕</span></th>';
            html += '<th onclick="sortUpdates(\'createdAt\')">createdAt <span class="sort-indicator">↕</span></th>';
            html += '<th onclick="sortUpdates(\'published\')">published <span class="sort-indicator">↕</span></th>';
            html += '<th class="actions-column">Действия</th>';
            html += '</tr></thead><tbody>';

            updates.forEach(update => {
                html += '<tr>';
                html += `<td>${update.userId || '-'}</td>`;
                html += `<td>${update.dialogId || '-'}</td>`;
                html += `<td>${update.eventType || '-'}</td>`;
                html += `<td>${formatTimestamp(update.createdAt)}</td>`;
                html += `<td>${update.published ? 'Да' : 'Нет'}</td>`;
                html += '<td class="actions-column">';
                html += `<button class="action-button" onclick="showUpdateJson('${update._id || ''}', ${JSON.stringify(update).replace(/"/g, '&quot;')})">Инфо</button>`;
                html += '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            content.innerHTML = html;
        }

        // Выбрать событие и загрузить связанные обновления
        function selectEvent(eventId) {
            selectedEventId = eventId;
            currentUpdatesPage = 1;
            loadUpdates();
            
            // Обновить выделение в таблице событий
            const rows = document.querySelectorAll('.event-row');
            rows.forEach(row => {
                row.classList.remove('event-row-selected');
                if (row.getAttribute('data-event-id') === eventId) {
                    row.classList.add('event-row-selected');
                }
            });
        }

        // Показать обновления для события
        function showEventUpdates(eventId) {
            selectEvent(eventId);
        }

        // Обновить пагинацию событий
        function updateEventsPagination() {
            const info = document.getElementById('events-pagination-info');
            const total = eventsTotalPages * currentEventsLimit;
            const start = (currentEventsPage - 1) * currentEventsLimit + 1;
            const end = Math.min(currentEventsPage * currentEventsLimit, total);
            info.textContent = `${start}-${end} из ${total}`;
            
            document.getElementById('events-page-input').value = currentEventsPage;
            document.getElementById('events-total-pages').textContent = eventsTotalPages;
        }

        // Обновить пагинацию обновлений
        function updateUpdatesPagination() {
            const info = document.getElementById('updates-pagination-info');
            const total = updatesTotalPages * currentUpdatesLimit;
            const start = (currentUpdatesPage - 1) * currentUpdatesLimit + 1;
            const end = Math.min(currentUpdatesPage * currentUpdatesLimit, total);
            info.textContent = `${start}-${end} из ${total}`;
            
            document.getElementById('updates-page-input').value = currentUpdatesPage;
            document.getElementById('updates-total-pages').textContent = updatesTotalPages;
        }

        // Перейти на страницу
        function goToPage(type, page) {
            if (type === 'events') {
                if (page < 1 || page > eventsTotalPages) return;
                currentEventsPage = page;
                loadEvents();
            } else {
                if (page < 1 || page > updatesTotalPages) return;
                currentUpdatesPage = page;
                loadUpdates();
            }
        }

        // Изменить лимит
        function changeLimit(type) {
            if (type === 'events') {
                currentEventsLimit = parseInt(document.getElementById('events-limit').value);
                currentEventsPage = 1;
                loadEvents();
            } else {
                currentUpdatesLimit = parseInt(document.getElementById('updates-limit').value);
                currentUpdatesPage = 1;
                loadUpdates();
            }
        }

        // Установить пример фильтра
        function setFilterExample(type, field, value) {
            const filterInput = document.getElementById(`${type}-filter`);
            filterInput.value = `${field}=${value}`;
        }

        // Очистить фильтр
        function clearFilter(type) {
            document.getElementById(`${type}-filter`).value = '';
            if (type === 'events') {
                currentEventsFilter = '';
            } else {
                currentUpdatesFilter = '';
            }
        }

        // Применить фильтр
        function applyFilter(type) {
            const filterInput = document.getElementById(`${type}-filter`);
            const filter = filterInput.value.trim();
            
            if (type === 'events') {
                currentEventsFilter = filter;
                currentEventsPage = 1;
                loadEvents();
            } else {
                currentUpdatesFilter = filter;
                currentUpdatesPage = 1;
                loadUpdates();
            }
            
            // Обновить кнопку
            const applyBtn = filterInput.closest('.filter-row').querySelector('.filter-apply');
            applyBtn.classList.add('active');
            setTimeout(() => applyBtn.classList.remove('active'), 1000);
        }

        // Сортировка (заглушка)
        function sortEvents(field) {
            // TODO: реализовать сортировку
        }

        function sortUpdates(field) {
            // TODO: реализовать сортировку
        }

        // Показать JSON события
        function showEventJson(eventId, eventJson) {
            const modal = document.getElementById('jsonModal');
            const params = new URLSearchParams({
                tenantId: getTenantId(),
                page: currentEventsPage,
                limit: currentEventsLimit
            });
            document.getElementById('jsonModal-url').textContent = getControlApiUrl(`/api/events?${params.toString()}`);
            try {
                const event = typeof eventJson === 'string' ? JSON.parse(eventJson.replace(/&quot;/g, '"')) : eventJson;
                document.getElementById('jsonModal-content').textContent = JSON.stringify(event, null, 2);
            } catch (e) {
                document.getElementById('jsonModal-content').textContent = eventJson;
            }
            modal.style.display = 'block';
        }

        // Показать JSON обновления
        function showUpdateJson(updateId, updateJson) {
            const modal = document.getElementById('jsonModal');
            const params = new URLSearchParams({
                tenantId: getTenantId(),
                page: currentUpdatesPage,
                limit: currentUpdatesLimit
            });
            if (selectedEventId) {
                params.append('eventId', selectedEventId);
            }
            document.getElementById('jsonModal-url').textContent = getControlApiUrl(`/api/updates?${params.toString()}`);
            try {
                const update = typeof updateJson === 'string' ? JSON.parse(updateJson.replace(/&quot;/g, '"')) : updateJson;
                document.getElementById('jsonModal-content').textContent = JSON.stringify(update, null, 2);
            } catch (e) {
                document.getElementById('jsonModal-content').textContent = updateJson;
            }
            modal.style.display = 'block';
        }

        // Закрыть модальное окно JSON
        function closeJsonModal() {
            document.getElementById('jsonModal').style.display = 'none';
        }

        // Показать модальное окно URL
        function showUrlModal(type) {
            const modal = document.getElementById('urlModal');
            let url = '';
            
            if (type === 'events') {
                const params = new URLSearchParams({
                    tenantId: getTenantId(),
                    page: currentEventsPage,
                    limit: currentEventsLimit
                });
                if (currentEventsFilter) {
                    const filterParts = currentEventsFilter.split('=');
                    if (filterParts.length === 2) {
                        params.append(filterParts[0].trim(), filterParts[1].trim());
                    }
                }
                url = getControlApiUrl(`/api/events?${params.toString()}`);
            } else {
                const params = new URLSearchParams({
                    tenantId: getTenantId(),
                    page: currentUpdatesPage,
                    limit: currentUpdatesLimit
                });
                if (selectedEventId) {
                    params.append('eventId', selectedEventId);
                }
                if (currentUpdatesFilter) {
                    const filterParts = currentUpdatesFilter.split('=');
                    if (filterParts.length === 2) {
                        params.append(filterParts[0].trim(), filterParts[1].trim());
                    }
                }
                url = getControlApiUrl(`/api/updates?${params.toString()}`);
            }
            
            document.getElementById('urlModal-url').textContent = url;
            modal.style.display = 'block';
        }

        // Закрыть модальное окно URL
        function closeUrlModal() {
            document.getElementById('urlModal').style.display = 'none';
        }

        // Копировать URL
        function copyUrl() {
            const url = document.getElementById('urlModal-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('URL скопирован в буфер обмена');
            });
        }

        // Копировать JSON
        function copyJson() {
            const json = document.getElementById('jsonModal-content').textContent;
            navigator.clipboard.writeText(json).then(() => {
                alert('JSON скопирован в буфер обмена');
            });
        }

        // Форматировать timestamp
        function formatTimestamp(ts) {
            if (!ts) return '-';
            const date = new Date(ts / 1000);
            return date.toLocaleString('ru-RU');
        }

        // Закрытие модальных окон по Esc
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeUrlModal();
                closeJsonModal();
            }
        });

        // Инициализация
        window.onload = function() {
            loadEvents();
            loadUpdates();
        };
    </script>
</body>
</html>

