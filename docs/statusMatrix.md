# statusMessageMatrix - –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è

## –û–±–∑–æ—Ä

`statusMessageMatrix` ‚Äî —ç—Ç–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–æ —á–µ—Ä–µ–∑ –∫–∞–∂–¥—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ú–∞—Ç—Ä–∏—Ü–∞ –∏—Å–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ `userType` –∏ `status`.

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

`statusMessageMatrix` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–∏—Å–∫–ª—é—á–∞—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
- –ê–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–æ—à–ª–∏ —á–µ—Ä–µ–∑ –∫–∞–∂–¥—ã–π —Å—Ç–∞—Ç—É—Å
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∞—Ç—Ä–∏—Ü—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ UI (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ)
- –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è –º–∞—Ç—Ä–∏—Ü—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

`statusMessageMatrix` ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```javascript
[
  {
    userType: "user",      // –¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user, bot, contact –∏ —Ç.–¥.) –∏–ª–∏ null
    status: "read",        // –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è (unread, delivered, read)
    count: 3              // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å —ç—Ç–∏–º —Å—Ç–∞—Ç—É—Å–æ–º
  },
  {
    userType: "user",
    status: "delivered",
    count: 2
  },
  {
    userType: "bot",
    status: "read",
    count: 1
  }
]
```

### –ü–æ–ª—è

- **`userType`** (string | null) ‚Äî —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
  - `"user"` ‚Äî –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  - `"bot"` ‚Äî –±–æ—Ç
  - `"contact"` ‚Äî –∫–æ–Ω—Ç–∞–∫—Ç
  - `null` ‚Äî —Ç–∏–ø –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
- **`status`** (string) ‚Äî —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è:
  - `"unread"` ‚Äî –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–æ
  - `"delivered"` ‚Äî –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
  - `"read"` ‚Äî –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
- **`count`** (number) ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å –¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è

–§—É–Ω–∫—Ü–∏—è `buildStatusMessageMatrix` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MongoDB aggregation pipeline:

1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** (`$match`):
   - –í—ã–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ `MessageStatus` –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ò—Å–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è (`userId: { $ne: senderId }`)

2. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞** (`$group`):
   - –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –ø–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ `userType` –∏ `status`
   - –°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ (`count: { $sum: 1 }`)

3. **–ü—Ä–æ–µ–∫—Ü–∏—è** (`$project`):
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ–±—ä–µ–∫—Ç–∞
   - –£–±–∏—Ä–∞–µ—Ç —Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ `_id`

4. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** (`$sort`):
   - –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ `userType` (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
   - –ó–∞—Ç–µ–º –ø–æ `status` (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)

### –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

#### –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

**–í–ê–ñ–ù–û**: `statusMessageMatrix` —Å—á–∏—Ç–∞–µ—Ç **–≤—Å–µ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏**, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—É—Å—ã.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–ª —Å—Ç–∞—Ç—É—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑:
- `unread` (createdAt: 1000)
- `delivered` (createdAt: 2000)
- `read` (createdAt: 3000)

–¢–æ –≤ –º–∞—Ç—Ä–∏—Ü–µ –±—É–¥–µ—Ç:
```javascript
[
  { userType: "user", status: "unread", count: 1 },
  { userType: "user", status: "delivered", count: 1 },
  { userType: "user", status: "read", count: 1 }
]
```

–ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤.

#### –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è

–°—Ç–∞—Ç—É—Å—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è **–≤—Å–µ–≥–¥–∞ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è** –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã. –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã:
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏—è
- –û–±–µ—Å–ø–µ—á–∏—Ç—å –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–∞ (–º–∞—Ç—Ä–∏—Ü–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞ –¥–ª—è –≤—Å–µ—Ö)
- –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç, –∫—Ç–æ –ø–æ–ª—É—á–∏–ª/–ø—Ä–æ—á–∏—Ç–∞–ª –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Å—Ç–∞—Ç—É—Å—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
- –í –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—á–∏—Ç–∞–≤—à–∏—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `read=2` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ 2 –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø—Ä–æ—á–∏—Ç–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ)

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞:**
- –ì—Ä—É–ø–ø–∞: alice, bob, charlie, diana (4 —É—á–∞—Å—Ç–Ω–∏–∫–∞)
- alice –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
- bob –∏ charlie –ø—Ä–æ—á–∏—Ç–∞–ª–∏ (read)
- diana –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∞ (unread)

–ú–∞—Ç—Ä–∏—Ü–∞ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±—É–¥–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π:
```javascript
[
  { userType: "user", status: "read", count: 2 },    // bob –∏ charlie
  { userType: "user", status: "unread", count: 1 }    // diana
]
```

–°—Ç–∞—Ç—É—Å—ã alice (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è) –∏—Å–∫–ª—é—á–µ–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –æ–±—ã—á–Ω–æ –Ω–µ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏/–ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ API

### Endpoints

`statusMessageMatrix` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö endpoints:

1. **`GET /api/users/:userId/dialogs/:dialogId/messages`**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å `statusMessageMatrix` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ò—Å–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `userId`

2. **`GET /api/users/:userId/dialogs/:dialogId/messages/:messageId`**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `statusMessageMatrix`
   - –ò—Å–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `userId`

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

```json
{
  "data": [
    {
      "messageId": "msg_abc123",
      "content": "–ü—Ä–∏–≤–µ—Ç!",
      "senderId": "alice",
      "statusMessageMatrix": [
        {
          "userType": "user",
          "status": "read",
          "count": 3
        },
        {
          "userType": "user",
          "status": "delivered",
          "count": 1
        },
        {
          "userType": "bot",
          "status": "read",
          "count": 1
        }
      ]
    }
  ]
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –ø—Ä–æ—á–∏—Ç–∞–Ω–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏

```javascript
const statusMatrix = message.statusMessageMatrix || [];

// –ò—â–µ–º –∑–∞–ø–∏—Å—å —Å userType='user' –∏ status='read' —Å count >= 1
const readStatus = statusMatrix.find(
  item => item.userType === 'user' && item.status === 'read' && item.count >= 1
);

if (readStatus) {
  console.log(`–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ ${readStatus.count} –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º(—è–º–∏) —Ç–∏–ø–∞ "user"`);
}
```

### –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

```javascript
const statusMatrix = message.statusMessageMatrix || [];

// –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "read"
const totalReadCount = statusMatrix
  .filter(item => item.status === 'read')
  .reduce((sum, item) => sum + item.count, 0);

console.log(`–í—Å–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ: ${totalReadCount} —Ä–∞–∑(–∞)`);
```

### –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–ø–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```javascript
const statusMatrix = message.statusMessageMatrix || [];

// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const byUserType = statusMatrix.reduce((acc, item) => {
  const type = item.userType || 'unknown';
  if (!acc[type]) acc[type] = {};
  acc[type][item.status] = item.count;
  return acc;
}, {});

console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º:', byUserType);
// {
//   user: { read: 3, delivered: 1 },
//   bot: { read: 1 }
// }
```

## –û—Ç–ª–∏—á–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π

### statusMessageMatrix vs statuses

- **`statusMessageMatrix`** ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ **–≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π** (–∏—Å–∫–ª—é—á–∞—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
- **`statuses`** (—É—Å—Ç–∞—Ä–µ–≤—à–µ–µ) ‚Äî –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### statusMessageMatrix vs reactionSet

- **`statusMessageMatrix`** ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–∞—Ö –¥–æ—Å—Ç–∞–≤–∫–∏/–ø—Ä–æ—á—Ç–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
- **`reactionSet`** ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∞–∫—Ü–∏—è—Ö (—ç–º–æ–¥–∑–∏) –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

## –í–∞–ª–∏–¥–∞—Ü–∏—è

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `statusMessageMatrix` –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –≤ `responseSchemas.js`:

- –î–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º
- –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
  - `userType` (string | null)
  - `status` (string)
  - `count` (number)

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –§—É–Ω–∫—Ü–∏—è: `buildStatusMessageMatrix`

```javascript
export async function buildStatusMessageMatrix(tenantId, messageId, senderId) {
  return await MessageStatus.aggregate([
    {
      $match: {
        tenantId: tenantId,
        messageId: messageId,
        userId: { $ne: senderId } // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
      }
    },
    {
      $group: {
        _id: {
          userType: { $ifNull: ['$userType', null] },
          status: '$status'
        },
        count: { $sum: 1 }
      }
    },
    {
      $project: {
        _id: 0,
        userType: '$_id.userType',
        status: '$_id.status',
        count: 1
      }
    },
    {
      $sort: {
        userType: 1,
        status: 1
      }
    }
  ]);
}
```

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

- **–§—É–Ω–∫—Ü–∏—è**: `src/apps/tenant-api/utils/userDialogUtils.js`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: `src/apps/tenant-api/controllers/userDialogController.js`
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: `src/apps/tenant-api/validators/schemas/responseSchemas.js`

## UI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–í —Ç–µ—Å—Ç–æ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ `api-test-user-dialogs.html` –µ—Å—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∞—Ç—Ä–∏—Ü—ã —Å—Ç–∞—Ç—É—Å–æ–≤:

- –ö–Ω–æ–ø–∫–∞ "üìä –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ç–∞–±–ª–∏—Ü–µ–π —Å—Ç–∞—Ç—É—Å–æ–≤
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ URL –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: Aggregation pipeline –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
2. **–ò–Ω–¥–µ–∫—Å—ã**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `MessageStatus` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞:
   - `{ messageId, userId, createdAt: -1 }`
   - `{ tenantId, messageId, userId, createdAt: -1 }`
3. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ–≥–¥–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `userType` –∏ `status` –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏
4. **Null –∑–Ω–∞—á–µ–Ω–∏—è**: `userType` –º–æ–∂–µ—Ç –±—ã—Ç—å `null`, –µ—Å–ª–∏ —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

