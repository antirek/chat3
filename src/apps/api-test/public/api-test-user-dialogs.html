<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ + –î–∏–∞–ª–æ–≥–∏ + –°–æ–æ–±—â–µ–Ω–∏—è - Chat3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .back-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .back-link:hover {
            background-color: #f0f0f0;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 1px;
            background: #ddd;
            overflow: hidden;
        }

        .users-panel {
            width: 13%;
            min-width: 370px;
            overflow-y: auto;
            border-right: 1px solid #edeff3;
        }

        .users-panel .panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .users-panel .panel-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .dialogs-panel {
            width: 40%;
            min-width: 400px;
        }

        .messages-panel {
            width: 47%;
            min-width: 400px;
        }

        .panel {
            background: white;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            font-size: 16px;
            min-height: 59px;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }


        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            gap: 5px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .pagination button {
            padding: 5px 10px;
            border: 1px solid #ced4da;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination span {
            margin-left: 15px;
            color: #6c757d;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
        }

        th:hover {
            background: #e9ecef;
        }

        .actions-column {
            padding: 0;
            font-size: 0;
        }

        .sort-indicator {
            margin-left: 5px;
            color: #6c757d;
            font-size: 10px;
            transition: color 0.2s;
        }

        .sort-indicator.active {
            color: #667eea;
        }

        .sort-indicator:hover {
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .dialog-row {
            cursor: pointer;
        }

        .dialog-row:hover {
            background: #e3f2fd;
        }

        .unread-badge {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }

        .loading, .error, .no-data, .placeholder {
            padding: 40px 20px;
            text-align: center;
            color: #6c757d;
        }

        .error {
            color: #dc3545;
        }

        .user-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }

        .user-id {
            font-size: 12px;
            color: #6c757d;
        }


        .message-content {
            max-width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        table button {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            height: 25px;
        }

        table button:hover {
            background: #e9ecef;
        }

        .info-button {
            padding: 4px 6px;
            font-size: 11px;
            border: 1px solid #7c8ff0;
            background: #7c8ff0;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            max-height: 25px;
            margin-bottom: 1px;
        }

        .info-button:hover {
            background: #6d7ee0;
            border-color: #6d7ee0;
        }

        .action-button {
            padding: 4px 5px;
            font-size: 11px;
            border: 1px solid transparent;
            background: #f8f9fa;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 1px;
        }

        .action-button:last-child {
            margin-right: 0;
        }

        .action-button:hover {
            opacity: 0.9;
        }

        .action-button.messages-button {
            background: #9f7aea;
            color: white;
            border-color: #9f7aea;
        }

        .action-button.messages-button:hover {
            background: #8b6ce8;
            border-color: #8b6ce8;
        }

        .action-button.add-message-button {
            background: #68d391;
            color: white;
            border-color: #68d391;
        }

        .action-button.add-message-button:hover {
            background: #5abf7d;
            border-color: #5abf7d;
        }

        .action-button.members-button {
            background: #63b3ed;
            color: white;
            border-color: #63b3ed;
        }

        .action-button.members-button:hover {
            background: #4fa3dd;
            border-color: #4fa3dd;
        }

        .action-button.reactions-button {
            background: #f655a0;
            color: white;
            border-color: #f655a0;
        }

        .action-button.reactions-button:hover {
            background: #e0448f;
            border-color: #e0448f;
        }

        .action-button.events-button {
            background: #9c27b0;
            color: white;
            border-color: #9c27b0;
        }

        .action-button.events-button:hover {
            background: #7b1fa2;
            border-color: #7b1fa2;
        }

        .action-button.updates-button {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }

        .action-button.updates-button:hover {
            background: #f57c00;
            border-color: #f57c00;
        }

        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è */
        .event-row-selected {
            background-color: #e9ecef !important;
        }

        .event-row-selected:hover {
            background-color: #dee2e6 !important;
        }

        /* –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
        .filter-form {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section {
            margin-bottom: 12px;
        }

        .form-section label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
        }

        .form-section select,
        .form-section input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }

        .form-section select:focus,
        .form-section input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .input-with-clear {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-clear input {
            padding-right: 30px;
        }

        .clear-field {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-field:hover {
            color: #dc3545;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .form-actions button {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .form-actions button:hover {
            background: #e9ecef;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #48bb78;
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-small {
            padding: 4px 5px;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            height: 25px;
        }

        .btn-add-tag {
            background: #68d391;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-tag:hover {
            background: #5abf7d;
        }

        /* –ë–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ö */
        .form-actions button.btn-primary {
            background: #667eea;
            color: white;
        }

        .form-actions button.btn-primary:hover {
            background: #5a6fd8;
        }

        .form-actions button.btn-success {
            background: #48bb78;
            color: white;
        }

        .form-actions button.btn-success:hover {
            background: #38a169;
        }

        .form-actions button.btn-secondary {
            background: #6c757d;
            color: white;
        }

        .form-actions button.btn-secondary:hover {
            background: #5a6268;
        }

        .form-actions button.btn-success {
            background: #2f855a;
            color: white;
        }

        .form-actions button.btn-success:hover {
            background: #38a169;
        }

        .form-actions button.primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .form-actions button.primary:hover {
            background: #5a6fd8;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header .modal-title:first-child {
            flex: 1;
        }

        .modal-header .modal-title:last-of-type {
            flex: 1;
            padding-left: 46px;
        }

        .modal-title {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }

        /* –î–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è —Ñ–æ—Ä–º—ã –∏ JSON */
        .modal-form-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .modal-form-left {
            flex: 1;
            min-width: 0;
        }

        .modal-form-right {
            flex: 1;
            min-width: 0;
            position: sticky;
            top: 0;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }

        .json-content {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .view-url-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: normal;
            transition: background-color 0.2s;
        }

        .view-url-btn:hover {
            background: #5a6fd8;
        }

        .url-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: normal;
            transition: background-color 0.2s;
        }

        .url-button:hover {
            background: #5a6fd8;
        }

        .url-info h4 {
            margin: 15px 0 8px 0;
            color: #333;
            font-size: 14px;
        }

        .url-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .params-list div {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .url-copy input {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .members-tab-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .members-tab-bar .tab-button {
            flex: 0 0 auto;
            padding: 6px 12px;
            border: 1px solid #ced4da;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s;
        }

        .members-tab-bar .tab-button.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .members-tab-bar .tab-button:not(.active):hover {
            background: #e9ecef;
        }

        .member-meta-editor {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            background: #f8f9fa;
            max-height: 260px;
            overflow-y: auto;
        }

        .member-meta-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .member-meta-row input {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        .member-meta-row .member-meta-key {
            flex: 0 0 180px;
            background: white;
        }

        .member-meta-row .member-meta-key[readonly] {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .member-meta-row .member-meta-value {
            flex: 1;
        }

        .member-meta-row input.input-error {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .meta-editor-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .meta-editor-actions button {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .meta-editor-actions button:hover {
            background: #e9ecef;
        }

        .meta-editor-actions button.btn-primary {
            background: #667eea;
            color: white;
        }

        .meta-editor-actions button.btn-primary:hover {
            background: #5a6fd8;
        }

        .meta-editor-actions button.btn-secondary {
            background: #6c757d;
            color: white;
        }

        .meta-editor-actions button.btn-secondary:hover {
            background: #5a6268;
        }

        .meta-editor-actions button.btn-add-tag {
            background: #68d391;
            color: white;
        }

        .meta-editor-actions button.btn-add-tag:hover {
            background: #5abf7d;
        }

        .status-message {
            margin-top: 12px;
            font-size: 12px;
        }

        .status-success {
            color: #28a745;
        }

        .status-error {
            color: #dc3545;
        }

        .member-meta-empty {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 12px;
            background: #f8f9fa;
            border: 1px dashed #ced4da;
            border-radius: 6px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group select,
        .form-group textarea,
        .form-group input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .form-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }


        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è JSON payload */
        .payload-preview {
            margin-top: 0;
        }

        .payload-preview label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .payload-json {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #495057;
            min-height: 400px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ—Ç–∞-—Ç–µ–≥–æ–≤ */
        .meta-tag-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .meta-tag-row input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        .btn-add-meta-tag {
            padding: 6px 12px;
            font-size: 12px;
            line-height: 1;
            height: auto;
            border-radius: 4px;
        }

        .width-60 {
            width: 60%;
        }

        .meta-key {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .meta-value {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .remove-meta-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            min-width: 40px;
        }

        .remove-meta-btn:hover {
            background: #c82333;
        }

        .meta-list {
            margin-bottom: 20px;
        }

        .meta-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .meta-section h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: #495057;
        }

        .add-meta-btn {
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }

        .add-meta-btn:hover {
            background: #218838;
        }

        td button:last-child {
            margin-right: 0;
        }
    </style>
</head>
<body>
    <!-- API Key –∏ Tenant ID —Ç–µ–ø–µ—Ä—å –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞ (api-test.html) -->
    <div class="container">
        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div class="panel users-panel">
            <div class="panel-header">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="filter-form" style="border-bottom: 1px solid #e9ecef;">
                <div class="form-section">
                    <label for="userFilterInput">üîç –§–∏–ª—å—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ñ–æ—Ä–º–∞—Ç: <code>(–ø–æ–ª–µ,–æ–ø–µ—Ä–∞—Ç–æ—Ä,–∑–Ω–∞—á–µ–Ω–∏–µ)</code>)</label>
                    <select id="userFilterExample" onchange="selectUserFilterExample()" style="margin-bottom: 8px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä</option>
                        <optgroup label="–ü–æ–ª–µ userId">
                            <option value="(userId,regex,carl)">userId —Å–æ–¥–µ—Ä–∂–∏—Ç "carl"</option>
                            <option value="(userId,regex,bot)">userId —Å–æ–¥–µ—Ä–∂–∏—Ç "bot"</option>
                            <option value="(userId,eq,system_bot)">userId = system_bot</option>
                        </optgroup>
                        <optgroup label="–ü–æ–ª–µ name">
                            <option value="(name,regex,Alice)">–ò–º—è —Å–æ–¥–µ—Ä–∂–∏—Ç "Alice"</option>
                            <option value="(name,regex,Marta)">–ò–º—è —Å–æ–¥–µ—Ä–∂–∏—Ç "Marta"</option>
                        </optgroup>
                        <optgroup label="–ú–µ—Ç–∞-—Ç–µ–≥–∏ (meta.*)">
                            <option value="(meta.role,eq,manager)">meta.role = manager</option>
                            <option value="(meta.region,regex,europe)">meta.region —Å–æ–¥–µ—Ä–∂–∏—Ç "europe"</option>
                        </optgroup>
                        <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä</option>
                    </select>
                    <div class="input-with-clear">
                        <input type="text" id="userFilterInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: (userId,regex,carl)&(meta.role,eq,manager)">
                        <button class="clear-field" type="button" onclick="clearUserFilter()" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ">‚úï</button>
                    </div>
                    <small style="display: block; margin-top: 6px; color: #6c757d;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–æ–ª—è `userId`, `name`, –∞ —Ç–∞–∫–∂–µ `meta.*`. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã: eq, regex, in, nin, gt, gte, lt, lte, ne –∏ –¥—Ä.</small>
                </div>
                <div class="form-actions" style="margin-top: 8px;">
                    <button class="btn-primary" type="button" onclick="applyUserFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
            <div class="panel-content" id="usersList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
            </div>
        </div>

        <!-- –î–∏–∞–ª–æ–≥–∏ -->
        <div class="panel dialogs-panel">
            <div class="panel-header">
                <span>üí¨ –î–∏–∞–ª–æ–≥–∏</span>
                <button id="viewUrlBtn" class="view-url-btn" onclick="showCurrentUrl()" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–π URL –∑–∞–ø—Ä–æ—Å–∞">üîó URL</button>
            </div>
            <div class="filter-form" id="dialogsFilterForm" style="display: none;">
                <div class="form-section">
                    <label for="filterExample">üîç –§–∏–ª—å—Ç—Ä:</label>
                    <select id="filterExample" onchange="selectFilterExample()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞</option>
                        <optgroup label="–§–∏–ª—å—Ç—Ä—ã –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º">
                            <option value="(member,in,[carl])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: carl</option>
                            <option value="(member,in,[marta])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: marta</option>
                            <option value="(member,in,[alice])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: alice</option>
                            <option value="(member,in,[bob])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: bob</option>
                            <option value="(member,in,[sara])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: sara</option>
                            <option value="(member,in,[kirk])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: kirk</option>
                            <option value="(member,in,[john])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: john</option>
                            <option value="(member,in,[eve])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: eve</option>
                            <option value="(member,in,[carl,marta])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏: carl –∏–ª–∏ marta</option>
                            <option value="(member,in,[alice,bob])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏: alice –∏–ª–∏ bob</option>
                            <option value="(member,in,[carl,marta,alice])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏: carl, marta –∏–ª–∏ alice</option>
                            <option value="(member,in,[alice,bob,eve])">üë• –° —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏: alice, bob –∏–ª–∏ eve</option>
                            <option value="(member,all,[carl,marta])">üë• –°–æ –≤—Å–µ–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏: carl –∏ marta</option>
                            <option value="(member,all,[alice,bob])">üë• –°–æ –≤—Å–µ–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏: alice –∏ bob</option>
                            <option value="(member,all,[carl,marta,alice])">üë• –°–æ –≤—Å–µ–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏: carl, marta –∏ alice</option>
                            <option value="(member,ne,carl)">üë• –ë–ï–ó —É—á–∞—Å—Ç–Ω–∏–∫–∞: carl</option>
                            <option value="(member,ne,marta)">üë• –ë–ï–ó —É—á–∞—Å—Ç–Ω–∏–∫–∞: marta</option>
                            <option value="(member,nin,[carl,marta])">üë• –ë–ï–ó —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: carl –∏ marta</option>
                        </optgroup>
                        <optgroup label="–§–∏–ª—å—Ç—Ä—ã –ø–æ meta">
                            <option value="(meta.channelType,eq,whatsapp)">meta. –¢–∏–ø –∫–∞–Ω–∞–ª–∞ = whatsapp</option>
                            <option value="(meta.channelType,eq,telegram)">meta. –¢–∏–ø –∫–∞–Ω–∞–ª–∞ = telegram</option>
                            <option value="(meta.type,eq,internal)">meta. –¢–∏–ø –¥–∏–∞–ª–æ–≥–∞ = internal</option>
                            <option value="(meta.type,eq,external)">meta. –¢–∏–ø –¥–∏–∞–ª–æ–≥–∞ = external</option>
                            <option value="(meta.securityLevel,eq,high)">meta. –£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ = high</option>
                            <option value="(meta.securityLevel,in,[high,medium])">meta. –£—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ [high,medium]</option>
                            <option value="(meta.maxParticipants,gte,50)">meta. –ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚â• 50</option>
                            <option value="(meta.maxParticipants,eq,50)">meta. –ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ = 50</option>
                            <option value="(meta.channelType,regex,^whats)">meta. –¢–∏–ø –∫–∞–Ω–∞–ª–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'whats'</option>
                            <option value="(meta.channelType,eq,whatsapp)&(meta.securityLevel,in,[high,medium])">meta. WhatsApp + –≤—ã—Å–æ–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</option>
                            <option value="(meta.type,eq,internal)&(meta.maxParticipants,eq,50)">meta. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π + 50 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                            <option value="(meta.channelType,eq,telegram)&(meta.securityLevel,eq,high)">meta. Telegram + –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</option>
                        </optgroup>
                        <optgroup label="–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã">
                            <option value="(unreadCount,gte,4)&(meta.channelType,eq,whatsapp)">üì¨ ‚â•4 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + WhatsApp</option>
                            <option value="(unreadCount,eq,0)&(meta.type,eq,internal)">üì¨ 0 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π</option>
                            <option value="(unreadCount,gte,2)&(meta.securityLevel,eq,high)">üì¨ ‚â•2 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</option>
                            <option value="(unreadCount,gt,0)&(meta.channelType,eq,telegram)">üì¨ >0 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + Telegram</option>
                            <option value="(unreadCount,gte,1)&(meta.maxParticipants,eq,50)">üì¨ ‚â•1 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + 50 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                            <option value="(unreadCount,eq,0)&(meta.type,eq,external)">üì¨ 0 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + –í–Ω–µ—à–Ω–∏–π</option>
                            <option value="(unreadCount,gte,3)&(meta.channelType,eq,whatsapp)">üì¨ ‚â•3 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + WhatsApp</option>
                            <option value="(unreadCount,gt,0)&(meta.channelType,in,[whatsapp,telegram])&(meta.securityLevel,eq,high)">üì¨ >0 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö + WhatsApp/Telegram + –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</option>
                            <option value="(member,in,[carl])&(meta.channelType,eq,whatsapp)">üë• –° carl + WhatsApp</option>
                            <option value="(member,in,[marta])&(unreadCount,gt,0)">üë• –° marta + –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</option>
                            <option value="(member,in,[alice])&(meta.channelType,eq,telegram)">üë• –° alice + Telegram</option>
                            <option value="(member,in,[carl,marta])&(unreadCount,eq,0)">üë• –° carl –∏–ª–∏ marta + –Ω–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö</option>
                            <option value="(member,all,[carl,marta])&(meta.type,eq,internal)">üë• –°–æ –≤—Å–µ–º–∏: carl –∏ marta + –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π</option>
                            <option value="(member,in,[alice,bob])&(meta.channelType,eq,whatsapp)">üë• –° alice –∏–ª–∏ bob + WhatsApp</option>
                            <option value="(member,in,[sara])&(unreadCount,gte,1)">üë• –° sara + ‚â•1 –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö</option>
                        </optgroup>
                        <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä</option>
                    </select>
                    <div class="input-with-clear">
                        <input type="text" id="filterValue" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä" />
                        <button class="clear-field" onclick="clearFilter()" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä">‚úï</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button onclick="applyFilter()" class="btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
            <div class="panel-content" id="dialogsList">
                <div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="panel messages-panel">
            <div class="panel-header">
                <span>üìù –°–æ–æ–±—â–µ–Ω–∏—è</span>
                <button onclick="showCurrentMessageUrl()" class="url-button" title="–ü–æ–∫–∞–∑–∞—Ç—å URL –∑–∞–ø—Ä–æ—Å–∞">üîó URL</button>
            </div>
            <div class="filter-form" id="messagesFilterForm" style="display: none;">
                <div class="form-section">
                    <label for="messageFilterExample">üîç –§–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π:</label>
                    <select id="messageFilterExample" onchange="selectMessageFilterExample()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞</option>
                        <option value="(content,regex,–≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è)">üìù –°–æ–¥–µ—Ä–∂–∏—Ç "–≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è"</option>
                        <option value="(content,regex,—Å–ø–∞—Å–∏–±–æ)">üìù –°–æ–¥–µ—Ä–∂–∏—Ç "—Å–ø–∞—Å–∏–±–æ"</option>
                        <option value="(content,regex,–ø—Ä–∏–≤–µ—Ç)">üìù –°–æ–¥–µ—Ä–∂–∏—Ç "–ø—Ä–∏–≤–µ—Ç"</option>
                        <option value="(content,regex,—Ö–æ—Ä–æ—à–æ)">üìù –°–æ–¥–µ—Ä–∂–∏—Ç "—Ö–æ—Ä–æ—à–æ"</option>
                        <option value="(content,regex,–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ)">üìù –°–æ–¥–µ—Ä–∂–∏—Ç "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ"</option>
                        <option value="(content,regex,–æ—Ç–ª–∏—á–Ω–æ)">üìù –°–æ–¥–µ—Ä–∂–∏—Ç "–æ—Ç–ª–∏—á–Ω–æ"</option>
                        <option value="(type,eq,internal.text)">üìù –¢–∏–ø = internal.text</option>
                        <option value="(type,eq,system)">üìù –¢–∏–ø = system</option>
                        <option value="(type,in,[text,system])">üìù –¢–∏–ø –≤ [text,system]</option>
                        <option value="(senderId,eq,carl)">üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å = carl</option>
                        <option value="(senderId,eq,sara)">üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å = sara</option>
                        <option value="(senderId,in,[carl,marta])">üë• –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤ [carl,marta]</option>
                        <option value="(createdAt,gte,2025-10-24)">üìÖ –°–æ–∑–¥–∞–Ω–æ ‚â• 24.10.2025</option>
                        <option value="(createdAt,gte,2025-10-22)">üìÖ –°–æ–∑–¥–∞–Ω–æ ‚â• 22.10.2025</option>
                        <option value="(createdAt,lt,2025-10-21)">üìÖ –°–æ–∑–¥–∞–Ω–æ < 21.10.2025</option>
                        <option value="(content,regex,–≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è)&(type,eq,system)">üìù "–≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è" + system</option>
                        <option value="(senderId,eq,carl)&(type,eq,system)">üë§ Carl + system</option>
                        <option value="(content,regex,—Å–ø–∞—Å–∏–±–æ)&(createdAt,gte,2025-10-24)">üìù "—Å–ø–∞—Å–∏–±–æ" + ‚â•24.10</option>
                        <option value="(senderId,in,[carl,sara])&(type,eq,internal.text)&(content,regex,–ø—Ä–∏–≤–µ—Ç)">üë• Carl/Sara + internal.text + "–ø—Ä–∏–≤–µ—Ç"</option>
                        <option value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä">‚úèÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä</option>
                    </select>
                    <div class="input-with-clear">
                        <input type="text" id="messageFilterInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π">
                        <button type="button" class="clear-field" onclick="clearMessageFilter()">‚úï</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button onclick="applyMessageFilter()" class="btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
            <div class="panel-content" id="messagesList">
                <div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div id="membersPanelContent" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                <div class="members-tab-bar" style="padding: 15px 20px; border-bottom: 1px solid #e9ecef; flex-shrink: 0;">
                    <button type="button" class="tab-button active" id="membersTabListPanel" onclick="switchMembersTabPanel('list')">–°–ø–∏—Å–æ–∫</button>
                    <button type="button" class="tab-button" id="membersTabMetaPanel" onclick="switchMembersTabPanel('meta')">–ú–µ—Ç–∞</button>
                </div>
                
                <div id="membersListSectionPanel" style="flex: 1; overflow-y: auto; overflow-x: hidden;">
                    <div class="filter-form" style="border-bottom: 1px solid #e9ecef; padding: 15px 20px;">
                        <div class="form-section">
                            <label for="memberFilterInputPanel">üîç –§–∏–ª—å—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Ñ–æ—Ä–º–∞—Ç: <code>(–ø–æ–ª–µ,–æ–ø–µ—Ä–∞—Ç–æ—Ä,–∑–Ω–∞—á–µ–Ω–∏–µ)</code>)</label>
                            <select id="memberFilterExamplePanel" onchange="selectMemberFilterExamplePanel()" style="margin-bottom: 8px;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä</option>
                                <optgroup label="userId">
                                    <option value="(userId,regex,carl)">userId —Å–æ–¥–µ—Ä–∂–∏—Ç "carl"</option>
                                    <option value="(userId,eq,alice)">userId = alice</option>
                                </optgroup>
                                <optgroup label="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å—á—ë—Ç—á–∏–∫–∏">
                                    <option value="(isActive,eq,true)">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                                    <option value="(unreadCount,gt,0)">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ &gt; 0</option>
                                </optgroup>
                                <optgroup label="–ú–µ—Ç–∞-—Ç–µ–≥–∏ (meta.*)">
                                    <option value="(meta.role,eq,agent)">meta.role = agent</option>
                                    <option value="(meta.shift,eq,day)">meta.shift = day</option>
                                </optgroup>
                                <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä</option>
                            </select>
                            <div class="input-with-clear">
                                <input type="text" id="memberFilterInputPanel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: (userId,regex,carl)&(meta.role,eq,agent)">
                                <button class="clear-field" type="button" onclick="clearMemberFilterFieldPanel()" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ">‚úï</button>
                            </div>
                            <small style="display: block; margin-top: 6px; color: #6c757d;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–æ–ª—è `userId`, `isActive`, `unreadCount`, `joinedAt`, `meta.*`. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã: eq, ne, regex, in, nin, gt, gte, lt, lte.</small>
                        </div>
                        <div class="form-actions" style="margin-top: 8px;">
                            <button class="btn-primary" type="button" onclick="applyMemberFilterPanel()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            <button class="btn-secondary" type="button" onclick="clearMemberFilterPanel()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div style="padding: 15px 20px;">
                        <h3 style="margin-bottom: 15px; color: #333; font-size: 16px;">–¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
                        <div id="currentMembersListPanel" style="max-height: 400px; overflow-y: auto;">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</div>
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid #e9ecef; padding: 15px 20px;">
                        <h3 style="margin-bottom: 15px; color: #333; font-size: 16px;">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞:</h3>
                        <form id="addMemberFormPanel">
                            <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <label for="newMemberSelectPanel">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                                    <select id="newMemberSelectPanel" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
                                        <option value="carl">Carl</option>
                                        <option value="marta">Marta</option>
                                        <option value="sara">Sara</option>
                                        <option value="kirk">Kirk</option>
                                        <option value="john">John</option>
                                        <option value="alice">Alice</option>
                                        <option value="bob">Bob</option>
                                        <option value="system_bot">System Bot</option>
                                    </select>
                                </div>
                                <div class="form-actions" style="margin: 0;">
                                    <button type="submit" class="btn-success" style="white-space: nowrap;">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="memberMetaSectionPanel" style="display: none; flex: 1; overflow-y: auto; overflow-x: hidden; padding: 15px 20px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 16px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞-—Ç–µ–≥–æ–≤</h3>
                    <div class="form-section">
                        <label for="memberMetaSelectPanel">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label>
                        <select id="memberMetaSelectPanel" onchange="onSelectMemberForMetaPanel()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ --</option>
                        </select>
                    </div>
                    <div id="memberMetaEditorContainerPanel" style="margin-top: 15px;">
                        <div id="memberMetaEmptyStatePanel" class="member-meta-empty">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞-—Ç–µ–≥–∏</div>
                        <div id="memberMetaEditorPanel" class="member-meta-editor" style="display: none;"></div>
                    </div>
                    <div class="meta-editor-actions" id="memberMetaEditorActionsPanel" style="display: none;">
                        <button type="button" class="btn-add-tag" onclick="addMemberMetaRowPanel()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
                    </div>
                    <div class="meta-editor-actions" id="memberMetaSaveActionsPanel" style="display: none;">
                        <button type="button" class="btn-primary" onclick="saveMemberMetaChangesPanel()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn-secondary" onclick="cancelMemberMetaEditingPanel()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                    <div id="memberMetaStatusPanel" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
    <div id="infoModal" class="modal">
        <div class="modal-content width-60">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="addMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
                <span class="close" onclick="closeAddMessageModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-form-container">
                    <div class="modal-form-left">
                        <form id="addMessageForm">
                            <div class="form-group">
                                <label for="messageSender">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</label>
                                <select id="messageSender" required onchange="updatePayloadJson()">
                                    <option value="carl">Carl</option>
                                    <option value="marta">Marta</option>
                                    <option value="sara">Sara</option>
                                    <option value="kirk">Kirk</option>
                                    <option value="john">John</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="messageType">–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                                <select id="messageType" required onchange="updatePayloadJson()">
                                    <option value="internal.text">Text</option>
                                    <option value="system.message">System</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="messageContent">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:</label>
                                <textarea id="messageContent" rows="4" required oninput="updatePayloadJson()">—Ç–µ—Å—Ç —Ç–µ—Å—Ç</textarea>
                            </div>
                            <div class="form-group">
                                <label for="quotedMessageId">Quoted Message ID:</label>
                                <input type="text" id="quotedMessageId" placeholder="msg_..." oninput="updatePayloadJson()">
                            </div>
                            
                            <!-- –°–µ–∫—Ü–∏—è –º–µ—Ç–∞-—Ç–µ–≥–æ–≤ -->
                            <div class="form-group">
                                <label>–ú–µ—Ç–∞-—Ç–µ–≥–∏:</label>
                                <div id="metaTagsContainer">
                                    <div class="meta-tag-row">
                                        <input type="text" class="meta-key" placeholder="–ö–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä: channelType)" pattern="[a-zA-Z0-9_]+" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ">
                                        <input type="text" class="meta-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: whatsapp)">
                                        <button type="button" class="remove-meta-btn" onclick="removeMetaTagRow(this)" style="display: none;">‚úï</button>
                                    </div>
                                </div>
                                <button type="button" onclick="addMetaTagRow()" class="add-meta-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞-—Ç–µ–≥</button>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn-success">–î–æ–±–∞–≤–∏—Ç—å</button>
                                <button type="button" class="btn-secondary" onclick="closeAddMessageModal()">–û—Ç–º–µ–Ω–∞</button>
                                
                            </div>
                        </form>
                    </div>
                    <div class="modal-form-right">
                        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ JSON payload -->
                        <div class="payload-preview">
                            <label>JSON Payload:</label>
                            <div id="payloadJson" class="payload-json">{}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏ -->
    <div id="reactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é</h2>
                <span class="close" onclick="closeReactionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- –°–µ–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∞–∫—Ü–∏–π -->
                <div id="existingReactionsSection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 16px;">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∞–∫—Ü–∏–∏:</h3>
                    <div id="existingReactionsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 6px; padding: 10px; background: #f8f9fa;">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–∫—Ü–∏–π...</div>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏ -->
                <form id="addReactionForm">
                    <div class="form-group">
                        <label for="reactionUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
                        <select id="reactionUser" required>
                            <option value="carl">Carl</option>
                            <option value="marta">Marta</option>
                            <option value="sara">Sara</option>
                            <option value="kirk">Kirk</option>
                            <option value="john">John</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é:</label>
                        <div class="reactions-container" style="display: flex; gap: 15px; justify-content: center; padding: 20px 0;">
                            <button type="button" class="reaction-btn" onclick="addReaction('üëç')" style="font-size: 32px; padding: 10px 20px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">üëç</button>
                            <button type="button" class="reaction-btn" onclick="addReaction('‚ù§Ô∏è')" style="font-size: 32px; padding: 10px 20px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">‚ù§Ô∏è</button>
                            <button type="button" class="reaction-btn" onclick="addReaction('üòÇ')" style="font-size: 32px; padding: 10px 20px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">üòÇ</button>
                            <button type="button" class="reaction-btn" onclick="addReaction('üî•')" style="font-size: 32px; padding: 10px 20px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">üî•</button>
                            <button type="button" class="reaction-btn" onclick="addReaction('üéâ')" style="font-size: 32px; padding: 10px 20px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">üéâ</button>
                        </div>
                        <input type="hidden" id="selectedReaction" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeReactionModal()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="eventsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–°–æ–±—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
                <h2 class="modal-title" id="eventUpdatesTitle" style="display: none; margin: 0; color: #495057; font-size: 18px;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è</h2>
                <span class="close" onclick="closeEventsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-form-container">
                    <div class="modal-form-left">
                        <div id="eventsList" style="max-height: 500px; overflow-y: auto;">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
                        </div>
                    </div>
                    <div class="modal-form-right">
                        <div id="eventUpdatesList" style="max-height: 500px; overflow-y: auto;">
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="updatesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
                <span class="close" onclick="closeUpdatesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="updatesList" style="max-height: 500px; overflow-y: auto;">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π –¥–∏–∞–ª–æ–≥–∞ -->
    <div id="dialogEventsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title modal-title-left">–°–æ–±—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞</h2>
                <h2 class="modal-title modal-title-right" id="dialogEventUpdatesTitle" style="display: none; margin: 0; color: #495057; font-size: 18px;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞</h2>
                <span class="close" onclick="closeDialogEventsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-form-container">
                    <div class="modal-form-left">
                        <div id="dialogEventsList" style="max-height: 500px; overflow-y: auto;">
                            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
                        </div>
                    </div>
                    <div class="modal-form-right">
                        <div id="dialogEventUpdatesList" style="max-height: 500px; overflow-y: auto;">
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞ -->
    <div id="dialogUpdatesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞</h2>
                <span class="close" onclick="closeDialogUpdatesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="dialogUpdatesList" style="max-height: 500px; overflow-y: auto;">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ç–∞-—Ç–µ–≥–∞–º–∏ –¥–∏–∞–ª–æ–≥–∞ -->
    <div id="dialogMetaModal" class="modal">
        <div class="modal-content width-60">
            <div class="modal-header">
                <h2>üè∑Ô∏è Meta —Ç–µ–≥–∏ –¥–∏–∞–ª–æ–≥–∞</h2>
                <span class="close" onclick="closeDialogMetaModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="dialogMetaDialogId">
                <div class="meta-list" id="dialogMetaList"></div>
                <div class="meta-section">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å Meta —Ç–µ–≥</h3>
                    <div class="meta-tag-row">
                        <input type="text" id="newDialogMetaKey" placeholder="key (–Ω–∞–ø—Ä–∏–º–µ—Ä: type)">
                        <input type="text" id="newDialogMetaValue" placeholder="value (–Ω–∞–ø—Ä–∏–º–µ—Ä: internal)">
                        <button class="btn-success btn-add-meta-tag" onclick="addDialogMetaTag()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeDialogMetaModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let apiKey = '';
        let tenantId = '';
        let currentUserId = null;
        let currentDialogId = null;
        let currentPage = 1;
        let totalPages = 1;
        let totalDialogs = 0;
        let currentMessagePage = 1;
        let currentMessageFilter = null;
        let currentMessageSort = null;
        let currentDialogFilter = null;
        let currentDialogSort = null;
        let allUsers = [];
        let currentUserFilter = '';
        let currentDialogMembers = [];
        let currentMembersTab = 'list';
        let currentMemberMetaEditingUserId = null;
        let currentMemberMetaOriginal = {};
        let currentMemberFilter = '';
        let currentViewMode = 'messages'; // 'messages' –∏–ª–∏ 'members'

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                apiKey: params.get('apiKey') || '',
                tenantId: params.get('tenantId') || 'tnt_default'
            };
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ API –∫–ª—é—á–∞ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞ –∏–ª–∏ URL)
        function setApiKeyFromExternal(extApiKey, extTenantId) {
            if (!extApiKey) {
                console.warn('API Key –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            apiKey = extApiKey;
            tenantId = extTenantId || 'tnt_default';
            
            console.log('API Key set from external:', apiKey);
            console.log('Tenant ID set from external:', tenantId);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            loadUsers();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';

            if (!apiKey) {
                usersList.innerHTML = '<div class="error">API –∫–ª—é—á –Ω–µ –∑–∞–¥–∞–Ω</div>';
                return;
            }

            try {
                const params = new URLSearchParams({
                    limit: '100',
                    includeDialogCount: 'true',
                    page: '1'
                });

                if (currentUserFilter) {
                    params.append('filter', currentUserFilter);
                }

                const response = await fetch(`/api/users?${params.toString()}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorPayload = await response.json();
                        if (errorPayload?.message) {
                            errorMessage = errorPayload.message;
                        }
                    } catch (parseError) {
                        // ignore parse error, keep default message
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                const users = (Array.isArray(data.data) ? data.data : []).map((user) => ({
                    ...user,
                    displayName: user.name || user.userId,
                    dialogCount: Number.isFinite(user.dialogCount) ? user.dialogCount : 0
                }));

                if (users.length === 0) {
                    usersList.innerHTML = '<div class="no-data">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                users.sort((a, b) => {
                    if (b.dialogCount !== a.dialogCount) {
                        return b.dialogCount - a.dialogCount;
                    }
                    const nameA = (a.displayName || '').toLowerCase();
                    const nameB = (b.displayName || '').toLowerCase();
                    if (nameA === nameB) {
                        return a.userId.localeCompare(b.userId);
                    }
                    return nameA.localeCompare(nameB);
                });

                allUsers = users;
                renderUsersList();
            } catch (error) {
                console.error('Error loading users:', error);
                const message = error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                usersList.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${escapeHtml(message)}</div>`;
            }
        }

        function getAuthHeaders() {
            return {
                'X-API-Key': apiKey,
                'X-TENANT-ID': tenantId
            };
        }

        function renderUsersList() {
            const usersList = document.getElementById('usersList');
            if (!Array.isArray(allUsers) || allUsers.length === 0) {
                usersList.innerHTML = '<div class="no-data">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            usersList.innerHTML = allUsers.map(renderUserListItem).join('');
        }

        function renderUserListItem(user) {
        const displayName = user.displayName || user.userId;
        const dialogCount = Number.isFinite(user.dialogCount) ? user.dialogCount : 0;
        const safeNameAttr = escapeJsString(displayName);
        const safeUserIdAttr = escapeJsString(user.userId);
        const nameText = escapeHtml(displayName);
        const userIdText = escapeHtml(user.userId);

            return `
                <div class="user-item" onclick="selectUser('${safeUserIdAttr}', '${safeNameAttr}')" title="–î–∏–∞–ª–æ–≥–æ–≤: ${dialogCount}">
                    <div class="user-info">
                        <div class="user-name">${nameText}</div>
                        <div class="user-id">User ID: ${userIdText} ‚Ä¢ –î–∏–∞–ª–æ–≥–æ–≤: ${dialogCount}</div>
                    </div>
                    <button class="info-button" onclick="event.stopPropagation(); showUserJsonModal('${safeUserIdAttr}')" style="margin-left: auto; flex-shrink: 0;">‚ÑπÔ∏è –ò–Ω—Ñ–æ</button>
                </div>
            `;
        }

        function escapeHtml(value) {
            return String(value ?? '').replace(/[&<>"']/g, (match) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[match]);
        }

        function escapeJsString(value) {
            return String(value ?? '')
                .replace(/\\/g, '\\\\')
                .replace(/'/g, '\\\'');
        }

        // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function selectUser(userId, userName) {
            console.log('Selected user:', userId, userName);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUserId = userId;
            currentDialogId = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUserUI(userName);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('dialogsFilterForm').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentPage = 1;
            currentDialogFilter = null;
            await loadUserDialogs(userId, 1);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUserUI(userName) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–ª–æ–Ω–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤
            const dialogsHeader = document.querySelector('.dialogs-panel .panel-header');
            if (dialogsHeader) {
                dialogsHeader.innerHTML = `
                    <span>üí¨ –î–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userName}</span>
                    <button id="viewUrlBtn" class="view-url-btn" onclick="showCurrentUrl()" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–π URL –∑–∞–ø—Ä–æ—Å–∞">üîó URL</button>
                `;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserDialogs(userId, page = 1) {
            const dialogsList = document.getElementById('dialogsList');
            dialogsList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...</div>';

            try {
                let url = `/api/users/${userId}/dialogs?page=${page}&limit=10`;
                if (currentDialogFilter) {
                    url += `&filter=${encodeURIComponent(currentDialogFilter)}`;
                }
                if (currentDialogSort) {
                    url += `&sort=${encodeURIComponent(currentDialogSort)}`;
                }
                console.log('Loading user dialogs:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('User dialogs response:', data);

                if (data.data && data.data.length > 0) {
                    currentPage = page;
                    totalPages = data.pagination.pages;
                    totalDialogs = data.pagination.total;
                    
                    dialogsList.innerHTML = `
                        <div class="pagination">
                            <button onclick="changePage(${page - 1})" ${page <= 1 ? 'disabled' : ''}>‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                            ${Array.from({ length: Math.min(5, data.pagination.pages) }, (_, i) => {
                                const pageNum = i + 1;
                                return `<button onclick="changePage(${pageNum})" ${pageNum === page ? 'class="active"' : ''}>${pageNum}</button>`;
                            }).join('')}
                            <button onclick="changePage(${page + 1})" ${page >= data.pagination.pages ? 'disabled' : ''}>–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
                            <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page} –∏–∑ ${data.pagination.pages} (–≤—Å–µ–≥–æ ${data.pagination.total} –¥–∏–∞–ª–æ–≥–æ–≤)</span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Dialog ID</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th onclick="toggleSort('unreadCount')" style="cursor: pointer;">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ<span class="sort-indicator" id="sort-unreadCount">${getSortIndicator('unreadCount')}</span></th>
                                    <th onclick="toggleSort('lastSeenAt')" style="cursor: pointer;">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Å–º–æ—Ç—Ä<span class="sort-indicator" id="sort-lastSeenAt">${getSortIndicator('lastSeenAt')}</span></th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(dialog => `
                                    <tr onclick="selectDialog('${dialog.dialogId}', '${dialog.name}')" class="dialog-row">
                                        <td title="${dialog.dialogId}">${shortenDialogId(dialog.dialogId)}</td>
                                        <td>${dialog.name}</td>
                                        <td>${dialog.context?.unreadCount || 0}</td>
                                        <td>${formatLastSeen(dialog.context?.lastSeenAt)}</td>
                                        <td class="actions-column">
                                            <button class="action-button add-message-button" onclick="event.stopPropagation(); showAddMessageModal('${dialog.dialogId}', '${dialog.name}')">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                                            <button class="info-button" onclick="event.stopPropagation(); showDialogInfo('${dialog.dialogId}')">‚ÑπÔ∏è –ò–Ω—Ñ–æ</button>
                                            <button class="action-button members-button" onclick="event.stopPropagation(); selectDialogMembers('${dialog.dialogId}', '${dialog.name}')">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
                                            <button class="action-button messages-button" onclick="selectDialog('${dialog.dialogId}', '${dialog.name}')">üìù –°–æ–æ–±—â–µ–Ω–∏—è</button>
                                            <button class="action-button events-button" onclick="event.stopPropagation(); showDialogEventsModal('${dialog.dialogId}')">üìã –°–æ–±—ã—Ç–∏—è</button>
                                            <button class="btn-success btn-small" onclick="event.stopPropagation(); showDialogMetaModal('${dialog.dialogId}')">üè∑Ô∏è Meta</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    dialogsList.innerHTML = '<div class="no-data">–î–∏–∞–ª–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            } catch (error) {
                console.error('Error loading user dialogs:', error);
                dialogsList.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            
            currentPage = page;
            
            if (currentUserId) {
                await loadUserDialogs(currentUserId, page);
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        function formatLastSeen(lastSeenAt) {
            if (!lastSeenAt) return '-';
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–æ–º –≤ —á–∏—Å–ª–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            const timestamp = typeof lastSeenAt === 'string' ? parseFloat(lastSeenAt) : lastSeenAt;
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è dialogId
        function shortenDialogId(dialogId) {
            if (!dialogId) return '-';
            if (dialogId.startsWith('dlg_')) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º dlg_ + –ø–µ—Ä–≤—ã–µ 4 —Å–∏–º–≤–æ–ª–∞ –ø–æ—Å–ª–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ + ...
                return `dlg_${dialogId.substring(4, 8)}...`;
            }
            return dialogId;
        }

        // –í—ã–±–æ—Ä –¥–∏–∞–ª–æ–≥–∞
        async function selectDialog(dialogId, dialogName) {
            console.log('Selected dialog:', dialogId, dialogName);
            
            currentDialogId = dialogId;
            currentMessagePage = 1;
            currentMessageFilter = null;
            currentMessageSort = null;
            currentViewMode = 'messages';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏
            const messagesHeader = document.querySelector('.messages-panel .panel-header span');
            if (messagesHeader) {
                messagesHeader.textContent = 'üìù –°–æ–æ–±—â–µ–Ω–∏—è';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const membersPanelContent = document.getElementById('membersPanelContent');
            if (membersPanelContent) {
                membersPanelContent.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messagesFilterForm = document.getElementById('messagesFilterForm');
            const messagesList = document.getElementById('messagesList');
            if (messagesFilterForm) {
                messagesFilterForm.style.display = 'block';
            }
            if (messagesList) {
                messagesList.style.display = 'block';
            }
            
            loadDialogMessages(currentDialogId, 1);
        }

        // –í—ã–±–æ—Ä –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        async function selectDialogMembers(dialogId, dialogName) {
            console.log('Selected dialog for members:', dialogId, dialogName);
            
            currentDialogId = dialogId;
            currentDialogIdForMembers = dialogId;
            currentDialogNameForMembers = dialogName;
            currentMemberFilter = '';
            currentViewMode = 'members';
            currentMembersTab = 'list';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏
            const messagesHeader = document.querySelector('.messages-panel .panel-header span');
            if (messagesHeader) {
                messagesHeader.textContent = `üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: ${escapeHtml(dialogName)}`;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messagesFilterForm = document.getElementById('messagesFilterForm');
            const messagesList = document.getElementById('messagesList');
            if (messagesFilterForm) {
                messagesFilterForm.style.display = 'none';
            }
            if (messagesList) {
                messagesList.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            const membersPanelContent = document.getElementById('membersPanelContent');
            if (membersPanelContent) {
                membersPanelContent.style.display = 'flex';
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–°–ø–∏—Å–æ–∫"
            document.getElementById('addMemberFormPanel').reset();
            clearMemberFilterFieldPanel();
            currentMemberMetaEditingUserId = null;
            currentMemberMetaOriginal = {};
            switchMembersTabPanel('list');
            clearMemberMetaEditorPanel();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –ø–∞–Ω–µ–ª—å
            await loadDialogMembersInPanel(currentDialogId);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞ (–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        async function loadDialogMessages(dialogId, page = 1) {
            const messagesList = document.getElementById('messagesList');
            
            if (!currentUserId) {
                messagesList.innerHTML = '<div class="error">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
                return;
            }
            
            messagesList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';

            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π endpoint —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let url = `/api/users/${currentUserId}/dialogs/${dialogId}/messages?page=${page}&limit=10`;
                if (currentMessageSort) {
                    url += `&sort=${encodeURIComponent(currentMessageSort)}`;
                }
                if (currentMessageFilter) {
                    url += `&filter=${encodeURIComponent(currentMessageFilter)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Messages response:', data);

                if (data.data && data.data.length > 0) {
                    currentMessagePage = page;
                    
                    messagesList.innerHTML = `
                        <div class="pagination">
                            <button onclick="changeMessagePage(${page - 1})" ${page <= 1 ? 'disabled' : ''}>‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                            ${Array.from({ length: Math.min(5, data.pagination.pages) }, (_, i) => {
                                const pageNum = i + 1;
                                return `<button onclick="changeMessagePage(${pageNum})" ${pageNum === page ? 'class="active"' : ''}>${pageNum}</button>`;
                            }).join('')}
                            <button onclick="changeMessagePage(${page + 1})" ${page >= data.pagination.pages ? 'disabled' : ''}>–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
                            <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page} –∏–∑ ${data.pagination.pages} (–≤—Å–µ–≥–æ ${data.pagination.total} —Å–æ–æ–±—â–µ–Ω–∏–π)</span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                                    <th onclick="toggleMessageSort('createdAt')" style="cursor: pointer;">–í—Ä–µ–º—è <span class="sort-indicator" id="sort-message-createdAt">${getMessageSortIndicator('createdAt')}</span></th>
                                    <th>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–†–µ–∞–∫—Ü–∏—è</th>
                                    <th>–ò–Ω—Ñ–æ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(message => {
                                    const ctx = message.context || {};
                                    const statusIcons = {
                                        'sent': '‚úì',
                                        'delivered': '‚úì‚úì',
                                        'read': '‚úì‚úì',
                                        'unread': '‚óØ'
                                    };
                                    const statusColors = {
                                        'sent': '#999',
                                        'delivered': '#999',
                                        'read': '#4fc3f7',
                                        'unread': '#ccc'
                                    };
                                    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ –º–∞—Å—Å–∏–≤–∞ statuses
                                    const myStatus = (ctx.statuses && ctx.statuses.length > 0) 
                                        ? ctx.statuses[0].status 
                                        : (ctx.isMine ? 'sent' : 'unread');
                                    
                                    return `
                                    <tr data-message-id="${message.messageId}" style="${ctx.isMine ? 'background-color: #f0f8ff;' : ''}">
                                        <td>
                                            ${message.senderId}
                                            ${ctx.isMine ? '<span style="color: #4fc3f7; margin-left: 5px;" title="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">üë§</span>' : ''}
                                        </td>
                                        <td>${formatMessageTime(message.createdAt)}</td>
                                        <td class="message-content">${message.content}</td>
                                        <td>
                                            <span style="color: ${statusColors[myStatus]}; font-weight: bold;" title="${myStatus}">
                                                ${statusIcons[myStatus] || '?'}
                                            </span>
                                            <span style="color: #666; font-size: 11px; margin-left: 3px;">${myStatus}</span>
                                        </td>
                                        <td style="font-size: 20px;">
                                            ${ctx.myReaction || '-'}
                                        </td>
                                        <td class="actions-column">
                                            <button class="info-button" onclick="showMessageInfo('${message.messageId}')">‚ÑπÔ∏è –ò–Ω—Ñ–æ</button>
                                            <button class="action-button reactions-button" onclick="showReactionModal('${message.messageId}')">üòä –†–µ–∞–∫—Ü–∏–∏</button>
                                            <button class="action-button events-button" onclick="showEventsModal('${message.messageId}')">üìã –°–æ–±—ã—Ç–∏—è</button>
                                        </td>
                                    </tr>
                                `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    messagesList.innerHTML = '<div class="no-data">–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesList.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ${error.message}</div>`;
            }
        }

        // –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–æ–±—â–µ–Ω–∏–π
        async function changeMessagePage(page) {
            if (page < 1 || page === currentMessagePage) return;
            
            currentMessagePage = page;
            loadDialogMessages(currentDialogId, page);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–∞ –≤ –ø–∞–Ω–µ–ª—å
        async function loadDialogMembersInPanel(dialogId) {
            const membersListPanel = document.getElementById('currentMembersListPanel');
            
            if (!membersListPanel) {
                return;
            }
            
            membersListPanel.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</div>';

            try {
                const params = new URLSearchParams({
                    page: '1',
                    limit: '100',
                    sort: '(joinedAt,asc)'
                });
                if (currentMemberFilter) {
                    params.append('filter', currentMemberFilter);
                }
                
                const response = await fetch(`/api/dialogs/${dialogId}/members?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    let message = `HTTP error! status: ${response.status}`;
                    try {
                        const errorPayload = await response.json();
                        if (errorPayload?.message) {
                            message = errorPayload.message;
                        }
                    } catch (_) {
                        // ignore parse issues
                    }
                    throw new Error(message);
                }

                const data = await response.json();
                const members = Array.isArray(data.data) ? data.data : [];
                currentDialogMembers = members;
                refreshMemberMetaSelectPanel();

                if (members.length === 0) {
                    membersListPanel.innerHTML = '<div class="no-data">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç</div>';
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –ø–∞–Ω–µ–ª–∏
                membersListPanel.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="text-align: left; padding: 8px; color: #495057; font-weight: 600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th style="text-align: center; padding: 8px; color: #495057; font-weight: 600;">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</th>
                                <th style="text-align: center; padding: 8px; color: #495057; font-weight: 600;">–ê–∫—Ç–∏–≤–µ–Ω</th>
                                <th style="text-align: left; padding: 8px; color: #495057; font-weight: 600;">–ú–µ—Ç–∞</th>
                                <th style="text-align: center; padding: 8px; color: #495057; font-weight: 600;">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${members.map(member => `
                                <tr style="border-bottom: 1px solid #e9ecef;">
                                    <td style="padding: 8px; color: #495057; font-weight: 500;">${escapeHtml(member.userId)}</td>
                                    <td style="padding: 8px; text-align: center; color: #6c757d;">${member.unreadCount || 0}</td>
                                    <td style="padding: 8px; text-align: center;">
                                        <span style="color: ${member.isActive ? '#28a745' : '#dc3545'};">${member.isActive ? '‚úì' : '‚úó'}</span>
                                    </td>
                                    <td style="padding: 8px; color: #6c757d; font-size: 12px;">
                                        ${formatMemberMetaForPanel(member.meta)}
                                    </td>
                                    <td style="padding: 8px; text-align: center;">
                                        <button class="action-button" onclick="removeMemberFromPanel('${escapeJsString(dialogId)}', '${escapeJsString(member.userId)}')" 
                                                style="padding: 4px 12px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading members:', error);
                currentDialogMembers = [];
                refreshMemberMetaSelectPanel();
                const safeMessage = escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                membersListPanel.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${safeMessage}</div>`;
            }
        }

        function formatMemberMetaForPanel(meta) {
            if (!meta || Object.keys(meta).length === 0) {
                return '<span style="color: #adb5bd;">‚Äî</span>';
            }

            return Object.entries(meta)
                .map(([key, value]) => `<div><strong>${escapeHtml(key)}:</strong> ${escapeHtml(String(value))}</div>`)
                .join('');
        }

        async function removeMemberFromPanel(dialogId, userId) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ ${userId} –∏–∑ –¥–∏–∞–ª–æ–≥–∞?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/dialogs/${dialogId}/members/${userId}/remove`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    let message = `HTTP error! status: ${response.status}`;
                    try {
                        const errorPayload = await response.json();
                        if (errorPayload?.message) {
                            message = errorPayload.message;
                        }
                    } catch (_) {
                        // ignore parse issues
                    }
                    throw new Error(message);
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                await loadDialogMembersInPanel(dialogId);
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ${error.message}`);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞–Ω–µ–ª—å—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function switchMembersTabPanel(tab) {
            currentMembersTab = tab;
            const listSection = document.getElementById('membersListSectionPanel');
            const metaSection = document.getElementById('memberMetaSectionPanel');
            const listButton = document.getElementById('membersTabListPanel');
            const metaButton = document.getElementById('membersTabMetaPanel');

            if (listSection && metaSection) {
                if (tab === 'meta') {
                    listSection.style.display = 'none';
                    metaSection.style.display = 'block';
                    refreshMemberMetaSelectPanel();
                } else {
                    listSection.style.display = 'block';
                    metaSection.style.display = 'none';
                }
            }

            if (listButton && metaButton) {
                if (tab === 'meta') {
                    listButton.classList.remove('active');
                    metaButton.classList.add('active');
                } else {
                    listButton.classList.add('active');
                    metaButton.classList.remove('active');
                }
            }

            if (tab !== 'meta') {
                setMemberMetaStatusPanel('');
            }
        }

        function setMemberMetaStatusPanel(message, type = '') {
            const statusEl = document.getElementById('memberMetaStatusPanel');
            if (!statusEl) {
                return;
            }
            statusEl.textContent = message || '';
            statusEl.classList.remove('status-success', 'status-error');
            if (message) {
                if (type === 'success') {
                    statusEl.classList.add('status-success');
                } else if (type === 'error') {
                    statusEl.classList.add('status-error');
                }
            }
        }

        function clearMemberMetaEditorPanel() {
            const editor = document.getElementById('memberMetaEditorPanel');
            const emptyState = document.getElementById('memberMetaEmptyStatePanel');
            const actions = document.getElementById('memberMetaEditorActionsPanel');
            const saveActions = document.getElementById('memberMetaSaveActionsPanel');
            if (editor) {
                editor.innerHTML = '';
                editor.style.display = 'none';
            }
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            if (actions) {
                actions.style.display = 'none';
            }
            if (saveActions) {
                saveActions.style.display = 'none';
            }
            setMemberMetaStatusPanel('');
        }

        function refreshMemberMetaSelectPanel() {
            const select = document.getElementById('memberMetaSelectPanel');
            if (!select) {
                return;
            }

            const previousValue = currentMemberMetaEditingUserId;
            const options = ['<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ --</option>'];
            currentDialogMembers.forEach(member => {
                const safeUserId = escapeHtml(member.userId);
                options.push(`<option value="${safeUserId}">${safeUserId}</option>`);
            });
            select.innerHTML = options.join('');

            if (previousValue && currentDialogMembers.some(member => member.userId === previousValue)) {
                select.value = previousValue;
                const member = currentDialogMembers.find(m => m.userId === previousValue);
                currentMemberMetaOriginal = deepClone(member?.meta || {});
                renderMemberMetaEditorPanel(currentMemberMetaOriginal);
            } else {
                select.value = '';
                currentMemberMetaEditingUserId = null;
                currentMemberMetaOriginal = {};
                clearMemberMetaEditorPanel();
            }
        }

        function onSelectMemberForMetaPanel() {
            const select = document.getElementById('memberMetaSelectPanel');
            if (!select) {
                return;
            }
            const userId = select.value;
            setMemberMetaStatusPanel('');

            if (!userId) {
                currentMemberMetaEditingUserId = null;
                currentMemberMetaOriginal = {};
                clearMemberMetaEditorPanel();
                return;
            }

            const member = currentDialogMembers.find(m => m.userId === userId);
            currentMemberMetaEditingUserId = userId;
            currentMemberMetaOriginal = deepClone(member?.meta || {});
            renderMemberMetaEditorPanel(currentMemberMetaOriginal);
        }

        function renderMemberMetaEditorPanel(meta = {}) {
            const editor = document.getElementById('memberMetaEditorPanel');
            const emptyState = document.getElementById('memberMetaEmptyStatePanel');
            const actions = document.getElementById('memberMetaEditorActionsPanel');
            const saveActions = document.getElementById('memberMetaSaveActionsPanel');

            if (!editor || !emptyState || !actions || !saveActions) {
                return;
            }

            editor.innerHTML = '';
            const keys = Object.keys(meta || {});

            if (keys.length === 0) {
                editor.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                keys.forEach(key => {
                    editor.appendChild(createMemberMetaRowElementPanel(key, meta[key], true));
                });
                editor.style.display = 'block';
                emptyState.style.display = 'none';
            }

            actions.style.display = 'flex';
            saveActions.style.display = 'flex';
            updateMemberMetaEditorStatePanel();
        }

        function createMemberMetaRowElementPanel(key, value, isExisting) {
            const row = document.createElement('div');
            row.className = 'member-meta-row';
            row.dataset.originalKey = isExisting ? key : '';

            const keyInput = document.createElement('input');
            keyInput.type = 'text';
            keyInput.className = 'member-meta-key';
            keyInput.placeholder = '–ö–ª—é—á';
            if (isExisting) {
                keyInput.value = key;
                keyInput.readOnly = true;
            }

            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.className = 'member-meta-value';
            valueInput.placeholder = '–ó–Ω–∞—á–µ–Ω–∏–µ';
            valueInput.value = formatMetaValueForInput(value);

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-meta-btn';
            removeButton.textContent = '‚úï';
            removeButton.onclick = () => removeMemberMetaRowPanel(removeButton);

            row.appendChild(keyInput);
            row.appendChild(valueInput);
            row.appendChild(removeButton);

            return row;
        }

        function addMemberMetaRowPanel() {
            const editor = document.getElementById('memberMetaEditorPanel');
            if (!editor) {
                return;
            }
            const row = createMemberMetaRowElementPanel('', '', false);
            editor.appendChild(row);
            updateMemberMetaEditorStatePanel();
            const keyInput = row.querySelector('.member-meta-key');
            if (keyInput) {
                keyInput.focus();
            }
        }

        function removeMemberMetaRowPanel(button) {
            const row = button.closest('.member-meta-row');
            if (row) {
                row.remove();
                updateMemberMetaEditorStatePanel();
            }
        }

        function updateMemberMetaEditorStatePanel() {
            const editor = document.getElementById('memberMetaEditorPanel');
            const emptyState = document.getElementById('memberMetaEmptyStatePanel');
            if (!editor || !emptyState) {
                return;
            }
            const hasRows = editor.querySelectorAll('.member-meta-row').length > 0;
            if (hasRows) {
                editor.style.display = 'block';
                emptyState.style.display = 'none';
            } else {
                editor.style.display = 'none';
                emptyState.style.display = 'block';
            }
        }

        function collectMemberMetaRowsPanel() {
            const editor = document.getElementById('memberMetaEditorPanel');
            if (!editor) {
                return { metaEntries: {}, metaPlain: {}, errors: [] };
            }
            const rows = Array.from(editor.querySelectorAll('.member-meta-row'));
            const metaEntries = {};
            const metaPlain = {};
            const errors = [];

            rows.forEach(row => {
                const keyInput = row.querySelector('.member-meta-key');
                const valueInput = row.querySelector('.member-meta-value');
                if (!keyInput || !valueInput) {
                    return;
                }
                keyInput.classList.remove('input-error');

                const key = keyInput.value.trim();
                if (!key) {
                    errors.push('–ö–ª—é—á –º–µ—Ç–∞-—Ç–µ–≥–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                    keyInput.classList.add('input-error');
                    return;
                }
                if (metaEntries[key]) {
                    errors.push(`–î—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–ª—é—á "${key}"`);
                    keyInput.classList.add('input-error');
                    return;
                }

                const parsed = parseMetaValue(valueInput.value);
                metaEntries[key] = { value: parsed.value, dataType: parsed.dataType };
                metaPlain[key] = parsed.value;
            });

            return { metaEntries, metaPlain, errors };
        }

        async function saveMemberMetaChangesPanel() {
            if (!currentDialogId || !currentMemberMetaEditingUserId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
                return;
            }

            const { metaEntries, metaPlain, errors } = collectMemberMetaRowsPanel();
            if (errors.length > 0) {
                setMemberMetaStatusPanel(errors[0], 'error');
                return;
            }

            const original = currentMemberMetaOriginal || {};
            const newKeys = Object.keys(metaEntries);
            const originalKeys = Object.keys(original);

            const updates = [];
            newKeys.forEach(key => {
                const entry = metaEntries[key];
                if (!Object.prototype.hasOwnProperty.call(original, key) || !valuesAreEqual(original[key], entry.value)) {
                    updates.push({
                        key,
                        value: entry.value,
                        dataType: entry.dataType
                    });
                }
            });

            const deletions = originalKeys.filter(key => !metaEntries[key]);

            if (updates.length === 0 && deletions.length === 0) {
                setMemberMetaStatusPanel('–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç', 'success');
                return;
            }

            const entityId = `${currentDialogId}:${currentMemberMetaEditingUserId}`;

            try {
                for (const update of updates) {
                    const response = await fetch(`/api/meta/dialogMember/${encodeURIComponent(entityId)}/${encodeURIComponent(update.key)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey,
                            'X-TENANT-ID': tenantId
                        },
                        body: JSON.stringify({
                            value: update.value,
                            dataType: update.dataType
                        })
                    });
                    if (!response.ok) {
                        const errorPayload = await safeParseJson(response);
                        const message = errorPayload?.message || `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–≥ "${update.key}"`;
                        throw new Error(message);
                    }
                }

                for (const key of deletions) {
                    const response = await fetch(`/api/meta/dialogMember/${encodeURIComponent(entityId)}/${encodeURIComponent(key)}`, {
                        method: 'DELETE',
                        headers: {
                            'X-API-Key': apiKey,
                            'X-TENANT-ID': tenantId
                        }
                    });
                    if (!response.ok) {
                        const errorPayload = await safeParseJson(response);
                        const message = errorPayload?.message || `–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "${key}"`;
                        throw new Error(message);
                    }
                }

                setMemberMetaStatusPanel('–ú–µ—Ç–∞-—Ç–µ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                await loadDialogMembersInPanel(currentDialogId);

                const updatedMember = currentDialogMembers.find(member => member.userId === currentMemberMetaEditingUserId);
                currentMemberMetaOriginal = deepClone(updatedMember?.meta || {});
                renderMemberMetaEditorPanel(currentMemberMetaOriginal);

                const select = document.getElementById('memberMetaSelectPanel');
                if (select) {
                    select.value = currentMemberMetaEditingUserId || '';
                }
            } catch (error) {
                console.error('Error saving member meta:', error);
                setMemberMetaStatusPanel(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Ç–∞-—Ç–µ–≥–æ–≤', 'error');
            }
        }

        function cancelMemberMetaEditingPanel() {
            if (!currentMemberMetaEditingUserId) {
                clearMemberMetaEditorPanel();
                return;
            }
            renderMemberMetaEditorPanel(currentMemberMetaOriginal);
            setMemberMetaStatusPanel('–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã', 'success');
        }

        function selectMemberFilterExamplePanel() {
            const select = document.getElementById('memberFilterExamplePanel');
            const input = document.getElementById('memberFilterInputPanel');

            if (select.value && select.value !== 'custom') {
                input.value = select.value;
                applyMemberFilterPanel();
            } else if (select.value === 'custom') {
                input.value = '';
                input.focus();
            }
        }

        function clearMemberFilterFieldPanel() {
            const input = document.getElementById('memberFilterInputPanel');
            const select = document.getElementById('memberFilterExamplePanel');
            if (input) {
                input.value = '';
            }
            if (select) {
                select.value = '';
            }
        }

        async function applyMemberFilterPanel() {
            if (!currentDialogId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥');
                return;
            }
            const input = document.getElementById('memberFilterInputPanel');
            const value = input ? input.value.trim() : '';
            currentMemberFilter = value;
            await loadDialogMembersInPanel(currentDialogId);
        }

        async function clearMemberFilterPanel() {
            if (!currentDialogId) {
                return;
            }
            currentMemberFilter = '';
            clearMemberFilterFieldPanel();
            await loadDialogMembersInPanel(currentDialogId);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –ø–∞–Ω–µ–ª–∏
        document.getElementById('addMemberFormPanel').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentDialogId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –¥–∏–∞–ª–æ–≥');
                return;
            }

            const userId = document.getElementById('newMemberSelectPanel').value;
            
            if (!userId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            try {
                const response = await fetch(`/api/dialogs/${currentDialogId}/members/${userId}/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Member added successfully:', result);
                
                alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥–∏–∞–ª–æ–≥!`);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('addMemberFormPanel').reset();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                await loadDialogMembersInPanel(currentDialogId);
                
            } catch (error) {
                console.error('Error adding member:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ${error.message}`);
            }
        });

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        function formatMessageTime(createdAt) {
            if (!createdAt) return '-';
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–æ–º –≤ —á–∏—Å–ª–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            const timestamp = typeof createdAt === 'string' ? parseFloat(createdAt) : createdAt;
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏–∞–ª–æ–≥–µ
        async function showDialogInfo(dialogId) {
            console.log('Show dialog info for:', dialogId);
            
            try {
                const response = await fetch(`/api/dialogs/${dialogId}`, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Dialog data:', data);

                if (data.data) {
                    showModal('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–∞–ª–æ–≥–µ: ' + data.data.name, formatDialogInfo(data.data));
                } else {
                    showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏–∞–ª–æ–≥–µ');
                }
            } catch (error) {
                console.error('Error loading dialog info:', error);
                showModal('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function showMessageInfo(messageId) {
            console.log('Show message info for:', messageId);
            
            if (!currentUserId) {
                showModal('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            if (!currentDialogId) {
                showModal('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showModal('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏–∏', '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ–æ–±—â–µ–Ω–∏–∏...</div>');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await fetch(`/api/users/${currentUserId}/dialogs/${currentDialogId}/messages/${messageId}`, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Message info response:', data);

                if (data.data) {
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
                    const jsonStr = JSON.stringify(data.data, null, 2);
                    showModal(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ (–∫–æ–Ω—Ç–µ–∫—Å—Ç: ${currentUserId})`, 
                        `<div style="max-height: 500px; overflow: auto;">
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; font-size: 12px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;">${jsonStr}</pre>
                        </div>`
                    );
                } else {
                    showModal('–û—à–∏–±–∫–∞', '–î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
            } catch (error) {
                console.error('Error loading message info:', error);
                showModal('–û—à–∏–±–∫–∞', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('infoModal').style.display = 'block';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å JSON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        async function showUserJsonModal(userId) {
            console.log('Show user JSON for:', userId);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showModal('JSON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>');
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('User JSON response:', data);

                if (data.data) {
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
                    const jsonStr = JSON.stringify(data.data, null, 2);
                    showModal(`JSON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${escapeHtml(userId)}`, 
                        `<div style="max-height: 500px; overflow: auto;">
                            <pre class="json-content">${escapeHtml(jsonStr)}</pre>
                        </div>`
                    );
                } else {
                    showModal('–û—à–∏–±–∫–∞', '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
            } catch (error) {
                console.error('Error loading user JSON:', error);
                showModal('–û—à–∏–±–∫–∞', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${escapeHtml(error.message)}`);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ç–µ–∫—É—â–µ–≥–æ URL –∑–∞–ø—Ä–æ—Å–∞
        function showCurrentUrl() {
            if (!currentUserId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            // –°—Ç—Ä–æ–∏–º URL –∑–∞–ø—Ä–æ—Å–∞
            let url = `/api/users/${currentUserId}/dialogs`;
            const params = new URLSearchParams();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            params.append('page', currentPage || 1);
            params.append('limit', 10);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            if (currentDialogFilter) {
                params.append('filter', currentDialogFilter);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            if (currentDialogSort) {
                params.append('sort', currentDialogSort);
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL
            const fullUrl = url + (params.toString() ? '?' + params.toString() : '');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            showModal('–¢–µ–∫—É—â–∏–π URL –∑–∞–ø—Ä–æ—Å–∞', `
                <div class="url-info">
                    <h4>API Endpoint:</h4>
                    <div class="url-display">${fullUrl}</div>
                    
                    <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</h4>
                    <div class="params-list">
                        <div><strong>page:</strong> ${currentPage || 1}</div>
                        <div><strong>limit:</strong> 10</div>
                        ${currentDialogFilter ? `<div><strong>filter:</strong> ${currentDialogFilter}</div>` : ''}
                        ${currentDialogSort ? `<div><strong>sort:</strong> ${currentDialogSort}</div>` : ''}
                    </div>
                    
                    <h4>–ü–æ–ª–Ω—ã–π URL –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:</h4>
                    <div class="url-copy">
                        <input type="text" value="${window.location.origin}${fullUrl}" readonly onclick="this.select()" style="width: 100%; padding: 8px; font-family: monospace; font-size: 12px;">
                        <button onclick="copyToClipboard('${window.location.origin}${fullUrl}')" style="margin-top: 8px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            `);
        }

        function showCurrentMessageUrl() {
            if (!currentDialogId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥');
                return;
            }
            
            if (!currentUserId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            // –°—Ç—Ä–æ–∏–º URL –∑–∞–ø—Ä–æ—Å–∞ (—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            let url = `/api/users/${currentUserId}/dialogs/${currentDialogId}/messages`;
            const params = new URLSearchParams();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            params.append('page', currentMessagePage || 1);
            params.append('limit', 10);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
            if (currentMessageFilter) {
                params.append('filter', currentMessageFilter);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
            if (currentMessageSort) {
                params.append('sort', currentMessageSort);
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL
            const fullUrl = url + (params.toString() ? '?' + params.toString() : '');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            showModal('–¢–µ–∫—É—â–∏–π URL –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏–π', `
                <div class="url-info">
                    <h4>API Endpoint:</h4>
                    <div class="url-display">${fullUrl}</div>
                    
                    <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</h4>
                    <div class="params-list">
                        <div><strong>page:</strong> ${currentMessagePage || 1}</div>
                        <div><strong>limit:</strong> 10</div>
                        ${currentMessageFilter ? `<div><strong>filter:</strong> ${currentMessageFilter}</div>` : ''}
                        ${currentMessageSort ? `<div><strong>sort:</strong> ${currentMessageSort}</div>` : ''}
                    </div>
                    
                    <h4>–ü–æ–ª–Ω—ã–π URL –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:</h4>
                    <div class="url-copy">
                        <input type="text" value="${window.location.origin}${fullUrl}" readonly onclick="this.select()" style="width: 100%; padding: 8px; font-family: monospace; font-size: 12px;">
                        <button onclick="copyToClipboard('${window.location.origin}${fullUrl}')" style="margin-top: 8px; padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            `);
        }

        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL');
            });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏–∞–ª–æ–≥–µ
        function formatDialogInfo(dialog) {
            return '<div class="json-content">' + JSON.stringify(dialog, null, 2) + '</div>';
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏
        function formatMessageInfo(message) {
            return '<div class="json-content">' + JSON.stringify(message, null, 2) + '</div>';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('infoModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ –∫–ª–∞–≤–∏—à–µ Esc
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('infoModal');
                if (modal.style.display === 'block') {
                    closeModal();
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–∏–∞–ª–æ–≥–æ–≤
        function selectFilterExample() {
            const select = document.getElementById('filterExample');
            const input = document.getElementById('filterValue');
            
            if (select.value && select.value !== 'custom') {
                input.value = select.value;
            } else if (select.value === 'custom') {
                input.value = '';
                input.focus();
            }
        }

        function selectUserFilterExample() {
            const select = document.getElementById('userFilterExample');
            const input = document.getElementById('userFilterInput');

            if (select.value && select.value !== 'custom') {
                input.value = select.value;
                applyUserFilter();
            } else if (select.value === 'custom') {
                input.value = '';
                input.focus();
            }
        }

        function clearUserFilterField() {
            const input = document.getElementById('userFilterInput');
            const select = document.getElementById('userFilterExample');
            input.value = '';
            if (select) {
                select.value = '';
            }
        }

        async function applyUserFilter() {
            const rawValue = document.getElementById('userFilterInput').value.trim();

            currentUserFilter = rawValue;
            await loadUsers();
        }

        async function clearUserFilter() {
            currentUserFilter = '';
            clearUserFilterField();
            await loadUsers();
        }

        function clearFilterField() {
            document.getElementById('filterValue').value = '';
            document.getElementById('filterExample').value = '';
        }

        async function applyFilter() {
            const filterValue = document.getElementById('filterValue').value.trim();
            
            if (!filterValue) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä');
                return;
            }

            if (!currentUserId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            currentDialogFilter = filterValue;
            currentPage = 1;
            await loadUserDialogs(currentUserId, 1);
        }

        async function clearFilter() {
            currentDialogFilter = null;
            currentDialogSort = null;
            document.getElementById('filterValue').value = '';
            document.getElementById('filterExample').value = '';
            
            // –°–±—Ä–æ—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '‚óÑ';
                indicator.classList.remove('active');
            });
            
            if (currentUserId) {
                currentPage = 1;
                await loadUserDialogs(currentUserId, 1);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function getSortIndicator(field) {
            if (!currentDialogSort || !currentDialogSort.includes(field)) {
                return '‚óÑ';
            } else if (currentDialogSort.includes('asc')) {
                return '‚ñ≤';
            } else {
                return '‚ñº';
            }
        }

        function getMessageSortIndicator(field) {
            if (!currentMessageSort || !currentMessageSort.includes(field)) {
                return '‚óÑ';
            } else if (currentMessageSort.includes('asc')) {
                return '‚ñ≤';
            } else {
                return '‚ñº';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        async function toggleSort(field) {
            if (!currentUserId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            let newSort = null;
            const indicator = document.getElementById(`sort-${field}`);
            
            if (!currentDialogSort || !currentDialogSort.includes(field)) {
                // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
                newSort = `(${field},asc)`;
                indicator.textContent = '‚ñ≤';
                indicator.classList.add('active');
            } else if (currentDialogSort.includes('asc')) {
                // –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫ - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                newSort = `(${field},desc)`;
                indicator.textContent = '‚ñº';
                indicator.classList.add('active');
            } else {
                // –¢—Ä–µ—Ç–∏–π –∫–ª–∏–∫ - —Å–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                newSort = null;
                indicator.textContent = '‚óÑ';
                indicator.classList.remove('active');
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
            document.querySelectorAll('.sort-indicator').forEach(ind => {
                if (ind.id !== `sort-${field}`) {
                    ind.textContent = '‚óÑ';
                    ind.classList.remove('active');
                }
            });

            currentDialogSort = newSort;
            currentPage = 1;
            await loadUserDialogs(currentUserId, 1);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function toggleMessageSort(field) {
            if (!currentDialogId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥');
                return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            let newSort = null;
            const indicator = document.getElementById(`sort-message-${field}`);
            
            if (!currentMessageSort || !currentMessageSort.includes(field)) {
                // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
                newSort = `(${field},asc)`;
                indicator.textContent = '‚ñ≤';
                indicator.classList.add('active');
            } else if (currentMessageSort.includes('asc')) {
                // –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫ - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                newSort = `(${field},desc)`;
                indicator.textContent = '‚ñº';
                indicator.classList.add('active');
            } else {
                // –¢—Ä–µ—Ç–∏–π –∫–ª–∏–∫ - —Å–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                newSort = null;
                indicator.textContent = '‚óÑ';
                indicator.classList.remove('active');
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
            document.querySelectorAll('.sort-indicator').forEach(ind => {
                if (ind.id.startsWith('sort-message-') && ind.id !== `sort-message-${field}`) {
                    ind.textContent = '‚óÑ';
                    ind.classList.remove('active');
                }
            });

            currentMessageSort = newSort;
            currentMessagePage = 1;
            await loadDialogMessages(currentDialogId, 1);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞)
            const urlParams = getUrlParams();
            if (urlParams.apiKey) {
                setApiKeyFromExternal(urlParams.apiKey, urlParams.tenantId);
            } else {
                console.warn('API Key –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö. –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—á–∞ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞.');
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'setApiCredentials') {
                    const extApiKey = event.data.apiKey;
                    const extTenantId = event.data.tenantId;
                    if (extApiKey) {
                        setApiKeyFromExternal(extApiKey, extTenantId);
                    }
                }
            });

            const userFilterInput = document.getElementById('userFilterInput');
            if (userFilterInput) {
                userFilterInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        applyUserFilter();
                    }
                });
            }
            const memberFilterInput = document.getElementById('memberFilterInput');
            if (memberFilterInput) {
                memberFilterInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        applyMemberFilter();
                    }
                });
            }
        });
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        function selectMessageFilterExample() {
            const select = document.getElementById('messageFilterExample');
            const input = document.getElementById('messageFilterInput');
            
            if (select.value && select.value !== '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä') {
                input.value = select.value;
            }
        }

        function clearMessageFilterField() {
            const input = document.getElementById('messageFilterInput');
            input.value = '';
        }

        function applyMessageFilter() {
            const input = document.getElementById('messageFilterInput');
            const filterValue = input.value.trim();
            
            if (filterValue && currentDialogId) {
                currentMessageFilter = filterValue;
                currentMessagePage = 1;
                loadDialogMessages(currentDialogId, 1);
            }
        }

        function clearMessageFilter() {
            const input = document.getElementById('messageFilterInput');
            const select = document.getElementById('messageFilterExample');
            
            input.value = '';
            select.value = '';
            currentMessageFilter = null;
            currentMessageSort = null;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            document.querySelectorAll('.sort-indicator').forEach(ind => {
                if (ind.id.startsWith('sort-message-')) {
                    ind.textContent = '‚óÑ';
                    ind.classList.remove('active');
                }
            });
            
            if (currentDialogId) {
                currentMessagePage = 1;
                loadDialogMessages(currentDialogId, 1);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        let currentDialogIdForMessage = null;
        let currentDialogNameForMessage = null;

        function showAddMessageModal(dialogId, dialogName) {
            currentDialogIdForMessage = dialogId;
            currentDialogNameForMessage = dialogName;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.querySelector('#addMessageModal .modal-title').textContent = `–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ "${dialogName}"`;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('addMessageForm').reset();
            document.getElementById('messageContent').value = '—Ç–µ—Å—Ç —Ç–µ—Å—Ç';
            document.getElementById('quotedMessageId').value = '';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–µ—Ç–∞-—Ç–µ–≥–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É)
            const container = document.getElementById('metaTagsContainer');
            container.innerHTML = `
                <div class="meta-tag-row">
                    <input type="text" class="meta-key" placeholder="–ö–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä: channelType)" pattern="[a-zA-Z0-9_]+" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ">
                    <input type="text" class="meta-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: whatsapp)">
                    <button type="button" class="remove-meta-btn" onclick="removeMetaTagRow(this)" style="display: none;">‚úï</button>
                </div>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('addMessageModal').style.display = 'block';
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ –ø–æ–ª—è–º –º–µ—Ç–∞-—Ç–µ–≥–æ–≤
            setTimeout(() => {
                attachMetaTagHandlers();
                updatePayloadJson();
            }, 0);
        }

        function closeAddMessageModal() {
            document.getElementById('addMessageModal').style.display = 'none';
            currentDialogIdForMessage = null;
            currentDialogNameForMessage = null;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ç–∞-—Ç–µ–≥–∞–º–∏
        function addMetaTagRow() {
            const container = document.getElementById('metaTagsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'meta-tag-row';
            newRow.innerHTML = `
                <input type="text" class="meta-key" placeholder="–ö–ª—é—á (–Ω–∞–ø—Ä–∏–º–µ—Ä: channelType)" pattern="[a-zA-Z0-9_]+" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ">
                <input type="text" class="meta-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: whatsapp)">
                <button type="button" class="remove-meta-btn" onclick="removeMetaTagRow(this)">‚úï</button>
            `;
            container.appendChild(newRow);
            updateRemoveButtons();
            attachMetaTagHandlers();
            updatePayloadJson();
        }

        function removeMetaTagRow(button) {
            const row = button.closest('.meta-tag-row');
            row.remove();
            updateRemoveButtons();
            updatePayloadJson();
        }

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.meta-tag-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-meta-btn');
                if (rows.length === 1) {
                    removeBtn.style.display = 'none';
                } else {
                    removeBtn.style.display = 'block';
                }
            });
        }

        function collectMetaTags() {
            const metaTags = {};
            const rows = document.querySelectorAll('.meta-tag-row');
            
            rows.forEach(row => {
                const keyInput = row.querySelector('.meta-key');
                const valueInput = row.querySelector('.meta-value');
                
                if (keyInput.value.trim() && valueInput.value.trim()) {
                    metaTags[keyInput.value.trim()] = valueInput.value.trim();
                }
            });
            
            return Object.keys(metaTags).length > 0 ? metaTags : null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è JSON payload
        function updatePayloadJson() {
            const senderId = document.getElementById('messageSender')?.value || '';
            const type = document.getElementById('messageType')?.value || '';
            const content = document.getElementById('messageContent')?.value || '';
            const quotedMessageId = document.getElementById('quotedMessageId')?.value?.trim() || '';
            const meta = collectMetaTags();
            
            const payload = {
                senderId: senderId,
                type: type,
                content: content
            };
            
            if (quotedMessageId) {
                payload.quotedMessageId = quotedMessageId;
            }
            
            if (meta) {
                payload.meta = meta;
            }
            
            const payloadJson = document.getElementById('payloadJson');
            if (payloadJson) {
                payloadJson.textContent = JSON.stringify(payload, null, 2);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫ –ø–æ–ª—è–º –º–µ—Ç–∞-—Ç–µ–≥–æ–≤
        function attachMetaTagHandlers() {
            const metaKeys = document.querySelectorAll('.meta-key');
            const metaValues = document.querySelectorAll('.meta-value');
            
            metaKeys.forEach(input => {
                if (!input.hasAttribute('data-handler-attached')) {
                    input.addEventListener('input', updatePayloadJson);
                    input.setAttribute('data-handler-attached', 'true');
                }
            });
            
            metaValues.forEach(input => {
                if (!input.hasAttribute('data-handler-attached')) {
                    input.addEventListener('input', updatePayloadJson);
                    input.setAttribute('data-handler-attached', 'true');
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('addMessageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentDialogIdForMessage) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –¥–∏–∞–ª–æ–≥');
                return;
            }

            const senderId = document.getElementById('messageSender').value;
            const type = document.getElementById('messageType').value;
            const content = document.getElementById('messageContent').value;
            const meta = collectMetaTags();

            try {
                const payload = {
                    senderId: senderId,
                    type: type,
                    content: content
                };
                
                const quotedMessageId = document.getElementById('quotedMessageId')?.value?.trim();
                if (quotedMessageId) {
                    payload.quotedMessageId = quotedMessageId;
                }
                
                if (meta) {
                    payload.meta = meta;
                }
                
                const response = await fetch(`/api/dialogs/${currentDialogIdForMessage}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Message added successfully:', result);
                
                alert('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º dialogId –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const dialogIdToRefresh = currentDialogIdForMessage;
                closeAddMessageModal();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç
                if (currentDialogId === dialogIdToRefresh) {
                    loadDialogMessages(currentDialogId, currentMessagePage);
                }
                
            } catch (error) {
                console.error('Error adding message:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error.message}`);
            }
        });

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ messageId –¥–ª—è —Ä–µ–∞–∫—Ü–∏–∏
        let currentMessageIdForReaction = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∞–∫—Ü–∏–π
        async function loadExistingReactions(messageId) {
            const reactionsList = document.getElementById('existingReactionsList');
            
            try {
                const response = await fetch(`/api/messages/${messageId}/reactions`, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const reactions = data.data?.reactions || [];
                
                if (reactions.length === 0) {
                    reactionsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">–†–µ–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–∫—Ü–∏–π
                reactionsList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="text-align: left; padding: 8px; color: #495057; font-weight: 600;">–†–µ–∞–∫—Ü–∏—è</th>
                                <th style="text-align: left; padding: 8px; color: #495057; font-weight: 600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th style="text-align: left; padding: 8px; color: #495057; font-weight: 600;">–í—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reactions.map(reaction => `
                                <tr style="border-bottom: 1px solid #e9ecef;">
                                    <td style="padding: 8px; font-size: 20px;">${reaction.reaction}</td>
                                    <td style="padding: 8px; color: #495057;">${reaction.userId}</td>
                                    <td style="padding: 8px; color: #6c757d; font-size: 12px;">${formatMessageTime(reaction.createdAt)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading reactions:', error);
                reactionsList.innerHTML = `<div style="color: #dc3545; padding: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–∫—Ü–∏–π: ${error.message}</div>`;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏
        async function showReactionModal(messageId) {
            currentMessageIdForReaction = messageId;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('reactionUser').value = 'carl';
            document.getElementById('selectedReaction').value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('reactionModal').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
            await loadExistingReactions(messageId);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–∞–∫—Ü–∏–π
        function closeReactionModal() {
            document.getElementById('reactionModal').style.display = 'none';
            currentMessageIdForReaction = null;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
        async function addReaction(reaction) {
            if (!currentMessageIdForReaction) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }

            const userId = document.getElementById('reactionUser').value;

            if (!userId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            if (!reaction) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∞–∫—Ü–∏—é');
                return;
            }

            try {
                const response = await fetch(`/api/messages/${currentMessageIdForReaction}/reactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    },
                    body: JSON.stringify({
                        userId: userId,
                        reaction: reaction
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Reaction added:', data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–∫—Ü–∏–π
                await loadExistingReactions(currentMessageIdForReaction);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç
                if (currentDialogId) {
                    loadDialogMessages(currentDialogId, currentMessagePage);
                }
                
            } catch (error) {
                console.error('Error adding reaction:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏: ${error.message}`);
            }
        }

        // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è =====
        let currentMessageIdForEvents = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è
        async function loadMessageEvents(messageId) {
            const eventsList = document.getElementById('eventsList');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º messageId –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–∞—Ö
            const currentMsgId = messageId;
            
            try {
                eventsList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>';

                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ –≤–æ–∑–º–æ–∂–Ω—ã–π endpoint
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è:', messageId);
                console.log('API Key:', apiKey ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                console.log('Tenant ID:', tenantId);
                
                const url = `/api/messages/${messageId}/events?tenantId=${encodeURIComponent(tenantId)}`;
                console.log('–ó–∞–ø—Ä–æ—Å –∫:', url);
                
                let response;
                try {
                    // –ü—Ä–æ–±—É–µ–º endpoint –¥–ª—è —Å–æ–±—ã—Ç–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è (control-api)
                    response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-Tenant-Id': tenantId
                        }
                    });
                    
                    console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);
                } catch (err) {
                    // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ CORS
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å–æ–±—ã—Ç–∏–π:', err);
                    eventsList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–±—ã—Ç–∏–π</p>
                            <p style="font-size: 12px; color: #999;">${err.message}</p>
                            <p style="font-size: 12px; color: #999; margin-top: 10px;">
                                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                            </p>
                        </div>
                    `;
                    return;
                }

                if (!response.ok) {
                    let errorMessage = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || '';
                        console.error('–û—à–∏–±–∫–∞ API:', errorData);
                    } catch (e) {
                        const text = await response.text();
                        console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', text);
                        errorMessage = text || `HTTP ${response.status}`;
                    }
                    
                    if (response.status === 404) {
                        // Endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                        eventsList.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <p style="margin-bottom: 10px;">‚ö†Ô∏è –°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                <p style="font-size: 12px; color: #999;">${errorMessage || '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'}</p>
                                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                                    URL –∑–∞–ø—Ä–æ—Å–∞: <code>${url}</code><br>
                                    –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}
                                </p>
                                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                                    –ï—Å–ª–∏ endpoint –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ AdminJS –ø–∞–Ω–µ–ª—å.<br>
                                    –°–æ–±—ã—Ç–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ <strong>Event</strong> —Å —Ñ–∏–ª—å—Ç—Ä–æ–º:<br>
                                    <code>entityType: "message"</code> –∏ <code>entityId: "${messageId}"</code>
                                </p>
                            </div>
                        `;
                        return;
                    }
                    
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    eventsList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</p>
                            <p style="font-size: 12px; color: #999;">–°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}</p>
                            <p style="font-size: 12px; color: #999;">${errorMessage}</p>
                            <p style="font-size: 12px; color: #999; margin-top: 10px;">
                                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                            </p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                const events = Array.isArray(data.data) ? data.data : (Array.isArray(data.events) ? data.events : []);

                if (events.length === 0) {
                    eventsList.innerHTML = '<div class="no-data" style="padding: 20px; text-align: center; color: #6c757d;">–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
                function getEventDescription(eventType, data) {
                    const descriptions = {
                        'dialog.create': '–°–æ–∑–¥–∞–Ω –¥–∏–∞–ª–æ–≥',
                        'dialog.update': '–û–±–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ª–æ–≥',
                        'dialog.delete': '–£–¥–∞–ª–µ–Ω –¥–∏–∞–ª–æ–≥',
                        'message.create': '–°–æ–∑–¥–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.update': '–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.delete': '–£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'dialog.member.add': '–î–æ–±–∞–≤–ª–µ–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞',
                        'dialog.member.remove': '–£–¥–∞–ª–µ–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞',
                        'dialog.member.update': '–û–±–Ω–æ–≤–ª–µ–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞',
                        'message.status.create': '–°–æ–∑–¥–∞–Ω —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è',
                        'message.status.update': '–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è',
                        'message.reaction.add': '–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.reaction.update': '–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.reaction.remove': '–£–¥–∞–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'dialog.typing': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–µ',
                        'tenant.create': '–°–æ–∑–¥–∞–Ω tenant',
                        'tenant.update': '–û–±–Ω–æ–≤–ª–µ–Ω tenant',
                        'tenant.delete': '–£–¥–∞–ª–µ–Ω tenant'
                    };
                    
                    let description = descriptions[eventType] || eventType;
                    
                    // –î–æ–ø–æ–ª–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ data, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (data) {
                        if (data.message && data.message.content) {
                            description += `: "${data.message.content.substring(0, 50)}${data.message.content.length > 50 ? '...' : ''}"`;
                        } else if (data.member && data.member.userId) {
                            description += `: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.member.userId}`;
                        } else if (data.statusUpdate && data.statusUpdate.status) {
                            description += `: —Å—Ç–∞—Ç—É—Å "${data.statusUpdate.status}"`;
                        } else if (data.reactionUpdate && data.reactionUpdate.reaction) {
                            description += `: —Ä–µ–∞–∫—Ü–∏—è "${data.reactionUpdate.reaction}"`;
                        }
                    }
                    
                    return description;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —É–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç API (event.updatesCount)
                eventsList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 15%;">–í—Ä–µ–º—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 35%;">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 25%;">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 25%;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${events.map((event) => {
                                const eventTime = event.createdAt 
                                    ? (typeof event.createdAt === 'number' 
                                        ? new Date(event.createdAt).toLocaleString('ru-RU')
                                        : new Date(event.createdAt).toLocaleString('ru-RU'))
                                    : '-';
                                
                                const eventDescription = getEventDescription(event.eventType, event.data);
                                const eventName = event.eventType || '-';
                                const updatesCount = event.updatesCount !== undefined ? event.updatesCount : null;
                                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º _id –≤ —Å—Ç—Ä–æ–∫—É (–º–æ–∂–µ—Ç –±—ã—Ç—å ObjectId –æ–±—ä–µ–∫—Ç–æ–º)
                                let eventId = null;
                                if (event._id) {
                                    if (typeof event._id === 'object') {
                                        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç ObjectId, –∏—Å–ø–æ–ª—å–∑—É–µ–º toString() –∏–ª–∏ $oid
                                        if (event._id.toString && typeof event._id.toString === 'function') {
                                            eventId = event._id.toString();
                                        } else if (event._id.$oid) {
                                            eventId = event._id.$oid;
                                        } else {
                                            eventId = String(event._id);
                                        }
                                    } else {
                                        eventId = String(event._id);
                                    }
                                } else if (event.id) {
                                    eventId = String(event.id);
                                }
                                eventId = eventId ? eventId.trim() : null;
                                
                                let updatesInfo;
                                if (updatesCount !== null && updatesCount !== undefined && updatesCount > 0 && eventId) {
                                    updatesInfo = `<button class="action-button updates-button" onclick="loadEventUpdates('${escapeHtml(eventId)}', '${escapeHtml(currentMsgId)}')" style="padding: 5px 10px; font-size: 12px;">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>`;
                                } else if (updatesCount === 0) {
                                    updatesInfo = '<span style="color: #999; font-size: 12px;">–ù–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</span>';
                                } else {
                                    updatesInfo = '<span style="color: #999; font-size: 12px;">-</span>';
                                }
                                
                                return `
                                    <tr data-event-id="${eventId || ''}" class="event-row" style="border-bottom: 1px solid #e9ecef; cursor: ${updatesCount > 0 ? 'pointer' : 'default'};">
                                        <td style="padding: 10px; color: #6c757d; font-size: 12px; vertical-align: top;">${eventTime}</td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span>${escapeHtml(eventDescription)}</span>
                                            ${event.actorId ? `<br><span style="color: #6c757d; font-size: 11px;">–ê–∫—Ç–æ—Ä: ${escapeHtml(event.actorId)}${event.actorType ? ` (${escapeHtml(event.actorType)})` : ''}</span>` : ''}
                                        </td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span style="font-weight: 500; font-family: monospace; font-size: 12px;">${escapeHtml(eventName)}</span>
                                        </td>
                                        <td style="padding: 10px; vertical-align: top;">
                                            ${updatesInfo}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading events:', error);
                eventsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π: ${error.message}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.<br>
                            –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ AdminJS –ø–∞–Ω–µ–ª—å (–∫–æ–ª–ª–µ–∫—Ü–∏—è <strong>Event</strong>).
                        </p>
                    </div>
                `;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π
        async function showEventsModal(messageId) {
            currentMessageIdForEvents = messageId;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            const eventUpdatesTitle = document.getElementById('eventUpdatesTitle');
            if (eventUpdatesTitle) {
                eventUpdatesTitle.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('eventsModal').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è
            await loadMessageEvents(messageId);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–±—ã—Ç–∏–π
        function closeEventsModal() {
            document.getElementById('eventsModal').style.display = 'none';
            currentMessageIdForEvents = null;
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
            const previouslySelected = document.querySelector('.event-row-selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('event-row-selected');
            }
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è"
            const eventUpdatesTitle = document.getElementById('eventUpdatesTitle');
            if (eventUpdatesTitle) {
                eventUpdatesTitle.style.display = 'none';
            }
            // –û—á–∏—â–∞–µ–º –ø—Ä–∞–≤—É—é –∫–æ–ª–æ–Ω–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            const eventUpdatesList = document.getElementById('eventUpdatesList');
            if (eventUpdatesList) {
                eventUpdatesList.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;"><p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p></div>';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
        async function loadEventUpdates(eventId, messageId) {
            const eventUpdatesList = document.getElementById('eventUpdatesList');
            const eventUpdatesTitle = document.getElementById('eventUpdatesTitle');
            
            if (!eventUpdatesList) {
                console.error('eventUpdatesList element not found');
                return;
            }
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
            const previouslySelected = document.querySelector('.event-row-selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('event-row-selected');
            }
            
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
            const eventRow = document.querySelector(`tr[data-event-id="${eventId}"]`);
            if (eventRow) {
                eventRow.classList.add('event-row-selected');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è" –≤ modal-header
            if (eventUpdatesTitle) {
                eventUpdatesTitle.style.display = 'block';
            }
            
            try {
                eventUpdatesList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>';

                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ–±—ã—Ç–∏—è:', eventId, '—Å–æ–æ–±—â–µ–Ω–∏—è:', messageId);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                const url = `/api/messages/${messageId}/updates?tenantId=${encodeURIComponent(tenantId)}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Tenant-Id': tenantId
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || '';
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}`;
                    }
                    
                    eventUpdatesList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p>
                            <p style="font-size: 12px; color: #999;">${errorMessage}</p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                const allUpdates = Array.isArray(data.data) ? data.data : [];
                
                console.log('–í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', allUpdates.length);
                console.log('–ò—â–µ–º eventId:', eventId);
                console.log('–¢–∏–ø eventId:', typeof eventId);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ eventId
                // eventId –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ ObjectId, –Ω—É–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏
                const eventIdStr = String(eventId).trim();
                
                // –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ eventId –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                if (allUpdates.length > 0) {
                    console.log('–ü—Ä–∏–º–µ—Ä—ã eventId –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:');
                    allUpdates.slice(0, 3).forEach((update, idx) => {
                        console.log(`  Update ${idx}:`, update.eventId, '—Ç–∏–ø:', typeof update.eventId);
                    });
                }
                
                const filteredUpdates = allUpdates.filter(update => {
                    if (!update.eventId) {
                        console.log('Update –±–µ–∑ eventId:', update);
                        return false;
                    }
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º eventId –≤ —Å—Ç—Ä–æ–∫—É (–º–æ–∂–µ—Ç –±—ã—Ç—å ObjectId –æ–±—ä–µ–∫—Ç–æ–º)
                    let updateEventId;
                    if (typeof update.eventId === 'object') {
                        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç ObjectId, –∏—Å–ø–æ–ª—å–∑—É–µ–º toString() –∏–ª–∏ $oid
                        if (update.eventId.toString) {
                            updateEventId = update.eventId.toString().trim();
                        } else if (update.eventId.$oid) {
                            updateEventId = update.eventId.$oid.trim();
                        } else {
                            updateEventId = String(update.eventId).trim();
                        }
                    } else {
                        updateEventId = String(update.eventId).trim();
                    }
                    
                    const matches = updateEventId === eventIdStr;
                    if (!matches && allUpdates.length <= 10) {
                        console.log(`–ù–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç: –∏—â–µ–º "${eventIdStr}", –Ω–∞–π–¥–µ–Ω–æ "${updateEventId}"`);
                    }
                    return matches;
                });

                console.log('–ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ–±—ã—Ç–∏—è:', filteredUpdates.length);

                if (filteredUpdates.length === 0) {
                    eventUpdatesList.innerHTML = `
                        <div class="no-data" style="padding: 20px; text-align: center; color: #6c757d;">
                            <p>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p style="font-size: 11px; color: #999; margin-top: 10px;">
                                –í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è: ${allUpdates.length}<br>
                                –ò—Å–∫–æ–º—ã–π eventId: ${eventIdStr}<br>
                                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                            </p>
                        </div>
                    `;
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                eventUpdatesList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 20%;">–í—Ä–µ–º—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUpdates.map((update) => {
                                const updateTime = update.createdAt 
                                    ? (typeof update.createdAt === 'number' 
                                        ? new Date(update.createdAt).toLocaleString('ru-RU')
                                        : new Date(update.createdAt).toLocaleString('ru-RU'))
                                    : '-';
                                
                                const eventType = update.eventType || '-';
                                const userId = update.userId || '-';
                                
                                return `
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 10px; color: #6c757d; font-size: 12px; vertical-align: top;">${updateTime}</td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span style="font-weight: 500; font-family: monospace; font-size: 12px;">${escapeHtml(eventType)}</span>
                                        </td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span>${escapeHtml(userId)}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading event updates:', error);
                eventUpdatesList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${error.message}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                        </p>
                    </div>
                `;
            }
        }

        // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è =====
        let currentMessageIdForUpdates = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è
        async function loadMessageUpdates(messageId) {
            const updatesList = document.getElementById('updatesList');
            
            try {
                updatesList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>';

                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è:', messageId);
                console.log('API Key:', apiKey ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                console.log('Tenant ID:', tenantId);
                
                const url = `/api/messages/${messageId}/updates?tenantId=${encodeURIComponent(tenantId)}`;
                console.log('–ó–∞–ø—Ä–æ—Å –∫:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Tenant-Id': tenantId
                    }
                });
                
                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || '';
                        console.error('–û—à–∏–±–∫–∞ API:', errorData);
                    } catch (e) {
                        const text = await response.text();
                        console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', text);
                        errorMessage = text || `HTTP ${response.status}`;
                    }
                    
                    updatesList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p>
                            <p style="font-size: 12px; color: #999;">–°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}</p>
                            <p style="font-size: 12px; color: #999;">${errorMessage}</p>
                            <p style="font-size: 12px; color: #999; margin-top: 10px;">
                                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                            </p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                const updates = Array.isArray(data.data) ? data.data : [];

                if (updates.length === 0) {
                    updatesList.innerHTML = '<div class="no-data" style="padding: 20px; text-align: center; color: #6c757d;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                updatesList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 20%;">–í—Ä–µ–º—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${updates.map((update) => {
                                const updateTime = update.createdAt 
                                    ? (typeof update.createdAt === 'number' 
                                        ? new Date(update.createdAt).toLocaleString('ru-RU')
                                        : new Date(update.createdAt).toLocaleString('ru-RU'))
                                    : '-';
                                
                                const eventType = update.eventType || '-';
                                const userId = update.userId || '-';
                                
                                return `
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 10px; color: #6c757d; font-size: 12px; vertical-align: top;">${updateTime}</td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span style="font-weight: 500; font-family: monospace; font-size: 12px;">${escapeHtml(eventType)}</span>
                                        </td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span>${escapeHtml(userId)}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading updates:', error);
                updatesList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${error.message}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                        </p>
                    </div>
                `;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        async function showUpdatesModal(messageId) {
            currentMessageIdForUpdates = messageId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('updatesModal').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            await loadMessageUpdates(messageId);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        function closeUpdatesModal() {
            document.getElementById('updatesModal').style.display = 'none';
            currentMessageIdForUpdates = null;
        }

        // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–∞ =====
        let currentDialogIdForEvents = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–∏–∞–ª–æ–≥–∞
        async function loadDialogEvents(dialogId) {
            const eventsList = document.getElementById('dialogEventsList');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º dialogId –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–∞—Ö
            const currentDlgId = dialogId;
            
            try {
                eventsList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>';

                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:', dialogId);
                console.log('API Key:', apiKey ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                console.log('Tenant ID:', tenantId);
                
                const url = `/api/dialogs/${dialogId}/events?tenantId=${encodeURIComponent(tenantId)}`;
                console.log('–ó–∞–ø—Ä–æ—Å –∫:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Tenant-Id': tenantId
                    }
                });
                
                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || '';
                        console.error('–û—à–∏–±–∫–∞ API:', errorData);
                    } catch (e) {
                        const text = await response.text();
                        console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', text);
                        errorMessage = text || `HTTP ${response.status}`;
                    }
                    
                    if (response.status === 404) {
                        eventsList.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <p style="margin-bottom: 10px;">‚ö†Ô∏è –°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                <p style="font-size: 12px; color: #999;">${errorMessage || '–î–∏–∞–ª–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    eventsList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</p>
                            <p style="font-size: 12px; color: #999;">–°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}</p>
                            <p style="font-size: 12px; color: #999;">${errorMessage}</p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                const events = Array.isArray(data.data) ? data.data : [];

                if (events.length === 0) {
                    eventsList.innerHTML = '<div class="no-data" style="padding: 20px; text-align: center; color: #6c757d;">–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
                function getEventDescription(eventType, data) {
                    const descriptions = {
                        'dialog.create': '–°–æ–∑–¥–∞–Ω –¥–∏–∞–ª–æ–≥',
                        'dialog.update': '–û–±–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ª–æ–≥',
                        'dialog.delete': '–£–¥–∞–ª–µ–Ω –¥–∏–∞–ª–æ–≥',
                        'dialog.member.add': '–î–æ–±–∞–≤–ª–µ–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞',
                        'dialog.member.remove': '–£–¥–∞–ª–µ–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞',
                        'dialog.member.update': '–û–±–Ω–æ–≤–ª–µ–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞',
                        'message.create': '–°–æ–∑–¥–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.update': '–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.delete': '–£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.status.create': '–°–æ–∑–¥–∞–Ω —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è',
                        'message.status.update': '–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è',
                        'message.reaction.add': '–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.reaction.update': '–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'message.reaction.remove': '–£–¥–∞–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                        'dialog.typing': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç –≤ –¥–∏–∞–ª–æ–≥–µ',
                        'tenant.create': '–°–æ–∑–¥–∞–Ω tenant',
                        'tenant.update': '–û–±–Ω–æ–≤–ª–µ–Ω tenant',
                        'tenant.delete': '–£–¥–∞–ª–µ–Ω tenant'
                    };
                    
                    let description = descriptions[eventType] || eventType;
                    
                    // –î–æ–ø–æ–ª–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ data, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (data) {
                        if (data.message && data.message.content) {
                            description += `: "${data.message.content.substring(0, 50)}${data.message.content.length > 50 ? '...' : ''}"`;
                        } else if (data.member && data.member.userId) {
                            description += `: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.member.userId}`;
                        } else if (data.dialog && data.dialog.name) {
                            description += `: "${data.dialog.name}"`;
                        }
                    }
                    
                    return description;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                eventsList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 15%;">–í—Ä–µ–º—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 35%;">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 25%;">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 25%;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${events.map((event) => {
                                const eventTime = event.createdAt 
                                    ? (typeof event.createdAt === 'number' 
                                        ? new Date(event.createdAt).toLocaleString('ru-RU')
                                        : new Date(event.createdAt).toLocaleString('ru-RU'))
                                    : '-';
                                
                                const eventDescription = getEventDescription(event.eventType, event.data);
                                const eventName = event.eventType || '-';
                                const updatesCount = event.updatesCount !== undefined ? event.updatesCount : null;
                                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º _id –≤ —Å—Ç—Ä–æ–∫—É (–º–æ–∂–µ—Ç –±—ã—Ç—å ObjectId –æ–±—ä–µ–∫—Ç–æ–º)
                                let eventId = null;
                                if (event._id) {
                                    if (typeof event._id === 'object') {
                                        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç ObjectId, –∏—Å–ø–æ–ª—å–∑—É–µ–º toString() –∏–ª–∏ $oid
                                        if (event._id.toString && typeof event._id.toString === 'function') {
                                            eventId = event._id.toString();
                                        } else if (event._id.$oid) {
                                            eventId = event._id.$oid;
                                        } else {
                                            eventId = String(event._id);
                                        }
                                    } else {
                                        eventId = String(event._id);
                                    }
                                } else if (event.id) {
                                    eventId = String(event.id);
                                }
                                eventId = eventId ? eventId.trim() : null;
                                
                                let updatesInfo;
                                if (updatesCount !== null && updatesCount !== undefined && updatesCount > 0 && eventId) {
                                    updatesInfo = `<button class="action-button updates-button" onclick="loadAllDialogUpdatesInModal('${escapeHtml(currentDlgId)}', '${escapeHtml(eventId)}')" style="padding: 5px 10px; font-size: 12px;">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>`;
                                } else if (updatesCount === 0) {
                                    updatesInfo = '<span style="color: #999; font-size: 12px;">–ù–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</span>';
                                } else {
                                    updatesInfo = '<span style="color: #999; font-size: 12px;">-</span>';
                                }
                                
                                return `
                                    <tr data-event-id="${eventId || ''}" class="event-row" style="border-bottom: 1px solid #e9ecef; cursor: ${updatesCount > 0 ? 'pointer' : 'default'};">
                                        <td style="padding: 10px; color: #6c757d; font-size: 12px; vertical-align: top;">${eventTime}</td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span>${escapeHtml(eventDescription)}</span>
                                            ${event.actorId ? `<br><span style="color: #6c757d; font-size: 11px;">–ê–∫—Ç–æ—Ä: ${escapeHtml(event.actorId)}${event.actorType ? ` (${escapeHtml(event.actorType)})` : ''}</span>` : ''}
                                        </td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span style="font-weight: 500; font-family: monospace; font-size: 12px;">${escapeHtml(eventName)}</span>
                                        </td>
                                        <td style="padding: 10px; vertical-align: top;">
                                            ${updatesInfo}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading dialog events:', error);
                eventsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π: ${error.message}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                        </p>
                    </div>
                `;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π –¥–∏–∞–ª–æ–≥–∞
        async function showDialogEventsModal(dialogId) {
            currentDialogIdForEvents = dialogId;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            const dialogEventUpdatesTitle = document.getElementById('dialogEventUpdatesTitle');
            if (dialogEventUpdatesTitle) {
                dialogEventUpdatesTitle.style.display = 'none';
            }
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–∞–≤—É—é –∫–æ–ª–æ–Ω–∫—É
            const dialogEventUpdatesList = document.getElementById('dialogEventUpdatesList');
            if (dialogEventUpdatesList) {
                dialogEventUpdatesList.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;"><p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p></div>';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('dialogEventsModal').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è
            await loadDialogEvents(dialogId);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞ –≤–æ –≤—Ç–æ—Ä—É—é –∫–æ–ª–æ–Ω–∫—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–±—ã—Ç–∏–π
        async function loadAllDialogUpdatesInModal(dialogId, eventId) {
            const dialogEventUpdatesList = document.getElementById('dialogEventUpdatesList');
            const dialogEventUpdatesTitle = document.getElementById('dialogEventUpdatesTitle');
            
            if (!dialogEventUpdatesList) {
                console.error('dialogEventUpdatesList element not found');
                return;
            }
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
            const previouslySelected = document.querySelector('#dialogEventsList .event-row-selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('event-row-selected');
            }
            
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
            if (eventId) {
                const eventRow = document.querySelector(`#dialogEventsList tr[data-event-id="${eventId}"]`);
                if (eventRow) {
                    eventRow.classList.add('event-row-selected');
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞"
            if (dialogEventUpdatesTitle) {
                dialogEventUpdatesTitle.style.display = 'block';
            }
            
            try {
                dialogEventUpdatesList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>';

                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:', dialogId);
                
                const url = `/api/dialogs/${dialogId}/updates?tenantId=${encodeURIComponent(tenantId)}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Tenant-Id': tenantId
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || '';
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}`;
                    }
                    
                    dialogEventUpdatesList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p>
                            <p style="font-size: 12px; color: #999;">${errorMessage}</p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                const updates = Array.isArray(data.data) ? data.data : [];

                if (updates.length === 0) {
                    dialogEventUpdatesList.innerHTML = '<div class="no-data" style="padding: 20px; text-align: center; color: #6c757d;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                dialogEventUpdatesList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 20%;">–í—Ä–µ–º—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${updates.map((update) => {
                                const updateTime = update.createdAt 
                                    ? (typeof update.createdAt === 'number' 
                                        ? new Date(update.createdAt).toLocaleString('ru-RU')
                                        : new Date(update.createdAt).toLocaleString('ru-RU'))
                                    : '-';
                                
                                const eventType = update.eventType || '-';
                                const userId = update.userId || '-';
                                
                                return `
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 10px; color: #6c757d; font-size: 12px; vertical-align: top;">${updateTime}</td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span style="font-weight: 500; font-family: monospace; font-size: 12px;">${escapeHtml(eventType)}</span>
                                        </td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span>${escapeHtml(userId)}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading all dialog updates:', error);
                dialogEventUpdatesList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${error.message}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                        </p>
                    </div>
                `;
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–±—ã—Ç–∏–π –¥–∏–∞–ª–æ–≥–∞
        function closeDialogEventsModal() {
            document.getElementById('dialogEventsModal').style.display = 'none';
            currentDialogIdForEvents = null;
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
            const previouslySelected = document.querySelector('#dialogEventsList .event-row-selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('event-row-selected');
            }
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞"
            const dialogEventUpdatesTitle = document.getElementById('dialogEventUpdatesTitle');
            if (dialogEventUpdatesTitle) {
                dialogEventUpdatesTitle.style.display = 'none';
            }
            // –û—á–∏—â–∞–µ–º –ø—Ä–∞–≤—É—é –∫–æ–ª–æ–Ω–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            const dialogEventUpdatesList = document.getElementById('dialogEventUpdatesList');
            if (dialogEventUpdatesList) {
                dialogEventUpdatesList.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;"><p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p></div>';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞
        async function loadDialogEventUpdates(eventId, dialogId) {
            const dialogEventUpdatesList = document.getElementById('dialogEventUpdatesList');
            const dialogEventUpdatesTitle = document.getElementById('dialogEventUpdatesTitle');
            
            if (!dialogEventUpdatesList) {
                console.error('dialogEventUpdatesList element not found');
                return;
            }
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
            const previouslySelected = document.querySelector('#dialogEventsList .event-row-selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('event-row-selected');
            }
            
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
            const eventRow = document.querySelector(`#dialogEventsList tr[data-event-id="${eventId}"]`);
            if (eventRow) {
                eventRow.classList.add('event-row-selected');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è" –≤ modal-header
            if (dialogEventUpdatesTitle) {
                dialogEventUpdatesTitle.style.display = 'block';
            }
            
            try {
                dialogEventUpdatesList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>';

                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ–±—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞:', eventId, '–¥–∏–∞–ª–æ–≥–∞:', dialogId);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
                const url = `/api/dialogs/${dialogId}/updates?tenantId=${encodeURIComponent(tenantId)}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Tenant-Id': tenantId
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || '';
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}`;
                    }
                    
                    dialogEventUpdatesList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p>
                            <p style="font-size: 12px; color: #999;">${errorMessage}</p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                const allUpdates = Array.isArray(data.data) ? data.data : [];
                
                console.log('–í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:', allUpdates.length);
                console.log('–ò—â–µ–º eventId:', eventId);
                console.log('–¢–∏–ø eventId:', typeof eventId);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ eventId
                const eventIdStr = String(eventId).trim();
                
                // –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ eventId –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                if (allUpdates.length > 0) {
                    console.log('–ü—Ä–∏–º–µ—Ä—ã eventId –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞:');
                    allUpdates.slice(0, 3).forEach((update, idx) => {
                        console.log(`  Update ${idx}:`, update.eventId, '—Ç–∏–ø:', typeof update.eventId);
                    });
                }
                
                const filteredUpdates = allUpdates.filter(update => {
                    if (!update.eventId) {
                        console.log('Update –±–µ–∑ eventId:', update);
                        return false;
                    }
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º eventId –≤ —Å—Ç—Ä–æ–∫—É (–º–æ–∂–µ—Ç –±—ã—Ç—å ObjectId –æ–±—ä–µ–∫—Ç–æ–º)
                    let updateEventId;
                    if (typeof update.eventId === 'object') {
                        if (update.eventId.toString) {
                            updateEventId = update.eventId.toString().trim();
                        } else if (update.eventId.$oid) {
                            updateEventId = update.eventId.$oid.trim();
                        } else {
                            updateEventId = String(update.eventId).trim();
                        }
                    } else {
                        updateEventId = String(update.eventId).trim();
                    }
                    
                    const matches = updateEventId === eventIdStr;
                    if (!matches && allUpdates.length <= 10) {
                        console.log(`–ù–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç: –∏—â–µ–º "${eventIdStr}", –Ω–∞–π–¥–µ–Ω–æ "${updateEventId}"`);
                    }
                    return matches;
                });

                console.log('–ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ–±—ã—Ç–∏—è:', filteredUpdates.length);

                if (filteredUpdates.length === 0) {
                    dialogEventUpdatesList.innerHTML = `
                        <div class="no-data" style="padding: 20px; text-align: center; color: #6c757d;">
                            <p>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p style="font-size: 11px; color: #999; margin-top: 10px;">
                                –í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–∞: ${allUpdates.length}<br>
                                –ò—Å–∫–æ–º—ã–π eventId: ${eventIdStr}<br>
                                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                            </p>
                        </div>
                    `;
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                dialogEventUpdatesList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 20%;">–í—Ä–µ–º—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUpdates.map((update) => {
                                const updateTime = update.createdAt 
                                    ? (typeof update.createdAt === 'number' 
                                        ? new Date(update.createdAt).toLocaleString('ru-RU')
                                        : new Date(update.createdAt).toLocaleString('ru-RU'))
                                    : '-';
                                
                                const eventType = update.eventType || '-';
                                const userId = update.userId || '-';
                                
                                return `
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 10px; color: #6c757d; font-size: 12px; vertical-align: top;">${updateTime}</td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span style="font-weight: 500; font-family: monospace; font-size: 12px;">${escapeHtml(eventType)}</span>
                                        </td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span>${escapeHtml(userId)}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading dialog event updates:', error);
                dialogEventUpdatesList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${error.message}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                        </p>
                    </div>
                `;
            }
        }

        // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–∞ =====
        let currentDialogIdForUpdates = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
        async function loadDialogUpdates(dialogId) {
            const updatesList = document.getElementById('dialogUpdatesList');
            
            try {
                updatesList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</div>';

                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:', dialogId);
                console.log('API Key:', apiKey ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                console.log('Tenant ID:', tenantId);
                
                const url = `/api/dialogs/${dialogId}/updates?tenantId=${encodeURIComponent(tenantId)}`;
                console.log('–ó–∞–ø—Ä–æ—Å –∫:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Tenant-Id': tenantId
                    }
                });
                
                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || '';
                        console.error('–û—à–∏–±–∫–∞ API:', errorData);
                    } catch (e) {
                        const text = await response.text();
                        console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', text);
                        errorMessage = text || `HTTP ${response.status}`;
                    }
                    
                    updatesList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</p>
                            <p style="font-size: 12px; color: #999;">–°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}</p>
                            <p style="font-size: 12px; color: #999;">${errorMessage}</p>
                            <p style="font-size: 12px; color: #999; margin-top: 10px;">
                                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                            </p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                const updates = Array.isArray(data.data) ? data.data : [];

                if (updates.length === 0) {
                    updatesList.innerHTML = '<div class="no-data" style="padding: 20px; text-align: center; color: #6c757d;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                updatesList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 20%;">–í—Ä–µ–º—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th style="text-align: left; padding: 10px; font-weight: 600; color: #495057; width: 40%;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${updates.map((update) => {
                                const updateTime = update.createdAt 
                                    ? (typeof update.createdAt === 'number' 
                                        ? new Date(update.createdAt).toLocaleString('ru-RU')
                                        : new Date(update.createdAt).toLocaleString('ru-RU'))
                                    : '-';
                                
                                const eventType = update.eventType || '-';
                                const userId = update.userId || '-';
                                
                                return `
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 10px; color: #6c757d; font-size: 12px; vertical-align: top;">${updateTime}</td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span style="font-weight: 500; font-family: monospace; font-size: 12px;">${escapeHtml(eventType)}</span>
                                        </td>
                                        <td style="padding: 10px; color: #495057; vertical-align: top;">
                                            <span>${escapeHtml(userId)}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading dialog updates:', error);
                updatesList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ${error.message}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.
                        </p>
                    </div>
                `;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
        async function showDialogUpdatesModal(dialogId) {
            currentDialogIdForUpdates = dialogId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('dialogUpdatesModal').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            await loadDialogUpdates(dialogId);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
        function closeDialogUpdatesModal() {
            document.getElementById('dialogUpdatesModal').style.display = 'none';
            currentDialogIdForUpdates = null;
        }

        // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –¥–∏–∞–ª–æ–≥–∞ =====
        let currentDialogIdForMembers = null;
        let currentDialogNameForMembers = null;

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–∞
        async function loadDialogMembers(dialogId) {
            const membersList = document.getElementById('currentMembersList');
            
            try {
                membersList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</div>';

                const params = new URLSearchParams({
                    page: '1',
                    limit: '100',
                    sort: '(joinedAt,asc)'
                });
                if (currentMemberFilter) {
                    params.append('filter', currentMemberFilter);
                }
                
                const response = await fetch(`/api/dialogs/${dialogId}/members?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    let message = `HTTP error! status: ${response.status}`;
                    try {
                        const errorPayload = await response.json();
                        if (errorPayload?.message) {
                            message = errorPayload.message;
                        }
                    } catch (_) {
                        // ignore parse issues
                    }
                    throw new Error(message);
                }

                const data = await response.json();
                const members = Array.isArray(data.data) ? data.data : [];
                currentDialogMembers = members;
                refreshMemberMetaSelect();

                if (members.length === 0) {
                    membersList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç</div>';
                    return;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                membersList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="text-align: left; padding: 8px; color: #495057; font-weight: 600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th style="text-align: center; padding: 8px; color: #495057; font-weight: 600;">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</th>
                                <th style="text-align: center; padding: 8px; color: #495057; font-weight: 600;">–ê–∫—Ç–∏–≤–µ–Ω</th>
                                <th style="text-align: left; padding: 8px; color: #495057; font-weight: 600;">–ú–µ—Ç–∞</th>
                                <th style="text-align: center; padding: 8px; color: #495057; font-weight: 600;">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${members.map(member => `
                                <tr style="border-bottom: 1px solid #e9ecef;">
                                    <td style="padding: 8px; color: #495057; font-weight: 500;">${member.userId}</td>
                                    <td style="padding: 8px; text-align: center; color: #6c757d;">${member.unreadCount || 0}</td>
                                    <td style="padding: 8px; text-align: center;">
                                        <span style="color: ${member.isActive ? '#28a745' : '#dc3545'};">${member.isActive ? '‚úì' : '‚úó'}</span>
                                    </td>
                                    <td style="padding: 8px; color: #6c757d; font-size: 12px;">
                                        ${formatMemberMeta(member.meta)}
                                    </td>
                                    <td style="padding: 8px; text-align: center;">
                                        <button onclick="removeMember('${dialogId}', '${member.userId}')" 
                                                style="padding: 4px 12px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading members:', error);
                currentDialogMembers = [];
                refreshMemberMetaSelect();
                const safeMessage = escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                membersList.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${safeMessage}</div>`;
            }
        }

        function formatMemberMeta(meta) {
            if (!meta || Object.keys(meta).length === 0) {
                return '<span style="color: #adb5bd;">‚Äî</span>';
            }

            return Object.entries(meta)
                .map(([key, value]) => `<div><strong>${escapeHtml(key)}:</strong> ${escapeHtml(value)}</div>`)
                .join('');
        }

        function switchMembersTab(tab) {
            currentMembersTab = tab;
            const listSection = document.getElementById('membersListSection');
            const metaSection = document.getElementById('memberMetaSection');
            const listButton = document.getElementById('membersTabList');
            const metaButton = document.getElementById('membersTabMeta');

            if (listSection && metaSection) {
                if (tab === 'meta') {
                    listSection.style.display = 'none';
                    metaSection.style.display = 'block';
                    refreshMemberMetaSelect();
                } else {
                    listSection.style.display = 'block';
                    metaSection.style.display = 'none';
                }
            }

            if (listButton && metaButton) {
                if (tab === 'meta') {
                    listButton.classList.remove('active');
                    metaButton.classList.add('active');
                } else {
                    listButton.classList.add('active');
                    metaButton.classList.remove('active');
                }
            }

            if (tab !== 'meta') {
                setMemberMetaStatus('');
            }
        }

        function setMemberMetaStatus(message, type = '') {
            const statusEl = document.getElementById('memberMetaStatus');
            if (!statusEl) {
                return;
            }
            statusEl.textContent = message || '';
            statusEl.classList.remove('status-success', 'status-error');
            if (message) {
                if (type === 'success') {
                    statusEl.classList.add('status-success');
                } else if (type === 'error') {
                    statusEl.classList.add('status-error');
                }
            }
        }

        function deepClone(value) {
            try {
                return JSON.parse(JSON.stringify(value ?? {}));
            } catch (error) {
                console.warn('Failed to clone value', error);
                return {};
            }
        }

        function clearMemberMetaEditor() {
            const editor = document.getElementById('memberMetaEditor');
            const emptyState = document.getElementById('memberMetaEmptyState');
            const actions = document.getElementById('memberMetaEditorActions');
            const saveActions = document.getElementById('memberMetaSaveActions');
            if (editor) {
                editor.innerHTML = '';
                editor.style.display = 'none';
            }
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            if (actions) {
                actions.style.display = 'none';
            }
            if (saveActions) {
                saveActions.style.display = 'none';
            }
            setMemberMetaStatus('');
        }

        function refreshMemberMetaSelect() {
            const select = document.getElementById('memberMetaSelect');
            if (!select) {
                return;
            }

            const previousValue = currentMemberMetaEditingUserId;
            const options = ['<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ --</option>'];
            currentDialogMembers.forEach(member => {
                const safeUserId = escapeHtml(member.userId);
                options.push(`<option value="${safeUserId}">${safeUserId}</option>`);
            });
            select.innerHTML = options.join('');

            if (previousValue && currentDialogMembers.some(member => member.userId === previousValue)) {
                select.value = previousValue;
                const member = currentDialogMembers.find(m => m.userId === previousValue);
                currentMemberMetaOriginal = deepClone(member?.meta || {});
                renderMemberMetaEditor(currentMemberMetaOriginal);
            } else {
                select.value = '';
                currentMemberMetaEditingUserId = null;
                currentMemberMetaOriginal = {};
                clearMemberMetaEditor();
            }
        }

        function onSelectMemberForMeta() {
            const select = document.getElementById('memberMetaSelect');
            if (!select) {
                return;
            }
            const userId = select.value;
            setMemberMetaStatus('');

            if (!userId) {
                currentMemberMetaEditingUserId = null;
                currentMemberMetaOriginal = {};
                clearMemberMetaEditor();
                return;
            }

            const member = currentDialogMembers.find(m => m.userId === userId);
            currentMemberMetaEditingUserId = userId;
            currentMemberMetaOriginal = deepClone(member?.meta || {});
            renderMemberMetaEditor(currentMemberMetaOriginal);
        }

        function renderMemberMetaEditor(meta = {}) {
            const editor = document.getElementById('memberMetaEditor');
            const emptyState = document.getElementById('memberMetaEmptyState');
            const actions = document.getElementById('memberMetaEditorActions');
            const saveActions = document.getElementById('memberMetaSaveActions');

            if (!editor || !emptyState || !actions || !saveActions) {
                return;
            }

            editor.innerHTML = '';
            const keys = Object.keys(meta || {});

            if (keys.length === 0) {
                editor.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                keys.forEach(key => {
                    editor.appendChild(createMemberMetaRowElement(key, meta[key], true));
                });
                editor.style.display = 'block';
                emptyState.style.display = 'none';
            }

            actions.style.display = 'flex';
            saveActions.style.display = 'flex';
            updateMemberMetaEditorState();
        }

        function createMemberMetaRowElement(key, value, isExisting) {
            const row = document.createElement('div');
            row.className = 'member-meta-row';
            row.dataset.originalKey = isExisting ? key : '';

            const keyInput = document.createElement('input');
            keyInput.type = 'text';
            keyInput.className = 'member-meta-key';
            keyInput.placeholder = '–ö–ª—é—á';
            if (isExisting) {
                keyInput.value = key;
                keyInput.readOnly = true;
            }

            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.className = 'member-meta-value';
            valueInput.placeholder = '–ó–Ω–∞—á–µ–Ω–∏–µ';
            valueInput.value = formatMetaValueForInput(value);

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-meta-btn';
            removeButton.textContent = '‚úï';
            removeButton.onclick = () => removeMemberMetaRow(removeButton);

            row.appendChild(keyInput);
            row.appendChild(valueInput);
            row.appendChild(removeButton);

            return row;
        }

        function addMemberMetaRow() {
            const editor = document.getElementById('memberMetaEditor');
            if (!editor) {
                return;
            }
            const row = createMemberMetaRowElement('', '', false);
            editor.appendChild(row);
            updateMemberMetaEditorState();
            const keyInput = row.querySelector('.member-meta-key');
            if (keyInput) {
                keyInput.focus();
            }
        }

        function removeMemberMetaRow(button) {
            const row = button.closest('.member-meta-row');
            if (row) {
                row.remove();
                updateMemberMetaEditorState();
            }
        }

        function updateMemberMetaEditorState() {
            const editor = document.getElementById('memberMetaEditor');
            const emptyState = document.getElementById('memberMetaEmptyState');
            if (!editor || !emptyState) {
                return;
            }
            const hasRows = editor.querySelectorAll('.member-meta-row').length > 0;
            if (hasRows) {
                editor.style.display = 'block';
                emptyState.style.display = 'none';
            } else {
                editor.style.display = 'none';
                emptyState.style.display = 'block';
            }
        }

        function formatMetaValueForInput(value) {
            if (value === null || value === undefined) {
                return '';
            }
            if (typeof value === 'object') {
                try {
                    return JSON.stringify(value);
                } catch (error) {
                    console.warn('Failed to stringify meta value', error);
                    return '';
                }
            }
            return String(value);
        }

        function collectMemberMetaRows() {
            const editor = document.getElementById('memberMetaEditor');
            if (!editor) {
                return { metaEntries: {}, metaPlain: {}, errors: [] };
            }
            const rows = Array.from(editor.querySelectorAll('.member-meta-row'));
            const metaEntries = {};
            const metaPlain = {};
            const errors = [];

            rows.forEach(row => {
                const keyInput = row.querySelector('.member-meta-key');
                const valueInput = row.querySelector('.member-meta-value');
                if (!keyInput || !valueInput) {
                    return;
                }
                keyInput.classList.remove('input-error');

                const key = keyInput.value.trim();
                if (!key) {
                    errors.push('–ö–ª—é—á –º–µ—Ç–∞-—Ç–µ–≥–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                    keyInput.classList.add('input-error');
                    return;
                }
                if (metaEntries[key]) {
                    errors.push(`–î—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–ª—é—á "${key}"`);
                    keyInput.classList.add('input-error');
                    return;
                }

                const parsed = parseMetaValue(valueInput.value);
                metaEntries[key] = { value: parsed.value, dataType: parsed.dataType };
                metaPlain[key] = parsed.value;
            });

            return { metaEntries, metaPlain, errors };
        }

        function parseMetaValue(raw) {
            const trimmed = raw.trim();
            if (trimmed === '') {
                return { value: '', dataType: 'string' };
            }
            if (trimmed === 'true' || trimmed === 'false') {
                return { value: trimmed === 'true', dataType: 'boolean' };
            }
            const numericValue = Number(trimmed);
            if (!Number.isNaN(numericValue) && trimmed !== '') {
                return { value: numericValue, dataType: 'number' };
            }
            if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
                try {
                    const parsed = JSON.parse(trimmed);
                    return { value: parsed, dataType: Array.isArray(parsed) ? 'array' : 'object' };
                } catch (error) {
                    console.warn('Failed to parse JSON meta value', error);
                }
            }
            return { value: raw, dataType: 'string' };
        }

        function valuesAreEqual(a, b) {
            return JSON.stringify(a) === JSON.stringify(b);
        }

        async function saveMemberMetaChanges() {
            if (!currentDialogIdForMembers || !currentMemberMetaEditingUserId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
                return;
            }

            const { metaEntries, metaPlain, errors } = collectMemberMetaRows();
            if (errors.length > 0) {
                setMemberMetaStatus(errors[0], 'error');
                return;
            }

            const original = currentMemberMetaOriginal || {};
            const newKeys = Object.keys(metaEntries);
            const originalKeys = Object.keys(original);

            const updates = [];
            newKeys.forEach(key => {
                const entry = metaEntries[key];
                if (!Object.prototype.hasOwnProperty.call(original, key) || !valuesAreEqual(original[key], entry.value)) {
                    updates.push({
                        key,
                        value: entry.value,
                        dataType: entry.dataType
                    });
                }
            });

            const deletions = originalKeys.filter(key => !metaEntries[key]);

            if (updates.length === 0 && deletions.length === 0) {
                setMemberMetaStatus('–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç', 'success');
                return;
            }

            const entityId = `${currentDialogIdForMembers}:${currentMemberMetaEditingUserId}`;

            try {
                for (const update of updates) {
                    const response = await fetch(`/api/meta/dialogMember/${encodeURIComponent(entityId)}/${encodeURIComponent(update.key)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey,
                            'X-TENANT-ID': tenantId
                        },
                        body: JSON.stringify({
                            value: update.value,
                            dataType: update.dataType
                        })
                    });
                    if (!response.ok) {
                        const errorPayload = await safeParseJson(response);
                        const message = errorPayload?.message || `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–≥ "${update.key}"`;
                        throw new Error(message);
                    }
                }

                for (const key of deletions) {
                    const response = await fetch(`/api/meta/dialogMember/${encodeURIComponent(entityId)}/${encodeURIComponent(key)}`, {
                        method: 'DELETE',
                        headers: {
                            'X-API-Key': apiKey,
                            'X-TENANT-ID': tenantId
                        }
                    });
                    if (!response.ok) {
                        const errorPayload = await safeParseJson(response);
                        const message = errorPayload?.message || `–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "${key}"`;
                        throw new Error(message);
                    }
                }

                setMemberMetaStatus('–ú–µ—Ç–∞-—Ç–µ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                await loadDialogMembers(currentDialogIdForMembers);

                const updatedMember = currentDialogMembers.find(member => member.userId === currentMemberMetaEditingUserId);
                currentMemberMetaOriginal = deepClone(updatedMember?.meta || {});
                renderMemberMetaEditor(currentMemberMetaOriginal);

                const select = document.getElementById('memberMetaSelect');
                if (select) {
                    select.value = currentMemberMetaEditingUserId || '';
                }
            } catch (error) {
                console.error('Error saving member meta:', error);
                setMemberMetaStatus(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Ç–∞-—Ç–µ–≥–æ–≤', 'error');
            }
        }

        function cancelMemberMetaEditing() {
            if (!currentMemberMetaEditingUserId) {
                clearMemberMetaEditor();
                return;
            }
            renderMemberMetaEditor(currentMemberMetaOriginal);
            setMemberMetaStatus('–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã', 'success');
        }

        async function safeParseJson(response) {
            try {
                return await response.json();
            } catch (error) {
                return null;
            }
        }

        function selectMemberFilterExample() {
            const select = document.getElementById('memberFilterExample');
            const input = document.getElementById('memberFilterInput');

            if (select.value && select.value !== 'custom') {
                input.value = select.value;
                applyMemberFilter();
            } else if (select.value === 'custom') {
                input.value = '';
                input.focus();
            }
        }

        function clearMemberFilterField() {
            const input = document.getElementById('memberFilterInput');
            const select = document.getElementById('memberFilterExample');
            if (input) {
                input.value = '';
            }
            if (select) {
                select.value = '';
            }
        }

        async function applyMemberFilter() {
            if (!currentDialogIdForMembers) {
                alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
                return;
            }
            const input = document.getElementById('memberFilterInput');
            const value = input ? input.value.trim() : '';
            currentMemberFilter = value;
            await loadDialogMembers(currentDialogIdForMembers);
        }

        async function clearMemberFilter() {
            if (!currentDialogIdForMembers) {
                return;
            }
            currentMemberFilter = '';
            clearMemberFilterField();
            await loadDialogMembers(currentDialogIdForMembers);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –¥–∏–∞–ª–æ–≥
        document.getElementById('addMemberForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentDialogIdForMembers) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –¥–∏–∞–ª–æ–≥');
                return;
            }

            const userId = document.getElementById('newMemberSelect').value;
            
            if (!userId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            try {
                const response = await fetch(`/api/dialogs/${currentDialogIdForMembers}/members/${userId}/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Member added successfully:', result);
                
                alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥–∏–∞–ª–æ–≥!`);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('addMemberForm').reset();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                await loadDialogMembers(currentDialogIdForMembers);
                
            } catch (error) {
                console.error('Error adding member:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ${error.message}`);
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –¥–∏–∞–ª–æ–≥–∞
        async function removeMember(dialogId, userId) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –∏–∑ –¥–∏–∞–ª–æ–≥–∞?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/dialogs/${dialogId}/members/${userId}/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-TENANT-ID': tenantId
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Member removed successfully:', result);
                
                alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –¥–∏–∞–ª–æ–≥–∞!`);
                
                if (currentMemberMetaEditingUserId === userId) {
                    currentMemberMetaEditingUserId = null;
                    currentMemberMetaOriginal = {};
                    clearMemberMetaEditor();
                    const select = document.getElementById('memberMetaSelect');
                    if (select) {
                        select.value = '';
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                await loadDialogMembers(dialogId);
                
            } catch (error) {
                console.error('Error removing member:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞: ${error.message}`);
            }
        }

        // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞-—Ç–µ–≥–∞–º–∏ –¥–∏–∞–ª–æ–≥–∞ =====
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ç–∞-—Ç–µ–≥–∞–º–∏ –¥–∏–∞–ª–æ–≥–∞
        async function showDialogMetaModal(dialogId) {
            document.getElementById('dialogMetaDialogId').value = dialogId;
            document.getElementById('dialogMetaModal').style.display = 'block';
            await loadDialogMetaTags(dialogId);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ—Ç–∞-—Ç–µ–≥–æ–≤ –¥–∏–∞–ª–æ–≥–∞
        function closeDialogMetaModal() {
            document.getElementById('dialogMetaModal').style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞-—Ç–µ–≥–æ–≤ –¥–∏–∞–ª–æ–≥–∞
        async function loadDialogMetaTags(dialogId) {
            try {
                const response = await fetch(`/api/meta/dialog/${dialogId}`, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-Tenant-ID': tenantId
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load dialog meta');
                }

                const { data: meta } = await response.json();
                const metaObj = meta || {};

                let html = '<h3 style="margin-bottom: 15px; font-size: 14px;">–¢–µ–∫—É—â–∏–µ Meta —Ç–µ–≥–∏:</h3>';
                
                const metaKeys = Object.keys(metaObj);
                if (metaKeys.length === 0) {
                    html += '<div class="no-data" style="padding: 20px;">Meta —Ç–µ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                } else {
                    html += '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="border-bottom: 2px solid #dee2e6; background: #f8f9fa;"><th style="text-align: left; padding: 10px; font-weight: 600; color: #495057;">Key</th><th style="text-align: left; padding: 10px; font-weight: 600; color: #495057;">Value</th><th style="text-align: left; padding: 10px; font-weight: 600; color: #495057;">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
                    for (const key of metaKeys) {
                        html += `
                            <tr style="border-bottom: 1px solid #e9ecef;">
                                <td style="padding: 10px;"><strong>${escapeHtml(key)}</strong></td>
                                <td style="padding: 10px;">${escapeHtml(JSON.stringify(metaObj[key]))}</td>
                                <td style="padding: 10px;"><button class="btn-danger btn-small" onclick="deleteDialogMetaTag('${escapeHtml(dialogId)}', '${escapeHtml(key)}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button></td>
                            </tr>
                        `;
                    }
                    html += '</tbody></table>';
                }

                document.getElementById('dialogMetaList').innerHTML = html;
            } catch (error) {
                console.error('Error loading dialog meta tags:', error);
                document.getElementById('dialogMetaList').innerHTML = `<div class="error" style="padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ meta —Ç–µ–≥–æ–≤: ${error.message}</div>`;
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞-—Ç–µ–≥–∞ –¥–∏–∞–ª–æ–≥–∞
        async function addDialogMetaTag() {
            const dialogId = document.getElementById('dialogMetaDialogId').value;
            const key = document.getElementById('newDialogMetaKey').value.trim();
            const valueStr = document.getElementById('newDialogMetaValue').value.trim();

            if (!key || !valueStr) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ');
                return;
            }

            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ JSON, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–æ–π
            let value;
            try {
                value = JSON.parse(valueStr);
            } catch (e) {
                value = valueStr;
            }

            try {
                const response = await fetch(`/api/meta/dialog/${dialogId}/${key}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-Tenant-ID': tenantId
                    },
                    body: JSON.stringify({ value })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to set meta tag');
                }

                document.getElementById('newDialogMetaKey').value = '';
                document.getElementById('newDialogMetaValue').value = '';
                await loadDialogMetaTags(dialogId);
                alert('Meta —Ç–µ–≥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            } catch (error) {
                console.error('Error adding dialog meta tag:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è meta —Ç–µ–≥–∞: ' + error.message);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–∞-—Ç–µ–≥–∞ –¥–∏–∞–ª–æ–≥–∞
        async function deleteDialogMetaTag(dialogId, key) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å meta —Ç–µ–≥ "${key}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/meta/dialog/${dialogId}/${key}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-Key': apiKey,
                        'X-Tenant-ID': tenantId
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to delete meta tag');
                }

                await loadDialogMetaTags(dialogId);
                alert('Meta —Ç–µ–≥ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
            } catch (error) {
                console.error('Error deleting dialog meta tag:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è meta —Ç–µ–≥–∞: ' + error.message);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const addMessageModal = document.getElementById('addMessageModal');
            const reactionModal = document.getElementById('reactionModal');
            const dialogMetaModal = document.getElementById('dialogMetaModal');
            if (event.target === addMessageModal) {
                closeAddMessageModal();
            }
            if (event.target === reactionModal) {
                closeReactionModal();
            }
            if (event.target === dialogMetaModal) {
                closeDialogMetaModal();
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAddMessageModal();
                closeReactionModal();
                closeDialogMetaModal();
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∞–∫—Ü–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        const style = document.createElement('style');
        style.textContent = `
            .reaction-btn:hover {
                border-color: #667eea !important;
                background-color: #f0f0ff !important;
                transform: scale(1.1);
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="config.js"></script>
    <script>
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º fetch –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (typeof url === 'string') {
                // Events –∏ updates –∏–¥—É—Ç –≤ control-api
                if (url.includes('/events') || url.includes('/updates')) {
                    // –ï—Å–ª–∏ URL —É–∂–µ –ø–æ–ª–Ω—ã–π (—Å http://), –Ω–µ –º–µ–Ω—è–µ–º –µ–≥–æ
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        url = CHAT3_CONFIG.getControlApiUrl(url);
                    }
                } else if (url.startsWith('/api/init')) {
                    url = CHAT3_CONFIG.getControlApiUrl(url);
                } else if (url.startsWith('/api/')) {
                    url = CHAT3_CONFIG.getTenantApiUrl(url);
                }
            }
            return originalFetch.call(this, url, options);
        };
    </script>
</body>
</html>
