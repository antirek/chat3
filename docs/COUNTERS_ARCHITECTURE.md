# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ Chat3

## –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã —Å—á–µ—Ç—á–∏–∫–æ–≤, –≥–¥–µ –≤—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ MongoDB –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö, –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π–Ω–æ–π –º–æ–¥–µ–ª–∏.

## –ü—Ä–∏–Ω—Ü–∏–ø—ã

1. **–í—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ –≤ –ë–î** - –ø–µ—Ä–≤–∏—á–Ω—ã–µ –∏ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö
2. **–û—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤** - —Å—á–µ—Ç—á–∏–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `models/stats/`, –∞ –Ω–µ –≤ `models/data/`
3. **–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ** - –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
4. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö, –±–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
5. **–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª–µ–π —Å—á–µ—Ç—á–∏–∫–æ–≤

–í—Å–µ –º–æ–¥–µ–ª–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `src/models/stats/`:

- **`UserStats`** - –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- **`UserDialogStats`** - –ø–µ—Ä–≤–∏—á–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∏–∞–ª–æ–≥–µ
- **`MessageReactionStats`** - —Å—á–µ—Ç—á–∏–∫–∏ —Ä–µ–∞–∫—Ü–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–µ–∞–∫—Ü–∏–∏)
- **`MessageStatusStats`** - —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞)

–ú–æ–¥–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `src/models/operational/`:

- **`CounterHistory`** - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤

## –¢–∏–ø—ã —Å—á–µ—Ç—á–∏–∫–æ–≤

### 1. –ü–µ—Ä–≤–∏—á–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (Primary Counters)

–°—á–µ—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö:

#### `UserDialogStats.unreadCount`
- **–ú–æ–¥–µ–ª—å**: `UserDialogStats` (–Ω–æ–≤–∞—è)
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `userdialogstats`
- **–ü–æ–ª–µ**: `unreadCount`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏**: 
  - –°–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (`message.create`)
  - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (`message.status.update`)

#### `MessageReactionStats.reactionCount`
- **–ú–æ–¥–µ–ª—å**: `MessageReactionStats` (–Ω–æ–≤–∞—è)
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `messagereactionstats`
- **–ü–æ–ª—è**: `messageId`, `reaction`, `count`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∞–∫—Ü–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–µ–∞–∫—Ü–∏–∏)
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏**: 
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏ (`message.reaction.update` —Å action=`set`)
  - –£–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏ (`message.reaction.update` —Å action=`unset`)
- **–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∞–∫—Ü–∏–π**: –≤—ã–±–æ—Ä–∫–∞ –ø–æ `messageId`

#### `MessageStatusStats.statusCount`
- **–ú–æ–¥–µ–ª—å**: `MessageStatusStats` (–Ω–æ–≤–∞—è)
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `messagestatusstats`
- **–ü–æ–ª—è**: `messageId`, `status`, `count`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ MessageStatus (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞)
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏**: 
  - –°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (`message.status.update`)
- **–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤**: –≤—ã–±–æ—Ä–∫–∞ –ø–æ `messageId`

### 2. –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (Computed Counters)

–°—á–µ—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–≤–∏—á–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤:

#### `UserStats.dialogCount`
- **–ú–æ–¥–µ–ª—å**: `UserStats` (–Ω–æ–≤–∞—è)
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `userstats`
- **–ü–æ–ª–µ**: `dialogCount`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ `dialogmembers` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏**: 
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –¥–∏–∞–ª–æ–≥ (`dialog.member.add`)
  - –£–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –¥–∏–∞–ª–æ–≥–∞ (`dialog.member.remove`)

#### `UserStats.unreadDialogsCount`
- **–ú–æ–¥–µ–ª—å**: `UserStats` (–Ω–æ–≤–∞—è)
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `userstats`
- **–ü–æ–ª–µ**: `unreadDialogsCount`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ (–≥–¥–µ `unreadCount > 0`)
- **–í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ `userdialogstats` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å `unreadCount > 0`
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏**: 
  - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ `UserDialogStats.unreadCount` (–ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ 0)

#### `UserStats.totalUnreadCount`
- **–ú–æ–¥–µ–ª—å**: `UserStats` (–Ω–æ–≤–∞—è)
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `userstats`
- **–ü–æ–ª–µ**: `totalUnreadCount`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–æ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–∞—Ö
- **–í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑**: –°—É–º–º–∞ –≤—Å–µ—Ö `unreadCount` –≤ `userdialogstats` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏**: 
  - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ `UserDialogStats.unreadCount`

#### `UserStats.totalMessagesCount`
- **–ú–æ–¥–µ–ª—å**: `UserStats` (–Ω–æ–≤–∞—è)
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `userstats`
- **–ü–æ–ª–µ**: `totalMessagesCount`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- **–¢–∏–ø**: –ü–µ—Ä–≤–∏—á–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é)
- **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏**: 
  - –°–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (`message.create`) - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è

### 3. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤ (Counter History)

–î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤:

#### `CounterHistory`
- **–ö–æ–ª–ª–µ–∫—Ü–∏—è**: `counterhistory` (–Ω–æ–≤–∞—è)
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ê—É–¥–∏—Ç, –æ—Ç–ª–∞–¥–∫–∞, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π

### –ö–æ–ª–ª–µ–∫—Ü–∏—è: `userstats`

–•—Ä–∞–Ω–∏—Ç –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ).

**–ú–æ–¥–µ–ª—å**: `src/models/stats/UserStats.js`

```javascript
{
  _id: ObjectId,
  tenantId: String,        // ID —Ç–µ–Ω–∞–Ω—Ç–∞
  userId: String,           // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  dialogCount: Number,     // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤
  unreadDialogsCount: Number, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
  totalUnreadCount: Number,   // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  totalMessagesCount: Number, // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  lastUpdatedAt: Number,    // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  createdAt: Number        // Timestamp —Å–æ–∑–¥–∞–Ω–∏—è
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `{ tenantId: 1, userId: 1 }` (unique)
- `{ tenantId: 1, unreadDialogsCount: 1 }`
- `{ tenantId: 1, totalUnreadCount: 1 }`
- `{ tenantId: 1, totalMessagesCount: 1 }`

### –ö–æ–ª–ª–µ–∫—Ü–∏—è: `userdialogstats`

–•—Ä–∞–Ω–∏—Ç –ø–µ—Ä–≤–∏—á–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∏–∞–ª–æ–≥–µ.

**–ú–æ–¥–µ–ª—å**: `src/models/stats/UserDialogStats.js`

```javascript
{
  _id: ObjectId,
  tenantId: String,        // ID —Ç–µ–Ω–∞–Ω—Ç–∞
  userId: String,           // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  dialogId: String,         // ID –¥–∏–∞–ª–æ–≥–∞
  unreadCount: Number,      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  lastUpdatedAt: Number,    // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  createdAt: Number        // Timestamp —Å–æ–∑–¥–∞–Ω–∏—è
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `{ tenantId: 1, userId: 1, dialogId: 1 }` (unique)
- `{ tenantId: 1, userId: 1, unreadCount: 1 }`
- `{ tenantId: 1, dialogId: 1 }`
- `{ tenantId: 1, unreadCount: 1 }`

### –ö–æ–ª–ª–µ–∫—Ü–∏—è: `messagereactionstats`

–•—Ä–∞–Ω–∏—Ç —Å—á–µ—Ç—á–∏–∫–∏ —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–µ–∞–∫—Ü–∏–∏).

**–ú–æ–¥–µ–ª—å**: `src/models/stats/MessageReactionStats.js`

```javascript
{
  _id: ObjectId,
  tenantId: String,        // ID —Ç–µ–Ω–∞–Ω—Ç–∞
  messageId: String,        // ID —Å–æ–æ–±—â–µ–Ω–∏—è
  reaction: String,         // –¢–∏–ø —Ä–µ–∞–∫—Ü–∏–∏ (üëç, ‚ù§Ô∏è, etc.)
  count: Number,            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∞–∫—Ü–∏–π —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
  lastUpdatedAt: Number,    // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  createdAt: Number        // Timestamp —Å–æ–∑–¥–∞–Ω–∏—è
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `{ tenantId: 1, messageId: 1, reaction: 1 }` (unique)
- `{ tenantId: 1, messageId: 1 }` (–¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –≤—Å–µ—Ö —Ä–µ–∞–∫—Ü–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è)
- `{ tenantId: 1, reaction: 1, count: 1 }` (–¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π)

### –ö–æ–ª–ª–µ–∫—Ü–∏—è: `messagestatusstats`

–•—Ä–∞–Ω–∏—Ç —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞).

**–ú–æ–¥–µ–ª—å**: `src/models/stats/MessageStatusStats.js`

```javascript
{
  _id: ObjectId,
  tenantId: String,        // ID —Ç–µ–Ω–∞–Ω—Ç–∞
  messageId: String,        // ID —Å–æ–æ–±—â–µ–Ω–∏—è
  status: String,           // –¢–∏–ø —Å—Ç–∞—Ç—É—Å–∞ ('sent', 'unread', 'delivered', 'read')
  count: Number,            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏
  lastUpdatedAt: Number,    // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  createdAt: Number        // Timestamp —Å–æ–∑–¥–∞–Ω–∏—è
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `{ tenantId: 1, messageId: 1, status: 1 }` (unique)
- `{ tenantId: 1, messageId: 1 }` (–¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è)
- `{ tenantId: 1, status: 1, count: 1 }` (–¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º)

### –ö–æ–ª–ª–µ–∫—Ü–∏—è: `counterhistory`

–•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤.

```javascript
{
  _id: ObjectId,
  tenantId: String,        // ID —Ç–µ–Ω–∞–Ω—Ç–∞
  counterType: String,     // –¢–∏–ø —Å—á–µ—Ç—á–∏–∫–∞: 'userDialogStats.unreadCount', 'messageReactionStats.count', 'messageStatusStats.count', 'userStats.dialogCount', 'userStats.unreadDialogsCount', 'userStats.totalUnreadCount', 'userStats.totalMessagesCount'
  entityType: String,      // –¢–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏: 'dialogMember', 'message', 'user'
  entityId: String,        // ID —Å—É—â–Ω–æ—Å—Ç–∏ (dialogId:userId –¥–ª—è dialogMember, messageId –¥–ª—è message, userId –¥–ª—è user)
  field: String,          // –ü–æ–ª–µ —Å—á–µ—Ç—á–∏–∫–∞: 'unreadCount', 'reactionCounts', 'dialogCount', etc.
  oldValue: Mixed,         // –°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å —á–∏—Å–ª–æ, –æ–±—ä–µ–∫—Ç, null)
  newValue: Mixed,         // –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  delta: Number,           // –ò–∑–º–µ–Ω–µ–Ω–∏–µ (–¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤)
  operation: String,       // –û–ø–µ—Ä–∞—Ü–∏—è: 'increment', 'decrement', 'set', 'reset'
  sourceOperation: String, // –ò—Å—Ö–æ–¥–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: 'message.create', 'message.status.update', 'dialog.member.add', etc.
  sourceEntityId: String, // ID —Å—É—â–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑–≤–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (messageId, dialogId, etc.)
  actorId: String,        // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏–ª –æ–ø–µ—Ä–∞—Ü–∏—é
  actorType: String,      // –¢–∏–ø –∞–∫—Ç–æ—Ä–∞: 'user', 'bot', 'api', 'system'
  createdAt: Number       // Timestamp –∏–∑–º–µ–Ω–µ–Ω–∏—è
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `{ tenantId: 1, counterType: 1, entityId: 1, createdAt: -1 }`
- `{ tenantId: 1, entityType: 1, entityId: 1, createdAt: -1 }`
- `{ tenantId: 1, sourceOperation: 1, createdAt: -1 }`
- `{ tenantId: 1, userId: 1, createdAt: -1 }` (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

### –í–∞–∂–Ω–æ: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥–µ–ª—è—Ö

#### `DialogMember` - —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—è `unreadCount`

–ü–æ–ª–µ `unreadCount` –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –∏–∑ –º–æ–¥–µ–ª–∏ `DialogMember` –∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ `UserDialogStats`.

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è `unreadCount` –∏–∑ `dialogmembers` –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ `userdialogstats`
- –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª–µ `unreadCount` –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –∏–∑ —Å—Ö–µ–º—ã `DialogMember`

#### `Message` - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ú–æ–¥–µ–ª—å `Message` –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –í—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `messagestats`.

## –ú–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤

### –ü–æ–¥—Ö–æ–¥: MongoDB Middleware + –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### 1. Pre-save/post-save hooks –≤ –º–æ–¥–µ–ª—è—Ö

–ò—Å–ø–æ–ª—å–∑—É–µ–º Mongoose middleware –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

**UserDialogStats:**
```javascript
userDialogStatsSchema.pre('save', async function(next) {
  if (this.isModified('unreadCount')) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (this._id) {
      const oldDoc = await this.constructor.findById(this._id);
      this._oldUnreadCount = oldDoc?.unreadCount || 0;
    } else {
      this._oldUnreadCount = 0;
    }
  }
  next();
});

userDialogStatsSchema.post('save', async function(doc) {
  if (doc.isModified('unreadCount')) {
    const oldValue = doc._oldUnreadCount || 0;
    const newValue = doc.unreadCount;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    await saveCounterHistory({
      counterType: 'userDialogStats.unreadCount',
      entityType: 'userDialogStats',
      entityId: `${doc.dialogId}:${doc.userId}`,
      field: 'unreadCount',
      oldValue,
      newValue,
      delta: newValue - oldValue,
      operation: newValue > oldValue ? 'increment' : 'decrement',
      // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UserStats (sourceEventId –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ –≤—ã–∑—ã–≤–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏)
    // –ï—Å–ª–∏ sourceEventId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, update –Ω–µ —Å–æ–∑–¥–∞—Å—Ç—Å—è
    const sourceEventId = doc._sourceEventId || null;
    const sourceEventType = doc._sourceEventType || null;
    await updateUserStatsFromUnreadCount(doc.tenantId, doc.userId, oldValue, newValue, sourceEventId, sourceEventType);
  }
});
```

**Message:**
```javascript
messageSchema.post('save', async function(doc) {
  // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–µ–º unreadCount –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  if (doc.isNew) {
    await incrementUnreadCountForAllMembers(doc.tenantId, doc.dialogId, doc.messageId, doc.senderId);
  }
});
```

**MessageReactionStats:**
```javascript
messageReactionStatsSchema.pre('save', async function(next) {
  if (this.isModified('count')) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (this._id) {
      const oldDoc = await this.constructor.findById(this._id);
      this._oldCount = oldDoc?.count || 0;
    } else {
      this._oldCount = 0;
    }
  }
  next();
});

messageReactionStatsSchema.post('save', async function(doc) {
  if (doc.isModified('count')) {
    const oldValue = doc._oldCount || 0;
    const newValue = doc.count;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    await saveCounterHistory({
      counterType: 'messageReactionStats.count',
      entityType: 'messageReactionStats',
      entityId: `${doc.messageId}:${doc.reaction}`,
      field: 'count',
      oldValue,
      newValue,
      delta: newValue - oldValue,
      operation: newValue > oldValue ? 'increment' : 'decrement',
      // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    });
  }
});
```

**MessageStatusStats:**
```javascript
messageStatusStatsSchema.pre('save', async function(next) {
  if (this.isModified('count')) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (this._id) {
      const oldDoc = await this.constructor.findById(this._id);
      this._oldCount = oldDoc?.count || 0;
    } else {
      this._oldCount = 0;
    }
  }
  next();
});

messageStatusStatsSchema.post('save', async function(doc) {
  if (doc.isModified('count')) {
    const oldValue = doc._oldCount || 0;
    const newValue = doc.count;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    await saveCounterHistory({
      counterType: 'messageStatusStats.count',
      entityType: 'messageStatusStats',
      entityId: `${doc.messageId}:${doc.status}`,
      field: 'count',
      oldValue,
      newValue,
      delta: newValue - oldValue,
      operation: 'increment',
      // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    });
  }
});
```

**MessageStatus:**
```javascript
messageStatusSchema.post('save', async function(doc) {
  if (doc.isNew) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ Message
    await incrementMessageStatusCount(doc.tenantId, doc.messageId, doc.status);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º unreadCount –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ 'read'
    if (doc.status === 'read') {
      await decrementUnreadCount(doc.tenantId, doc.userId, doc.messageId);
    }
  }
});
```

**MessageReaction:**
```javascript
messageReactionSchema.post('save', async function(doc) {
  if (doc.isNew) {
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ä–µ–∞–∫—Ü–∏–∏
    await incrementMessageReactionCount(doc.tenantId, doc.messageId, doc.reaction);
  }
});

messageReactionSchema.post('remove', async function(doc) {
  // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ä–µ–∞–∫—Ü–∏–∏
  await decrementMessageReactionCount(doc.tenantId, doc.messageId, doc.reaction);
});
```

#### 2. –ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (CounterUpdateContext)

–î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö `user.stats.update` –ø—Ä–∏ –æ–¥–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π:

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (`message.create`) –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–æ–≤:
- –î–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: `unreadDialogsCount`, `totalUnreadCount` (–∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è `unreadCount`)
- –î–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: `totalMessagesCount`

–ë–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —ç—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –±—ã –∫ —Å–æ–∑–¥–∞–Ω–∏—é 2-3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö `user.stats.update` –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ (`CounterUpdateContext`) —Å –∫–ª—é—á–æ–º `tenantId:userId:sourceEventId`
2. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª—è—é—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ `context.addUpdatedField()`
3. –í –∫–æ–Ω—Ü–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `finalizeCounterUpdateContext()`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –æ–¥–∏–Ω `user.stats.update` —Å–æ –≤—Å–µ–º–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

**–ü—Ä–∏–º–µ—Ä:**
```javascript
// –ü—Ä–∏ message.create –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
const context = getCounterUpdateContext(tenantId, userId, eventId, 'message.create');
// updateUserStatsFromUnreadCount –¥–æ–±–∞–≤–ª—è–µ—Ç 'user.stats.unreadDialogsCount' –∏ 'user.stats.totalUnreadCount'
// –í –∫–æ–Ω—Ü–µ:
await finalizeCounterUpdateContext(tenantId, userId, eventId);
// –°–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω user.stats.update —Å updatedFields: ['user.stats.unreadDialogsCount', 'user.stats.totalUnreadCount']
```

#### 3. –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤:**

```javascript
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ unreadCount
// –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
async function updateUnreadCount(tenantId, userId, dialogId, delta, sourceOperation, sourceEventId, sourceEntityId, actorId, actorType) {
  // –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å $inc - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions
  const result = await UserDialogStats.findOneAndUpdate(
    { tenantId, userId, dialogId },
    { 
      $inc: { unreadCount: delta },
      $set: { 
        lastUpdatedAt: generateTimestamp(),
        _sourceEventId: sourceEventId,
        _sourceEventType: sourceOperation
      }
    },
    { 
      upsert: true, 
      new: true,
      setDefaultsOnInsert: true // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç unreadCount: 0 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
    }
  );
  
  const oldValue = Math.max(0, (result.unreadCount || 0) - delta);
  const newValue = result.unreadCount;
  
  // Post-save hook –æ–±–Ω–æ–≤–∏—Ç UserStats –∏ –∏—Å—Ç–æ—Ä–∏—é
  // –ù–æ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é, —Ç–∞–∫ –∫–∞–∫ findOneAndUpdate –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç hooks
  if (result.isNew || result.modifiedPaths().includes('unreadCount')) {
    // –í—ã–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UserStats –≤—Ä—É—á–Ω—É—é
    await updateUserStatsFromUnreadCount(tenantId, userId, oldValue, newValue, sourceEventId, sourceOperation);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    await saveCounterHistory({
      counterType: 'userDialogStats.unreadCount',
      entityType: 'userDialogStats',
      entityId: `${dialogId}:${userId}`,
      field: 'unreadCount',
      oldValue,
      newValue,
      delta,
      operation: delta > 0 ? 'increment' : 'decrement',
      sourceOperation,
      sourceEntityId,
      actorId,
      actorType: actorType || 'user',
      tenantId
    });
  }
  
  return { oldValue, newValue };
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ reactionCount
// –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
async function updateReactionCount(tenantId, messageId, reaction, delta, sourceOperation, sourceEventId, actorId, actorType) {
  // –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å $inc
  const result = await MessageReactionStats.findOneAndUpdate(
    { tenantId, messageId, reaction },
    { 
      $inc: { count: delta },
      $set: { lastUpdatedAt: generateTimestamp() }
    },
    { 
      upsert: true, 
      new: true,
      setDefaultsOnInsert: true
    }
  );
  
  const newCount = result.count;
  
  if (newCount <= 0) {
    // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–ª 0 –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
    await MessageReactionStats.deleteOne({ tenantId, messageId, reaction });
    return { oldValue: newCount - delta, newValue: 0 };
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (findOneAndUpdate –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç hooks)
  await saveCounterHistory({
    counterType: 'messageReactionStats.count',
    entityType: 'messageReactionStats',
    entityId: `${messageId}:${reaction}`,
    field: 'count',
    oldValue: newCount - delta,
    newValue: newCount,
    delta,
    operation: delta > 0 ? 'increment' : 'decrement',
    sourceOperation,
    sourceEntityId: messageId,
    actorId,
    actorType: actorType || 'user',
    tenantId
  });
  
  return { oldValue: newCount - delta, newValue: newCount };
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∞–∫—Ü–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è
async function getMessageReactionCounts(tenantId, messageId) {
  const stats = await MessageReactionStats.find({ tenantId, messageId });
  return stats.map(s => ({
    reaction: s.reaction,
    count: s.count
  }));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ statusCount
// –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
async function updateStatusCount(tenantId, messageId, status, delta, sourceOperation, sourceEventId, actorId, actorType) {
  // –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å $inc
  const result = await MessageStatusStats.findOneAndUpdate(
    { tenantId, messageId, status },
    { 
      $inc: { count: delta },
      $set: { lastUpdatedAt: generateTimestamp() }
    },
    { 
      upsert: true, 
      new: true,
      setDefaultsOnInsert: true
    }
  );
  
  const newCount = result.count;
  const oldCount = newCount - delta;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (findOneAndUpdate –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç hooks)
  await saveCounterHistory({
    counterType: 'messageStatusStats.count',
    entityType: 'messageStatusStats',
    entityId: `${messageId}:${status}`,
    field: 'count',
    oldValue: oldCount,
    newValue: newCount,
    delta,
    operation: 'increment',
    sourceOperation,
    sourceEntityId: messageId,
    actorId,
    actorType: actorType || 'user',
    tenantId
  });
  
  return { oldValue: oldCount, newValue: newCount };
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è
async function getMessageStatusCounts(tenantId, messageId) {
  const stats = await MessageStatusStats.find({ tenantId, messageId });
  return stats.map(s => ({
    status: s.status,
    count: s.count
  }));
}
```

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤:**

```javascript
// –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–±–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ user.stats.update —Å–æ –≤—Å–µ–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
class CounterUpdateContext {
  constructor(tenantId, userId, sourceEventId, sourceEventType) {
    this.tenantId = tenantId;
    this.userId = userId;
    this.sourceEventId = sourceEventId;
    this.sourceEventType = sourceEventType;
    this.updatedFields = new Set(); // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
  }
  
  addUpdatedField(field) {
    this.updatedFields.add(field);
  }
  
  hasUpdates() {
    return this.updatedFields.size > 0;
  }
  
  getUpdatedFields() {
    return Array.from(this.updatedFields);
  }
  
  async createStatsUpdate() {
    if (this.hasUpdates() && this.sourceEventId) {
      await createUserStatsUpdate(
        this.tenantId,
        this.userId,
        this.sourceEventId,
        this.sourceEventType,
        this.getUpdatedFields()
      );
    }
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –∫–ª—é—á—É (tenantId:userId:sourceEventId)
// –ö–†–ò–¢–ò–ß–ù–û: –î–æ–±–∞–≤–ª–µ–Ω TTL –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
const counterUpdateContexts = new Map();
const contextTimestamps = new Map();
const CONTEXT_TTL_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
setInterval(() => {
  const now = Date.now();
  for (const [key, timestamp] of contextTimestamps.entries()) {
    if (now - timestamp > CONTEXT_TTL_MS) {
      const context = counterUpdateContexts.get(key);
      if (context) {
        // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        context.createStatsUpdate().catch(err => {
          console.error(`Failed to finalize expired context ${key}:`, err);
        });
      }
      counterUpdateContexts.delete(key);
      contextTimestamps.delete(key);
    }
  }
}, CONTEXT_TTL_MS);

function getCounterUpdateContext(tenantId, userId, sourceEventId, sourceEventType) {
  const key = `${tenantId}:${userId}:${sourceEventId || 'no-event'}`;
  
  // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
  const now = Date.now();
  for (const [k, timestamp] of contextTimestamps.entries()) {
    if (now - timestamp > CONTEXT_TTL_MS) {
      const context = counterUpdateContexts.get(k);
      if (context) {
        context.createStatsUpdate().catch(err => {
          console.error(`Failed to finalize expired context ${k}:`, err);
        });
      }
      counterUpdateContexts.delete(k);
      contextTimestamps.delete(k);
    }
  }
  
  if (!counterUpdateContexts.has(key)) {
    counterUpdateContexts.set(key, new CounterUpdateContext(tenantId, userId, sourceEventId, sourceEventType));
    contextTimestamps.set(key, Date.now());
  }
  
  return counterUpdateContexts.get(key);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è user.stats.update
// –ö–†–ò–¢–ò–ß–ù–û: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
async function finalizeCounterUpdateContext(tenantId, userId, sourceEventId) {
  const key = `${tenantId}:${userId}:${sourceEventId || 'no-event'}`;
  const context = counterUpdateContexts.get(key);
  
  if (context) {
    try {
      await context.createStatsUpdate();
    } catch (error) {
      console.error(`Failed to create stats update for context ${key}:`, error);
      // –í—Å–µ —Ä–∞–≤–Ω–æ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —É—Ç–µ—á–∫–∏
    } finally {
      counterUpdateContexts.delete(key);
      contextTimestamps.delete(key);
    }
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UserStats –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è unreadCount
async function updateUserStatsFromUnreadCount(tenantId, userId, oldUnreadCount, newUnreadCount, sourceEventId = null, sourceEventType = null) {
  let stats = await UserStats.findOne({ tenantId, userId });
  
  if (!stats) {
    stats = await UserStats.create({
      tenantId,
      userId,
      dialogCount: 0,
      unreadDialogsCount: 0,
      totalUnreadCount: 0,
      totalMessagesCount: 0
    });
  }
  
  const oldWasUnread = oldUnreadCount > 0;
  const newIsUnread = newUnreadCount > 0;
  
  const oldStats = {
    unreadDialogsCount: stats.unreadDialogsCount,
    totalUnreadCount: stats.totalUnreadCount
  };
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
  const context = sourceEventId ? getCounterUpdateContext(tenantId, userId, sourceEventId, sourceEventType) : null;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º unreadDialogsCount –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –¥–∏–∞–ª–æ–≥–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è
  if (oldWasUnread && !newIsUnread) {
    // –î–∏–∞–ª–æ–≥ —Å—Ç–∞–ª –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
    stats.unreadDialogsCount = Math.max(0, stats.unreadDialogsCount - 1);
  } else if (!oldWasUnread && newIsUnread) {
    // –î–∏–∞–ª–æ–≥ —Å—Ç–∞–ª –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
    stats.unreadDialogsCount = stats.unreadDialogsCount + 1;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º totalUnreadCount
  stats.totalUnreadCount = stats.totalUnreadCount - oldUnreadCount + newUnreadCount;
  
  await stats.save();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
  if (oldStats.unreadDialogsCount !== stats.unreadDialogsCount) {
    await saveCounterHistory({
      counterType: 'userStats.unreadDialogsCount',
      entityType: 'user',
      entityId: userId,
      field: 'unreadDialogsCount',
      oldValue: oldStats.unreadDialogsCount,
      newValue: stats.unreadDialogsCount,
      delta: stats.unreadDialogsCount - oldStats.unreadDialogsCount,
      operation: 'computed',
      sourceOperation: 'userDialogStats.unreadCount.update',
      sourceEntityId: userId,
      tenantId
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ —Å–æ–∑–¥–∞–µ–º update —Å—Ä–∞–∑—É)
    if (context) {
      context.addUpdatedField('user.stats.unreadDialogsCount');
    }
  }
  
  if (oldStats.totalUnreadCount !== stats.totalUnreadCount) {
    await saveCounterHistory({
      counterType: 'userStats.totalUnreadCount',
      entityType: 'user',
      entityId: userId,
      field: 'totalUnreadCount',
      oldValue: oldStats.totalUnreadCount,
      newValue: stats.totalUnreadCount,
      delta: stats.totalUnreadCount - oldStats.totalUnreadCount,
      operation: 'computed',
      sourceOperation: 'userDialogStats.unreadCount.update',
      sourceEntityId: userId,
      tenantId
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ —Å–æ–∑–¥–∞–µ–º update —Å—Ä–∞–∑—É)
    if (context) {
      context.addUpdatedField('user.stats.totalUnreadCount');
    }
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dialogCount
// –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
async function updateUserStatsDialogCount(tenantId, userId, delta, sourceOperation, sourceEventId = null, actorId, actorType) {
  // –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å $inc
  const result = await UserStats.findOneAndUpdate(
    { tenantId, userId },
    { 
      $inc: { dialogCount: delta },
      $set: { lastUpdatedAt: generateTimestamp() },
      $setOnInsert: {
        unreadDialogsCount: 0,
        totalUnreadCount: 0,
        totalMessagesCount: 0
      }
    },
    { 
      upsert: true, 
      new: true,
      setDefaultsOnInsert: true
    }
  );
  
  const oldValue = Math.max(0, result.dialogCount - delta);
  const newValue = result.dialogCount;
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
  const context = sourceEventId ? getCounterUpdateContext(tenantId, userId, sourceEventId, sourceOperation) : null;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
  await saveCounterHistory({
    counterType: 'userStats.dialogCount',
    entityType: 'user',
    entityId: userId,
    field: 'dialogCount',
    oldValue,
    newValue,
    delta,
    operation: delta > 0 ? 'increment' : 'decrement',
    sourceOperation,
    sourceEntityId: userId,
    actorId,
    actorType: actorType || 'user',
    tenantId
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ —Å–æ–∑–¥–∞–µ–º update —Å—Ä–∞–∑—É)
  if (context) {
    context.addUpdatedField('user.stats.dialogCount');
  }
  
  return { oldValue, newValue };
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ totalMessagesCount
// –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
async function updateUserStatsTotalMessagesCount(tenantId, userId, delta, sourceOperation, sourceEventId = null, sourceEntityId, actorId, actorType) {
  // –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å $inc
  const result = await UserStats.findOneAndUpdate(
    { tenantId, userId },
    { 
      $inc: { totalMessagesCount: delta },
      $set: { lastUpdatedAt: generateTimestamp() },
      $setOnInsert: {
        dialogCount: 0,
        unreadDialogsCount: 0,
        totalUnreadCount: 0
      }
    },
    { 
      upsert: true, 
      new: true,
      setDefaultsOnInsert: true
    }
  );
  
  const oldValue = Math.max(0, result.totalMessagesCount - delta);
  const newValue = result.totalMessagesCount;
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
  const context = sourceEventId ? getCounterUpdateContext(tenantId, userId, sourceEventId, sourceOperation) : null;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
  await saveCounterHistory({
    counterType: 'userStats.totalMessagesCount',
    entityType: 'user',
    entityId: userId,
    field: 'totalMessagesCount',
    oldValue,
    newValue,
    delta,
    operation: delta > 0 ? 'increment' : 'decrement',
    sourceOperation,
    sourceEntityId,
    actorId,
    actorType: actorType || 'user',
    tenantId
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ —Å–æ–∑–¥–∞–µ–º update —Å—Ä–∞–∑—É)
  if (context) {
    context.addUpdatedField('user.stats.totalMessagesCount');
  }
  
  return { oldValue, newValue };
}
```

#### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

**messageController.js:**
```javascript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
async function createMessage(req, res) {
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  
  // –ü–æ–ª—É—á–∞–µ–º eventId –∏–∑ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è message.create
  // –ö–†–ò–¢–ò–ß–ù–û: eventUtils.createEvent() –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å _id
  const messageEvent = await eventUtils.createEvent({
    tenantId,
    eventType: 'message.create',
    entityType: 'message',
    entityId: message.messageId,
    data: { ... }
  });
  
  const sourceEventId = messageEvent._id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–∞–∑—É, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  const sourceEventType = 'message.create';
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ unreadCount –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
  const members = await DialogMember.find({ tenantId, dialogId });
  
  // –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º try-finally –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
  try {
    for (const member of members) {
      if (member.userId !== senderId) {
        await updateUnreadCount(
          tenantId,
          member.userId,
          dialogId,
          1, // delta
          sourceEventType,
          sourceEventId,
          message.messageId,
          senderId,
          'user'
        );
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ totalMessagesCount –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    await updateUserStatsTotalMessagesCount(
      tenantId,
      senderId,
      1, // delta
      sourceEventType,
      sourceEventId,
      message.messageId,
      senderId,
      'user'
    );
  } finally {
    // –ö–†–ò–¢–ò–ß–ù–û: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    // –°–æ–∑–¥–∞–µ–º user.stats.update –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Å—á–µ—Ç—á–∏–∫–∏
    // –î–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–∏–∑–º–µ–Ω–∏–ª—Å—è unreadCount)
    for (const member of members) {
      if (member.userId !== senderId) {
        try {
          await finalizeCounterUpdateContext(tenantId, member.userId, sourceEventId);
        } catch (error) {
          console.error(`Failed to finalize context for ${member.userId}:`, error);
          // –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è, –Ω–æ –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω –ø–æ TTL
        }
      }
    }
    
    // –î–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–∏–∑–º–µ–Ω–∏–ª—Å—è totalMessagesCount)
    try {
      await finalizeCounterUpdateContext(tenantId, senderId, sourceEventId);
    } catch (error) {
      console.error(`Failed to finalize context for ${senderId}:`, error);
    }
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

**messageStatusController.js:**
```javascript
// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function updateMessageStatus(req, res) {
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ MessageStatus
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ statusCounts –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ post-save hook MessageStatus
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ unreadCount –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ post-save hook MessageStatus
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

**dialogMemberController.js:**
```javascript
// –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞
async function addDialogMember(req, res) {
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ DialogMember
  
  // –ö–†–ò–¢–ò–ß–ù–û: eventUtils.createEvent() –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
  const memberEvent = await eventUtils.createEvent({
    tenantId,
    eventType: 'dialog.member.add',
    entityType: 'dialogMember',
    entityId: `${dialogId}:${userId}`,
    data: { ... }
  });
  
  const sourceEventId = memberEvent._id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–∞–∑—É
  
  // –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º try-finally –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
  try {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dialogCount
    await updateUserStatsDialogCount(
      tenantId,
      userId,
      1, // delta
      'dialog.member.add',
      sourceEventId,
      actorId,
      actorType
    );
  } finally {
    // –°–æ–∑–¥–∞–µ–º user.stats.update –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤
    try {
      await finalizeCounterUpdateContext(tenantId, userId, sourceEventId);
    } catch (error) {
      console.error(`Failed to finalize context for ${userId}:`, error);
    }
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}

// –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞
async function removeDialogMember(req, res) {
  // ... —É–¥–∞–ª–µ–Ω–∏–µ DialogMember
  
  // –ö–†–ò–¢–ò–ß–ù–û: eventUtils.createEvent() –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
  const memberEvent = await eventUtils.createEvent({
    tenantId,
    eventType: 'dialog.member.remove',
    entityType: 'dialogMember',
    entityId: `${dialogId}:${userId}`,
    data: { ... }
  });
  
  const sourceEventId = memberEvent._id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–∞–∑—É
  
  // –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º try-finally –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
  try {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dialogCount
    await updateUserStatsDialogCount(
      tenantId,
      userId,
      -1, // delta
      'dialog.member.remove',
      sourceEventId,
      actorId,
      actorType
    );
  } finally {
    // –°–æ–∑–¥–∞–µ–º user.stats.update –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤
    try {
      await finalizeCounterUpdateContext(tenantId, userId, sourceEventId);
    } catch (error) {
      console.error(`Failed to finalize context for ${userId}:`, error);
    }
  }
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π —Å—á–µ—Ç—á–∏–∫–æ–≤

1. **–°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `src/models/stats/`**
   - –ù–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –º–æ–¥–µ–ª–µ–π —Å—á–µ—Ç—á–∏–∫–æ–≤

2. **–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `UserStats`**
   - –§–∞–π–ª: `src/models/stats/UserStats.js`
   - –ö–æ–ª–ª–µ–∫—Ü–∏—è: `userstats`
   - –ü–æ–ª—è: `tenantId`, `userId`, `dialogCount`, `unreadDialogsCount`, `totalUnreadCount`, `totalMessagesCount`
   - –ò–Ω–¥–µ–∫—Å—ã: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∞ `{ tenantId, userId }`

3. **–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `UserDialogStats`**
   - –§–∞–π–ª: `src/models/stats/UserDialogStats.js`
   - –ö–æ–ª–ª–µ–∫—Ü–∏—è: `userdialogstats`
   - –ü–æ–ª—è: `tenantId`, `userId`, `dialogId`, `unreadCount`
   - –ò–Ω–¥–µ–∫—Å—ã: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∞ `{ tenantId, userId, dialogId }`

4. **–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `MessageReactionStats`**
   - –§–∞–π–ª: `src/models/stats/MessageReactionStats.js`
   - –ö–æ–ª–ª–µ–∫—Ü–∏—è: `messagereactionstats`
   - –ü–æ–ª—è: `tenantId`, `messageId`, `reaction`, `count`
   - –ò–Ω–¥–µ–∫—Å—ã: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∞ `{ tenantId, messageId, reaction }`

5. **–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `MessageStatusStats`**
   - –§–∞–π–ª: `src/models/stats/MessageStatusStats.js`
   - –ö–æ–ª–ª–µ–∫—Ü–∏—è: `messagestatusstats`
   - –ü–æ–ª—è: `tenantId`, `messageId`, `status`, `count`
   - –ò–Ω–¥–µ–∫—Å—ã: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∞ `{ tenantId, messageId, status }`

6. **–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `CounterHistory`**
   - –§–∞–π–ª: `src/models/operational/CounterHistory.js`
   - –ö–æ–ª–ª–µ–∫—Ü–∏—è: `counterhistory`
   - –ü–æ–ª—è: –≤—Å–µ –ø–æ–ª—è –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—ã—à–µ
   - –ò–Ω–¥–µ–∫—Å—ã: –ø–æ `tenantId`, `counterType`, `entityId`, `createdAt`

7. **–û–±–Ω–æ–≤–∏—Ç—å `src/models/index.js`**
   - –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π —Å—á–µ—Ç—á–∏–∫–æ–≤

### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—á–µ—Ç—á–∏–∫–∞–º–∏

1. **–°–æ–∑–¥–∞—Ç—å `src/apps/tenant-api/utils/counterUtils.js`**
   - –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `createUserStatsUpdate` –∏–∑ `updateUtils.js` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è `user.stats.update`
   - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–∏—á–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤:
     - `updateUnreadCount(tenantId, userId, dialogId, delta, sourceOperation, sourceEventId, sourceEntityId, actorId, actorType)`
       - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:** `findOneAndUpdate` —Å `$inc` –≤–º–µ—Å—Ç–æ —á—Ç–µ–Ω–∏—è-–∏–∑–º–µ–Ω–µ–Ω–∏—è-–∑–∞–ø–∏—Å–∏
       - **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions:** –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞
     - `updateReactionCount(tenantId, messageId, reaction, delta, sourceOperation, sourceEventId, actorId, actorType)`
       - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:** `findOneAndUpdate` —Å `$inc`
     - `updateStatusCount(tenantId, messageId, status, delta, sourceOperation, sourceEventId, actorId, actorType)`
       - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:** `findOneAndUpdate` —Å `$inc`
   - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤:
     - `getMessageReactionCounts()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∞–∫—Ü–∏–π —Å–æ–æ–±—â–µ–Ω–∏—è
     - `getMessageStatusCounts()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤:
     - `updateUserStatsFromUnreadCount(tenantId, userId, oldUnreadCount, newUnreadCount, sourceEventId, sourceEventType)`
     - `updateUserStatsDialogCount(tenantId, userId, delta, sourceOperation, sourceEventId, actorId, actorType)`
       - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:** `findOneAndUpdate` —Å `$inc` –¥–ª—è `dialogCount`
     - `updateUserStatsTotalMessagesCount(tenantId, userId, delta, sourceOperation, sourceEventId, sourceEntityId, actorId, actorType)`
       - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:** `findOneAndUpdate` —Å `$inc` –¥–ª—è `totalMessagesCount`
     - `recalculateUserStats()` (–¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –æ–ø–µ—Ä–∞—Ü–∏–π (–±–∞—Ç—á–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π):
     - `getCounterUpdateContext(tenantId, userId, sourceEventId, sourceEventType)` - –ø–æ–ª—É—á–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
       - **TTL –º–µ—Ö–∞–Ω–∏–∑–º:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç
       - **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:** –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
     - `finalizeCounterUpdateContext(tenantId, userId, sourceEventId)` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–æ–∑–¥–∞—Ç—å user.stats.update
       - **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:** —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
     - `CounterUpdateContext` - –∫–ª–∞—Å—Å –¥–ª—è —Å–±–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
     - **TTL –º–µ—Ö–∞–Ω–∏–∑–º:** –¥–æ–±–∞–≤–∏—Ç—å `contextTimestamps` Map –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É
   - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π:
     - `saveCounterHistory()`
     - `getCounterHistory()`

2. **–°–æ–∑–¥–∞—Ç—å `src/apps/tenant-api/utils/counterMiddleware.js`**
   - Middleware –¥–ª—è –º–æ–¥–µ–ª–µ–π:
     - Pre-save hooks –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
     - Post-save hooks –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
     - Post-remove hooks –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏

### –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è middleware –≤ –º–æ–¥–µ–ª–∏

1. **–û–±–Ω–æ–≤–∏—Ç—å `UserDialogStats`**
   - –î–æ–±–∞–≤–∏—Ç—å pre-save hook –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ `unreadCount`
   - –î–æ–±–∞–≤–∏—Ç—å post-save hook –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `UserStats` –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏

2. **–û–±–Ω–æ–≤–∏—Ç—å `MessageReactionStats`**
   - –î–æ–±–∞–≤–∏—Ç—å pre-save hook –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è `count`
   - –î–æ–±–∞–≤–∏—Ç—å post-save hook –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

3. **–û–±–Ω–æ–≤–∏—Ç—å `MessageStatusStats`**
   - –î–æ–±–∞–≤–∏—Ç—å pre-save hook –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è `count`
   - –î–æ–±–∞–≤–∏—Ç—å post-save hook –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

4. **–û–±–Ω–æ–≤–∏—Ç—å `Message`**
   - –î–æ–±–∞–≤–∏—Ç—å post-save hook –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:
     - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `UserDialogStats.unreadCount` –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
     - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `UserStats.totalMessagesCount` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
   - Hook –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UserDialogStats` –≤–º–µ—Å—Ç–æ `DialogMember.unreadCount`

5. **–û–±–Ω–æ–≤–∏—Ç—å `MessageStatus`**
   - –î–æ–±–∞–≤–∏—Ç—å post-save hook –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `MessageStatusStats.statusCount` –∏ `UserDialogStats.unreadCount`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `MessageStatusStats` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤

6. **–û–±–Ω–æ–≤–∏—Ç—å `MessageReaction`**
   - –î–æ–±–∞–≤–∏—Ç—å post-save hook –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `MessageReactionStats.reactionCount`
   - –î–æ–±–∞–≤–∏—Ç—å post-remove hook –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `MessageReactionStats.reactionCount` –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `MessageReactionStats` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Ä–µ–∞–∫—Ü–∏–π

7. **–û–±–Ω–æ–≤–∏—Ç—å `DialogMember`**
   - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `unreadCount` –∏–∑ —Å—Ö–µ–º—ã
   - –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `DialogMember.unreadCount`, –Ω–∞ `UserDialogStats`

### –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤

1. **–û–±–Ω–æ–≤–∏—Ç—å `messageController.js`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `updateUnreadCount()` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –£–±—Ä–∞—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `incrementUnreadCount()`
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å try-finally –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `eventUtils.createEvent()` –≤–º–µ—Å—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

2. **–û–±–Ω–æ–≤–∏—Ç—å `messageStatusController.js`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `updateStatusCount()` –∏ `updateUnreadCount()`
   - –£–±—Ä–∞—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `updateCountersOnStatusChange()`
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å try-finally –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

3. **–û–±–Ω–æ–≤–∏—Ç—å `messageReactionController.js`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `updateReactionCount()`
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å try-finally –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

4. **–û–±–Ω–æ–≤–∏—Ç—å `dialogMemberController.js`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `updateUserStatsDialogCount()` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å try-finally –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `eventUtils.createEvent()` –≤–º–µ—Å—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

5. **–û–±–Ω–æ–≤–∏—Ç—å `eventUtils.js`**
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò–∑–º–µ–Ω–∏—Ç—å `createEvent()` —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å `_id`
   - –≠—Ç–æ —É–±–µ—Ä–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è eventId

### –≠—Ç–∞–ø 5: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

1. **–°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ `src/scripts/migrate-counters.js`**
   - –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `unreadCount` –∏–∑ `dialogmembers` –≤ `userdialogstats`
   - –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ —Å –Ω—É–ª—è
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ `userstats` –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–∫–ª—é—á–∞—è `totalMessagesCount` –∏–∑ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ `messages`)
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ `userdialogstats` –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–æ–≤
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ `messagereactionstats` –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∞–∫—Ü–∏–π (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑ `messagereactions`)
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ `messagestatusstats` –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑ `messagestatuses`)
   - –°–æ–∑–¥–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ `counterhistory` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `unreadCount` –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `dialogmembers` (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)

2. **–°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ `src/scripts/validate-counters.js`**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π –ø–µ—Ä–≤–∏—á–Ω—ã—Ö
   - –í—ã–≤–µ—Å—Ç–∏ –æ—Ç—á–µ—Ç –æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è—Ö

### –≠—Ç–∞–ø 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ update-worker

1. **–û–±–Ω–æ–≤–∏—Ç—å `src/utils/updateUtils.js`**
   - –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `createUserStatsUpdate()`:
     - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å `UserStats` –Ω–∞–ø—Ä—è–º—É—é –≤–º–µ—Å—Ç–æ `getUserStats()` (–∞–≥—Ä–µ–≥–∞—Ü–∏–∏)
     - –ü–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î: `await UserStats.findOne({ tenantId, userId })`
     - –í–∫–ª—é—á–∏—Ç—å –ø–æ–ª–µ `totalMessagesCount` –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   - –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã: –¥–æ–±–∞–≤–∏—Ç—å `UserStats` –∏–∑ `models/stats/`

2. **–û–±–Ω–æ–≤–∏—Ç—å `src/apps/update-worker/index.js`**
   - –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è `dialog.member.update`:
     - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UserDialogStats` –≤–º–µ—Å—Ç–æ `DialogMember` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `unreadCount`
     - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ `UserDialogStats.unreadCount` –≤–º–µ—Å—Ç–æ `DialogMember.unreadCount`
   - –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è `message.create`:
     - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UserDialogStats` –≤–º–µ—Å—Ç–æ `DialogMember` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `unreadCount`
     - –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ `user.stats.update` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `totalMessagesCount`)
   - –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã: –¥–æ–±–∞–≤–∏—Ç—å `UserDialogStats` –∏ `UserStats` –∏–∑ `models/stats/`

3. **–û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (`CounterUpdateContext`) –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
   - –°–æ–∑–¥–∞–≤–∞—Ç—å –æ–¥–∏–Ω `user.stats.update` –≤ –∫–æ–Ω—Ü–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ –≤—Å–µ–º–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ —á–µ—Ä–µ–∑ `finalizeCounterUpdateContext()`
   - –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö updates –ø—Ä–∏ –æ–¥–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ `message.create` –∏–∑–º–µ–Ω—è—é—Ç—Å—è `unreadDialogsCount`, `totalUnreadCount` –∏ `totalMessagesCount`)

### –≠—Ç–∞–ø 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API

1. **–û–±–Ω–æ–≤–∏—Ç—å `userDialogController.js`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UserStats` –≤–º–µ—Å—Ç–æ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ `DialogMember`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UserDialogStats` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `unreadCount` –≤–º–µ—Å—Ç–æ `DialogMember.unreadCount`
   - –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤

2. **–û–±–Ω–æ–≤–∏—Ç—å `messageController.js`**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `getMessageReactionCounts()` –∏ `getMessageStatusCounts()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏–∑ `MessageReactionStats` –∏ `MessageStatusStats`

3. **–û–±–Ω–æ–≤–∏—Ç—å `userController.js`**
   - –î–æ–±–∞–≤–∏—Ç—å endpoint `GET /api/users/:userId/stats` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - –î–æ–±–∞–≤–∏—Ç—å endpoint `GET /api/users/:userId/counters/history` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏

4. **–û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏**
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Ö–µ–º—ã –¥–ª—è `UserStats`
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Ö–µ–º—ã –¥–ª—è `UserDialogStats`
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Ö–µ–º—ã –¥–ª—è `MessageReactionStats`
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Ö–µ–º—ã –¥–ª—è `MessageStatusStats`
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Ö–µ–º—ã –¥–ª—è `CounterHistory`

### –≠—Ç–∞–ø 8: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

1. **–û–±–Ω–æ–≤–∏—Ç—å `docs/API.md`**
   - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö endpoints –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤ —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏

2. **–û–±–Ω–æ–≤–∏—Ç—å `docs/ARCHITECTURE.md`**
   - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

3. **–°–æ–∑–¥–∞—Ç—å `docs/COUNTERS.md`**
   - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—á–µ—Ç—á–∏–∫–∞–º–∏

### –≠—Ç–∞–ø 9: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**
   - –û–±–µ—Ä–Ω—É—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è `message.create`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è `dialog.member.add/remove`
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –æ—Ç–∫–∞—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Å–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `bulkWrite()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –ë–∞—Ç—á–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–∏–∞–ª–æ–≥–∞
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

3. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏**
   - –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º

4. **–î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º**
   - Retry –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
   - Exponential backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - Dead Letter Queue –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –≠—Ç–∞–ø 10: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–°–æ–∑–¥–∞—Ç—å unit-—Ç–µ—Å—Ç—ã**
   - –¢–µ—Å—Ç—ã –¥–ª—è `counterUtils.js`
   - –¢–µ—Å—Ç—ã –¥–ª—è middleware –º–æ–¥–µ–ª–µ–π
   - –¢–µ—Å—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –¢–µ—Å—Ç—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
   - –¢–µ—Å—Ç—ã –¥–ª—è TTL –º–µ—Ö–∞–Ω–∏–∑–º–∞

2. **–°–æ–∑–¥–∞—Ç—å integration-—Ç–µ—Å—Ç—ã**
   - –¢–µ—Å—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
   - –¢–µ—Å—Ç—ã –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –¢–µ—Å—Ç—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –¢–µ—Å—Ç—ã –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
   - –¢–µ—Å—Ç—ã –¥–ª—è race conditions

3. **–°–æ–∑–¥–∞—Ç—å performance-—Ç–µ—Å—Ç—ã**
   - –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
   - –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ bulk operations
   - –¢–µ—Å—Ç—ã –Ω–∞–≥—Ä—É–∑–∫–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –∏ worker'–∞—Ö
2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –≤—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
3. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ –ë–î
4. **–ò—Å—Ç–æ—Ä–∏—è** - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å—á–µ—Ç—á–∏–∫–∞–º –±–µ–∑ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
6. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —Å—á–µ—Ç—á–∏–∫–æ–≤

## –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ MongoDB
3. **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –≤–æ–∑–º–æ–∂–Ω—ã race conditions –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö
4. **–†–∞–∑–º–µ—Ä –ë–î** - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞
5. **–£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏** - –≥–ª–æ–±–∞–ª—å–Ω—ã–π Map –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
6. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω—ã
7. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –ø–æ–ª—É—á–µ–Ω–∏–µ eventId —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
8. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å hooks** - post-save hooks –º–æ–≥—É—Ç –∑–∞–º–µ–¥–ª—è—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

**–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑:** –°–º. [COUNTERS_ARCHITECTURE_REVIEW.md](COUNTERS_ARCHITECTURE_REVIEW.md) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π.

## –†–µ—à–µ–Ω–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bulk operations –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (`$inc`) –≤–º–µ—Å—Ç–æ —á—Ç–µ–Ω–∏—è-–∏–∑–º–µ–Ω–µ–Ω–∏—è-–∑–∞–ø–∏—Å–∏

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å optimistic locking —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MongoDB transactions –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - Retry –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö
   - –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions

3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º –ë–î**
   - TTL –∏–Ω–¥–µ–∫—Å –¥–ª—è `counterhistory` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 90 –¥–Ω–µ–π)
   - –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
   - –£—Å–ª–æ–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)

4. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏**
   - TTL –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤)
   - Try-finally –±–ª–æ–∫–∏ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

5. **–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏**
   - MongoDB transactions –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - Compensating transactions –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π

6. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤**
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å eventId –∏–∑ eventUtils –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è
   - –ò–∑–±–µ–≥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è eventId
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã

### –í–∞—Ä–∏–∞–Ω—Ç A: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- –ü–µ—Ä–≤–∏—á–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
- –ö–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é

### –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π
- –í—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
- Counter Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ eventual consistency

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–∞—á–∞—Ç—å —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞** - –ø—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ –æ—Ç–ª–∞–¥–∏—Ç—å
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –µ—Å–ª–∏ —Å—Ç–∞–Ω–µ—Ç —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º, –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–∏–±—Ä–∏–¥–Ω—ã–π
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
4. **–†–µ–≥—É–ª—è—Ä–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å** - –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
5. **–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ `counterhistory`

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è

1. –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è?
2. –ö–∞–∫ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏–ª–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π?
3. –ù—É–∂–Ω—ã –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `totalMessagesCount`, `totalReactionsGiven`)?
4. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ - retry –∏–ª–∏ –æ—Ç–∫–∞—Ç?
5. –ù—É–∂–Ω–∞ –ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ —á–µ—Ä–µ–∑ API?

## –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:** [COUNTERS_ARCHITECTURE_REVIEW.md](COUNTERS_ARCHITECTURE_REVIEW.md)

### –ö–ª—é—á–µ–≤—ã–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏** - –≥–ª–æ–±–∞–ª—å–Ω—ã–π Map –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω—ã
3. **Race conditions** - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å
4. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –ø–æ–ª—É—á–µ–Ω–∏–µ eventId —Ç—Ä–µ–±—É–µ—Ç –ª–∏—à–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–º–µ–¥–ª—è—é—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É):

1. **TTL –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
2. **Try-finally –±–ª–æ–∫–∏** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
3. **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `$inc` –≤–º–µ—Å—Ç–æ —á—Ç–µ–Ω–∏—è-–∏–∑–º–µ–Ω–µ–Ω–∏—è-–∑–∞–ø–∏—Å–∏
4. **–í–æ–∑–≤—Ä–∞—Ç eventId –∏–∑ eventUtils** - —É–±—Ä–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å

### –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):

5. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** - –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
6. **Bulk operations** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—Å–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
7. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
8. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - retry –º–µ—Ö–∞–Ω–∏–∑–º

