syntax = "proto3";

package chat3.user;

import "google/protobuf/struct.proto";

// –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
service Chat3UserService {
  // –ü–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  rpc GetUserDialogs(GetUserDialogsRequest) returns (GetUserDialogsResponse);
  
  // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
  rpc GetDialogMessages(GetDialogMessagesRequest) returns (GetDialogMessagesResponse);
  
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  rpc SendMessage(SendMessageRequest) returns (SendMessageResponse);
  
  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (server streaming)
  // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - Update —Å eventType="connection.established" –∏ connId –≤ data
  rpc SubscribeUpdates(SubscribeUpdatesRequest) returns (stream Update);
  
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  rpc SetMessageStatus(SetMessageStatusRequest) returns (SetMessageStatusResponse);
  
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–ª–∏ —Å–Ω—è—Ç–∏–µ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
  rpc SetMessageReaction(SetMessageReactionRequest) returns (SetMessageReactionResponse);
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
  rpc SendTypingIndicator(SendTypingIndicatorRequest) returns (SendTypingIndicatorResponse);
}

// –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
message GetUserDialogsRequest {
  int32 page = 1;
  int32 limit = 2;
  string filter = 3;
  string sort = 4;
  bool include_last_message = 5;
}

// –û—Ç–≤–µ—Ç —Å –¥–∏–∞–ª–æ–≥–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
message GetUserDialogsResponse {
  repeated Dialog dialogs = 1;
  Pagination pagination = 2;
}

// –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∏–∞–ª–æ–≥–∞
message GetDialogMessagesRequest {
  string dialog_id = 1;
  int32 page = 2;
  int32 limit = 3;
  string filter = 4;
  string sort = 5;
}

// –û—Ç–≤–µ—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–∞
message GetDialogMessagesResponse {
  repeated Message messages = 1;
  Pagination pagination = 2;
}

// –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
message SendMessageRequest {
  string dialog_id = 1;
  string sender_id = 2;
  string content = 3;
  string type = 4;
  google.protobuf.Struct meta = 5;
  string idempotency_key = 6;
}

// –û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è
message SendMessageResponse {
  Message message = 1;
}

// –ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
message SubscribeUpdatesRequest {
  // –ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å, userId –∏ tenantId –±–µ—Ä—É—Ç—Å—è –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
  // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ stream - Update —Å eventType="connection.established" –∏ connId –≤ data
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (update)
message Update {
  string update_id = 1;
  string tenant_id = 2;
  string user_id = 3;
  string entity_id = 4;
  string event_type = 5;
  google.protobuf.Struct data = 6;
  double created_at = 7;
}

// –î–∏–∞–ª–æ–≥
message Dialog {
  string dialog_id = 1;
  string tenant_id = 2;
  string name = 3;
  string created_by = 4;
  double created_at = 5;
  double updated_at = 6;
  google.protobuf.Struct meta = 7;
  DialogMember member = 8;
  Message last_message = 9;
}

// –£—á–∞—Å—Ç–Ω–∏–∫ –¥–∏–∞–ª–æ–≥–∞
message DialogMember {
  string user_id = 1;
  google.protobuf.Struct meta = 2;
  MemberState state = 3;
}

// –°–æ—Å—Ç–æ—è–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
message MemberState {
  int32 unread_count = 1;
  double last_seen_at = 2;
  double last_message_at = 3;
  bool is_active = 4;
}

// –°–æ–æ–±—â–µ–Ω–∏–µ
message Message {
  string message_id = 1;
  string dialog_id = 2;
  string sender_id = 3;
  string type = 4;
  string content = 5;
  google.protobuf.Struct meta = 6;
  repeated MessageStatus statuses = 7;
  google.protobuf.Struct reaction_set = 8;
  SenderInfo sender_info = 9;
  double created_at = 10;
  string topic_id = 11;
  google.protobuf.Struct topic = 12;
}

// –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è
message MessageStatus {
  string user_id = 1;
  string status = 2;
  double read_at = 3;
  double created_at = 4;
}

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
message SenderInfo {
  string user_id = 1;
  string name = 2;
  double created_at = 3;
  google.protobuf.Struct meta = 4;
}

// –ü–∞–≥–∏–Ω–∞—Ü–∏—è
message Pagination {
  int32 page = 1;
  int32 limit = 2;
  int32 total = 3;
  int32 pages = 4;
}

// –ó–∞–ø—Ä–æ—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
message SetMessageStatusRequest {
  string dialog_id = 1;
  string message_id = 2;
  string status = 3; // unread, delivered, read
}

// –û—Ç–≤–µ—Ç –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
message SetMessageStatusResponse {
  MessageStatus status = 1;
  Message message = 2; // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
}

// –ó–∞–ø—Ä–æ—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏/—Å–Ω—è—Ç–∏—è —Ä–µ–∞–∫—Ü–∏–∏
message SetMessageReactionRequest {
  string dialog_id = 1;
  string message_id = 2;
  string reaction = 3; // –≠–º–æ–¥–∑–∏ –∏–ª–∏ —Ç–µ–∫—Å—Ç —Ä–µ–∞–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "üëç", "‚ù§Ô∏è")
  bool set = 4; // true –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏, false –¥–ª—è —Å–Ω—è—Ç–∏—è
}

// –û—Ç–≤–µ—Ç –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É/—Å–Ω—è—Ç–∏–µ —Ä–µ–∞–∫—Ü–∏–∏
message SetMessageReactionResponse {
  string message = 1; // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
  google.protobuf.Struct reaction_set = 2; // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —Ä–µ–∞–∫—Ü–∏–π
}

// –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
message SendTypingIndicatorRequest {
  string dialog_id = 1;
}

// –û—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
message SendTypingIndicatorResponse {
  string message = 1;
  string dialog_id = 2;
  int32 expires_in_ms = 3; // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
}
