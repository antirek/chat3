# План: табы Сообщения / Участники / Топики на странице dialogs-messages

## Цель

На странице [Диалоги и сообщения](https://tubo-mms3-control-app.services.mobilon.ru/dialogs-messages) изменить правую колонку:

- **Сейчас:** одна панель «Сообщения» (список сообщений выбранного диалога).
- **Нужно:** две колонки — слева «Диалоги», справа одна панель с **тремя табами**: «Сообщения», «Участники», «Топики». В каждом табе — соответствующие данные выбранного диалога.

---

## Анализ текущего кода

### Маршрут и страница

- **Маршрут:** `/dialogs-messages`, компонент `DialogsMessagesPage.vue`.
- **Структура:** два `BasePanel` 50% / 50%: левая — «Диалоги» (фильтр, пагинация, таблица), правая — «Сообщения» (фильтр, пагинация, таблица).
- **Контекст API:** без `userId` — используются эндпоинты уровня тенанта:
  - `GET /api/dialogs` — список диалогов (useDialogs);
  - `GET /api/dialogs/:dialogId/messages` — сообщения (useMessages в dialogs-messages).

### API для правой колонки

Уже есть эндпоинты без `userId`:

| Данные      | Эндпоинт                           | Контроллер                          |
|-------------|------------------------------------|-------------------------------------|
| Сообщения   | `GET /api/dialogs/:dialogId/messages` | messageController.getDialogMessages |
| Участники   | `GET /api/dialogs/:dialogId/members`   | dialogMemberController.getDialogMembers |
| Топики      | `GET /api/dialogs/:dialogId/topics`   | topicController.getDialogTopics      |

Формат ответа везде: `{ data: [], pagination: { page, limit, total, pages } }`.

### Модель (dialogs-messages)

- **model/index.ts** — собирает useDialogs, useMessages, модалки, утилиты; при выборе диалога вызывается `selectDialog(dialogId)` → обновляется `currentDialogId`, перезагружаются сообщения.
- **useMessages** — держит `currentDialogId`, загружает сообщения по `GET /api/dialogs/:dialogId/messages`, пагинация и фильтр/сортировка.
- **useDialogs** — список диалогов, фильтр, сортировка, пагинация.
- Отдельных useMembers и useTopics для dialogs-messages **нет** — их нужно добавить (вызовы `/api/dialogs/:dialogId/members` и `/api/dialogs/:dialogId/topics`).

### UI (dialogs-messages)

- **Таблицы:** только `DialogTable` и `MessagesTableSimple`.
- **Правая панель:** один блок «Сообщения» (фильтр, пагинация, MessagesTableSimple), без табов.

### Сравнение с user-dialogs

На странице **user-dialogs** уже реализована схема «три таба» в правой колонке:

- Три таба: Сообщения | Участники | Топики.
- Режим хранится в `currentViewMode` ('messages' | 'members' | 'topics').
- Есть useMembers, useTopics (но они ходят в `/api/users/:userId/dialogs/:dialogId/...`).
- Используются таблицы: MessagesTable, MembersTable, TopicsTable (и много модалок: мета, добавление участника/топика, смена топика сообщения и т.д.).

Для **dialogs-messages** достаточно упрощённого варианта: те же три таба и таблицы по смыслу, но без привязки к пользователю и без части модалок (или с минимальным набором).

---

## План реализации

### 1. Модель (model/)

1. **useMembers (dialogs-messages)**  
   - Новый composable (по аналогии с useMessages в dialogs-messages).  
   - Хранит: `members`, `loadingMembers`, `membersError`, пагинация.  
   - Загрузка: `GET /api/dialogs/:dialogId/members?page=&limit=` (и при необходимости `filter`, `sort` — API поддерживает).  
   - Вызывать загрузку **только при открытии таба «Участники»** (ленивая загрузка). При смене диалога сбрасывать список (при следующем открытии таба загрузятся данные для нового диалога).

2. **useTopics (dialogs-messages)**  
   - Новый composable.  
   - Хранит: `topics`, `loadingTopics`, `topicsError`, пагинация.  
   - Загрузка: `GET /api/dialogs/:dialogId/topics?page=&limit=`.  
   - Вызывать загрузку **только при открытии таба «Топики»**. При смене диалога сбрасывать список.

3. **Согласование в model/index.ts**  
   - Ввести состояние «текущий таб» правой панели: `currentViewMode: 'messages' | 'members' | 'topics'`.  
   - В `selectDialog(dialogId)`: обновлять `currentDialogId`, загружать только сообщения (как сейчас). Участников и топиков **не** подгружать при выборе диалога.  
   - **Ленивая загрузка:** при первом открытии таба «Участники» вызывать загрузку members для `currentDialogId`; при первом открытии таба «Топики» — загрузку topics. При смене диалога сбрасывать списки members/topics (или оставлять до следующего открытия таба — тогда при открытии таба проверять, что загружены данные именно для текущего `currentDialogId`, и при несовпадении перезагружать).

4. **Экспорт**  
   - Пробросить из index: `currentViewMode`, переключение таба (например `selectMessagesTab`, `selectMembersTab`, `selectTopicsTab` или один `setViewMode`), данные и пагинация members/topics, функции загрузки.

### 2. UI — правая панель с табами

1. **Структура правой колонки**  
   - Один `BasePanel` (правая половина).  
   - Внутри:
     - Блок табов (аналогично user-dialogs): три кнопки «Сообщения», «Участники», «Топики»; активный таб по `currentViewMode`.
     - Опционально строка кнопок под табами (например «Добавить», «URL») в зависимости от таба — можно начать без них или с минимумом.
     - Контент по табам:
       - **Сообщения:** текущий блок (фильтр сообщений, пагинация, `MessagesTableSimple`).
       - **Участники:** пагинация + таблица участников (только просмотр).
       - **Топики:** пагинация + таблица топиков (только просмотр, без кнопки «Сообщения» у топика).

2. **Таблицы участников и топиков**  
   - Отдельные простые таблицы в `dialogs-messages/ui/tables/` (MembersTableSimple, TopicsTableSimple): **только просмотр**, без кнопок «Мета», «Удалить», «Сообщения» и т.д. Общий код с user-dialogs пока не выносить — позже зарефакторить.

3. **Стили табов**  
   - Повторить стили из user-dialogs (`.tabs-container`, `.tab-button`, `.tab-button.active`) в scoped-стилях DialogsMessagesPage.vue или вынести в общий компонент/стиль позже.

### 3. Детали по данным

- **Участники:** ответ `GET /api/dialogs/:dialogId/members` — массив с полями вроде `userId`, `unreadCount`, `isActive`, `meta` и т.д. (как в user-dialogs MembersTable). Пагинация в API есть — использовать в useMembers.
- **Топики:** ответ `GET /api/dialogs/:dialogId/topics` — массив с `topicId`, `meta`. В tenant API у топиков нет `unreadCount` (в user-dialogs unread приходит из контекста пользователя). В таблице топиков на dialogs-messages можно показывать колонку «Unread» как «—» или «0», либо не показывать.

### 4. Порядок работ (кратко)

1. Добавить `useMembers` и `useTopics` в `dialogs-messages/model/`, подключить в `model/index.ts`, ввести `currentViewMode` и переключение табов.  
2. В `DialogsMessagesPage.vue`: правая панель переделать в табы; под первым табом оставить текущий блок «Сообщения»; под вторым и третьим — новые таблицы + пагинация.  
3. Добавить таблицы участников и топиков для dialogs-messages (простые варианты без лишних действий).  
4. Проверить сценарии: выбор диалога → переключение табов → загрузка участников/топиков, пагинация, пустой диалог.

---

## Решения (зафиксировано)

1. **Загрузка данных:** только при открытии таба. При выборе диалога подгружаются только сообщения; участников и топиков загружать лениво — при первом открытии соответствующего таба.

2. **Действия в табах «Участники» и «Топики»:** пока только просмотр. Таблицы без кнопок «Мета», «Удалить», «Добавить» и т.д.

3. **Кнопка «Сообщения» у топика:** не делать. В табе «Топики» на dialogs-messages кнопки перехода на таб «Сообщения» с фильтром по topicId не будет.

4. **Общий код с user-dialogs:** пока отдельные таблицы в dialogs-messages; позже зарефакторить и вынести в shared при необходимости.

5. **Пагинация:** да. В табах «Участники» и «Топики» показывать пагинацию с первого релиза (API поддерживает).
