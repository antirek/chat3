# @chat3/user-grpc-server

gRPC —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Chat3

## –û–ø–∏—Å–∞–Ω–∏–µ

gRPC —Å–µ—Ä–≤–µ—Ä, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏–∞–ª–æ–≥–∞–º–∏, —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ streaming.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
npm install
npm run build
```

## –ó–∞–ø—É—Å–∫

```bash
npm start
```

–ò–ª–∏ —á–µ—Ä–µ–∑ –∫–æ—Ä–Ω–µ–≤–æ–π package.json:

```bash
npm run start:user-grpc-server
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

- `GRPC_HOST` - —Ö–æ—Å—Ç gRPC —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.0.0.0`)
- `GRPC_PORT` - –ø–æ—Ä—Ç gRPC —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `50051`)
- `TENANT_API_URL` - URL tenant-api (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä `http://localhost:3000`)
- `RABBITMQ_URL` - URL RabbitMQ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä `amqp://localhost:5672`)

## gRPC Server Reflection

–°–µ—Ä–≤–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **gRPC Server Reflection**, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–µ—Ç–æ–¥—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ `.proto` —Ñ–∞–π–ª–æ–≤.

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è API:

1. **Kreya** (GUI –∫–ª–∏–µ–Ω—Ç)
   - –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ `localhost:50051`
   - –í–∫–ª—é—á–∏—Ç–µ "Use Server Reflection"
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã

2. **grpcurl** (CLI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
   ```bash
   # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
   grpcurl -plaintext localhost:50051 list
   
   # –û–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
   grpcurl -plaintext localhost:50051 describe chat3.user.Chat3UserService
   
   # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞
   grpcurl -plaintext -H "x-api-key: YOUR_KEY" -H "x-tenant-id: tnt_default" -H "x-user-id: user_1" \
     -d '{"page": 1, "limit": 10}' \
     localhost:50051 chat3.user.Chat3UserService/GetUserDialogs
   ```

3. **Postman**
   - –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π gRPC –∑–∞–ø—Ä–æ—Å
   - –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å: `localhost:50051`
   - –í–∫–ª—é—á–∏—Ç–µ "Server Reflection"
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç –º–µ—Ç–æ–¥—ã –∏ —Ç–∏–ø—ã

4. **grpcui** (–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
   ```bash
   # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç grpcui, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
   ./start-grpcui.sh
   
   # –ò–ª–∏ –≤—Ä—É—á–Ω—É—é (—Ç—Ä–µ–±—É–µ—Ç Go)
   go install github.com/fullstorydev/grpcui/cmd/grpcui@latest
   grpcui -plaintext localhost:50051
   ```
   –û—Ç–∫—Ä–æ–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ http://localhost:8080).

## –ú–µ—Ç–æ–¥—ã API

### GetUserDialogs
–ü–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
- `x-api-key` - API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-tenant-id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-user-id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `page` - –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
- `limit` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)
- `filter` - —Ñ–∏–ª—å—Ç—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- `sort` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
- `include_last_message` - –≤–∫–ª—é—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### GetDialogMessages
–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
- `x-api-key` - API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-tenant-id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-user-id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `dialog_id` - ID –¥–∏–∞–ª–æ–≥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `page` - –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
- `limit` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)
- `filter` - —Ñ–∏–ª—å—Ç—Ä
- `sort` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞

### SendMessage
–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
- `x-api-key` - API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-tenant-id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `dialog_id` - ID –¥–∏–∞–ª–æ–≥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `sender_id` - ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `content` - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `type` - —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `internal.text`)
- `meta` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (Struct)
- `idempotency_key` - –∫–ª—é—á –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### SubscribeUpdates
–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (server streaming)

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
- `x-api-key` - API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-tenant-id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-user-id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** stream Update

–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - Update —Å `eventType="connection.established"` –∏ `connId` –≤ `data`.

### SetMessageStatus
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
- `x-api-key` - API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-tenant-id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-user-id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `dialog_id` - ID –¥–∏–∞–ª–æ–≥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `message_id` - ID —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `status` - —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è: `unread`, `delivered` –∏–ª–∏ `read` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ

### SetMessageReaction
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–Ω—è—Ç—å —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
- `x-api-key` - API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-tenant-id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-user-id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `dialog_id` - ID –¥–∏–∞–ª–æ–≥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `message_id` - ID —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `reaction` - —Ä–µ–∞–∫—Ü–∏—è (—ç–º–æ–¥–∑–∏ –∏–ª–∏ —Ç–µ–∫—Å—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, "üëç", "‚ù§Ô∏è") (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `set` - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (true) –∏–ª–∏ —Å–Ω—è—Ç—å (false) —Ä–µ–∞–∫—Ü–∏—é. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: true

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —Ä–µ–∞–∫—Ü–∏–π

### SendTypingIndicator
–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ –≤ –¥–∏–∞–ª–æ–≥

**–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:**
- `x-api-key` - API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-tenant-id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `x-user-id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `dialog_id` - ID –¥–∏–∞–ª–æ–≥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—É—á–∞—Ç update —á–µ—Ä–µ–∑ `SubscribeUpdates` stream —Å `eventType="dialog.typing"`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
packages/user-grpc-server/
# Proto —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ @chat3/user-grpc-proto (packages-shared/proto/)
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ handlers/               # gRPC handlers
‚îÇ   ‚îú‚îÄ‚îÄ services/               # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç @chottodev/chat3-tenant-api-client (Chat3Client)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rabbitmqClient.ts   # RabbitMQ –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ utils/                  # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json
```

## RabbitMQ

–°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ RabbitMQ –∏ —Å–æ–∑–¥–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
- –§–æ—Ä–º–∞—Ç –æ—á–µ—Ä–µ–¥–∏: `user_{userId}_conn_{connId}_updates`
- TTL –æ—á–µ—Ä–µ–¥–∏: 1 —á–∞—Å
- Routing key: `update.*.{userType}.{userId}.*`
- Exchange: `chat3_updates`

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `console.log` —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
